<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Paint Splash - Color Puzzle Art Game | GameZipper</title>
<meta name="description" content="Swipe and match colorful paint blocks to create stunning abstract art! A satisfying color splash puzzle game with 15+ levels. Play free online!">
<meta name="keywords" content="paint puzzle, color splash, art game, color matching game, paint splash game, puzzle game, free online game">
<meta property="og:title" content="Paint Splash - Color Puzzle Art Game">
<meta property="og:description" content="Swipe color blocks, make paint splash, create art! Free browser puzzle game.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://gamezipper.com/paint-splash/">
<link rel="canonical" href="https://gamezipper.com/paint-splash/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
<script src="../game-audio.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI','Helvetica Neue',Arial,sans-serif;touch-action:none;user-select:none;-webkit-user-select:none}
body{background:#1a1a2e;display:flex;flex-direction:column;align-items:center}
#top-bar{position:fixed;top:0;left:0;right:0;background:rgba(20,20,40,0.95);color:#fff;padding:6px 12px;font-size:13px;z-index:99999;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.1)}
#top-bar a{color:#7eb8ff;text-decoration:none;font-weight:600;font-size:12px}
#info-strip{display:flex;align-items:center;gap:16px;font-weight:700;font-size:15px}
#info-strip .info-item{display:flex;align-items:center;gap:4px}
#info-strip .info-label{color:rgba(255,255,255,0.5);font-size:11px;font-weight:600;text-transform:uppercase}
#info-strip .info-val{color:#fff;font-size:16px;font-weight:800}
#wrap{width:100%;height:100%;max-width:500px;display:flex;flex-direction:column;padding:44px 0 0 0}
#game-area{flex:1;position:relative;overflow:hidden}
canvas#gameCanvas{width:100%;height:100%;display:block}
#progress-bar{position:fixed;bottom:48px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:468px;height:14px;background:rgba(255,255,255,0.1);border-radius:7px;overflow:hidden;z-index:999;border:1px solid rgba(255,255,255,0.15)}
#progress-fill{height:100%;background:linear-gradient(90deg,#FF4444,#FF8800,#FFD700,#44BB44,#4488FF,#9944FF);border-radius:7px;transition:width 0.5s ease;width:0%;position:relative}
#progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(to bottom,rgba(255,255,255,0.3),transparent);border-radius:7px 7px 0 0}
#bottom-strip{position:fixed;bottom:0;left:0;right:0;height:46px;background:rgba(20,20,40,0.95);display:flex;align-items:center;justify-content:center;gap:24px;z-index:999;backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.1)}
.bottom-btn{background:none;border:none;color:rgba(255,255,255,0.7);font-size:22px;cursor:pointer;padding:8px 16px;border-radius:8px;transition:all .15s}
.bottom-btn:active{transform:scale(.9);background:rgba(255,255,255,0.1)}
.bottom-btn span{font-size:10px;display:block;color:rgba(255,255,255,0.4);font-weight:600}
#mute-btn{position:fixed;bottom:52px;right:8px;z-index:1000;background:rgba(255,255,255,0.1);border:none;border-radius:50%;width:32px;height:32px;font-size:16px;cursor:pointer;color:#fff}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.overlay.show{display:flex}
.overlay-box{background:#1e1e3a;border-radius:20px;padding:28px;max-width:360px;width:100%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);color:#fff}
.overlay-box h2{font-size:22px;margin-bottom:10px}
.overlay-box p{font-size:14px;color:rgba(255,255,255,0.7);line-height:1.6;margin-bottom:8px}
.obtn{display:inline-block;background:linear-gradient(135deg,#4488FF,#6644FF);color:#fff;border:none;padding:10px 24px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin:4px;transition:all .15s}
.obtn:active{transform:scale(.95)}
.obtn.secondary{background:rgba(255,255,255,0.1)}
.stars-row{display:flex;justify-content:center;gap:8px;margin:12px 0}
.star{font-size:36px;opacity:0.2;transition:all 0.5s;transform:scale(0.5)}
.star.earned{opacity:1;transform:scale(1);filter:drop-shadow(0 0 8px gold)}
#level-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0;max-height:280px;overflow-y:auto}
.lvl-btn{width:100%;aspect-ratio:1;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);font-size:16px;font-weight:800;cursor:pointer;position:relative;color:#fff;transition:all .15s}
.lvl-btn.locked{opacity:0.3;cursor:default;color:rgba(255,255,255,0.3)}
.lvl-btn.current{border-color:#4488FF;background:rgba(68,136,255,0.2)}
.lvl-btn .lvl-stars{position:absolute;bottom:2px;left:0;right:0;font-size:8px;text-align:center}
#result-painting{border:6px solid rgba(255,255,255,0.15);border-radius:12px;margin:12px auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:block}
#cookie{position:fixed;bottom:48px;left:0;right:0;background:rgba(30,30,50,0.95);color:#fff;padding:10px 16px;font-size:11px;z-index:100000;display:none;align-items:center;justify-content:space-between;border-top:1px solid rgba(255,255,255,0.1)}
#cookie.show{display:flex}
#cookie button{background:#4488FF;color:#fff;border:none;padding:5px 14px;border-radius:6px;cursor:pointer;font-weight:600;font-size:11px}
</style>
</head>
<body>
<div id="top-bar">
<a href="https://gamezipper.com">‚¨Ö Games</a>
<div id="info-strip">
<div class="info-item"><span class="info-label">LV</span><span class="info-val" id="level-num">1</span></div>
<div class="info-item"><span class="info-label">Moves</span><span class="info-val" id="moves-left">30</span></div>
<div class="info-item"><span class="info-label">Paint</span><span class="info-val" id="paint-pct">0%</span></div>
</div>
<a href="https://gamezipper.com">More ‚û°</a>
</div>

<div id="wrap">
<div id="game-area"><canvas id="gameCanvas"></canvas></div>
</div>

<div id="progress-bar"><div id="progress-fill"></div></div>

<div id="bottom-strip">
<button class="bottom-btn" onclick="G.showLevels()">üìã<span>Levels</span></button>
<button class="bottom-btn" onclick="G.restart()">üîÑ<span>Restart</span></button>
<button class="bottom-btn" onclick="G.undo()">‚Ü©Ô∏è<span>Undo</span></button>
</div>

<button id="mute-btn" onclick="G.toggleMute()">üîä</button>

<div class="overlay" id="tutorial-overlay">
<div class="overlay-box">
<div style="font-size:56px;margin-bottom:8px">üé®</div>
<h2>Paint Splash!</h2>
<p>üëÜ <b>Swipe</b> to slide color blocks</p>
<p>üé® Match <b>3+ same colors</b> to splash paint</p>
<p>üñºÔ∏è Fill the canvas to win each level</p>
<p style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:6px">üí° Fewer moves = more stars</p>
<button class="obtn" id="tutorial-gotit" style="font-size:18px;padding:14px 44px;margin-top:12px">Let's Paint! üé®</button>
</div>
</div>

<div class="overlay" id="complete-overlay">
<div class="overlay-box">
<div style="font-size:44px" id="complete-emoji">üéâ</div>
<h2 id="complete-title">Level Complete!</h2>
<div class="stars-row" id="complete-stars">
<span class="star">‚≠ê</span><span class="star">‚≠ê</span><span class="star">‚≠ê</span>
</div>
<canvas id="result-painting" width="200" height="200"></canvas>
<p id="complete-msg" style="font-size:13px">Your abstract masterpiece!</p>
<p style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:4px">üì∏ Screenshot your masterpiece!</p>
<div style="display:flex;gap:8px;margin-top:14px;justify-content:center">
<button class="obtn secondary" onclick="G.showLevels()">üìã Levels</button>
<button class="obtn" onclick="G.nextLevel()">Next Level ‚û°</button>
</div>
</div>
</div>

<div class="overlay" id="gameover-overlay">
<div class="overlay-box">
<div style="font-size:44px">üòÖ</div>
<h2>Out of Moves!</h2>
<p>You painted <span id="go-pct">0</span>% but needed <span id="go-target">60</span>%</p>
<canvas id="go-painting" width="200" height="200" style="border:6px solid rgba(255,255,255,0.1);border-radius:12px;margin:12px auto;display:block"></canvas>
<div style="display:flex;gap:8px;margin-top:14px;justify-content:center">
<button class="obtn secondary" onclick="G.showLevels()">üìã Levels</button>
<button class="obtn" onclick="G.restart()">Try Again üîÑ</button>
</div>
</div>
</div>

<div class="overlay" id="levels-overlay">
<div class="overlay-box">
<h2>üé® Select Level</h2>
<div id="level-grid"></div>
<button class="obtn secondary" onclick="document.getElementById('levels-overlay').classList.remove('show')">Close</button>
</div>
</div>

<div id="cookie">
<span>üç™ Cookies save your progress.</span>
<button onclick="document.getElementById('cookie').classList.remove('show');localStorage.setItem('ps_cookie','1')">OK</button>
</div>

<script>
'use strict';
const G = (function(){
const GRID=6;
const COLORS=['#FF4444','#4488FF','#FFD700','#44BB44','#9944FF','#FF8800'];
const COLOR_LIGHT=['#FF7777','#77AAFF','#FFE555','#66DD66','#BB77FF','#FFAA44'];
const COLOR_DARK=['#CC2222','#2266CC','#CCAA00','#228822','#6622CC','#CC6600'];

// Levels
const LEVELS=[];
for(let i=0;i<20;i++){
  const numColors=Math.min(4+Math.floor(i/4),6);
  const target=Math.min(50+i*2.5,95);
  const moves=Math.max(30-i,12);
  LEVELS.push({id:i+1,colors:numColors,target:target,moves:moves,movesStar2:Math.floor(moves*0.7),movesStar3:Math.floor(moves*0.45)});
}

// State
let canvas,ctx,W,H,cellSize,gridOffsetX,gridOffsetY;
let grid=[],paintCanvas,paintCtx;
let currentLevel=0,movesLeft=0,paintPercent=0,undoStack=[];
let animating=false,particles=[],splashes=[],screenFlash=null;
let muted=false,progress={};
let swipeStartX,swipeStartY,swiping=false;

// Animation state for blocks
let blockPositions=[]; // [r][c] = {x, y, targetX, targetY, scale, opacity}
let slideAnimating=false;

function init(){
  canvas=document.getElementById('gameCanvas');
  ctx=canvas.getContext('2d');
  paintCanvas=document.createElement('canvas');
  paintCanvas.width=300;paintCanvas.height=300;
  paintCtx=paintCanvas.getContext('2d');
  
  loadProgress();
  resize();
  window.addEventListener('resize',resize);
  
  canvas.addEventListener('mousedown',onDown);
  canvas.addEventListener('mousemove',onMove);
  canvas.addEventListener('mouseup',onUp);
  canvas.addEventListener('touchstart',onTouchStart,{passive:false});
  canvas.addEventListener('touchmove',onTouchMove,{passive:false});
  canvas.addEventListener('touchend',onTouchEnd,{passive:false});
  document.addEventListener('keydown',onKey);
  
  if(!localStorage.getItem('ps_tutorial')){
    document.getElementById('tutorial-overlay').classList.add('show');
  }
  var tutBtn=document.getElementById('tutorial-gotit');
  tutBtn.addEventListener('mousedown',closeTutorial);
  tutBtn.addEventListener('touchend',function(e){e.preventDefault();closeTutorial();});
  
  if(!localStorage.getItem('ps_cookie')){
    document.getElementById('cookie').classList.add('show');
  }
  
  startLevel(progress.currentLevel||0);
  requestAnimationFrame(loop);
}

function closeTutorial(){
  document.getElementById('tutorial-overlay').classList.remove('show');
  localStorage.setItem('ps_tutorial','1');
}

function resize(){
  var dpr=window.devicePixelRatio||1;
  var container=document.getElementById('game-area');
  var w=container.clientWidth,h=container.clientHeight;
  canvas.width=w*dpr;canvas.height=h*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  W=w;H=h;
  // Grid fills ~72% of height
  var gridH=H*0.72;
  var gridW=W*0.92;
  cellSize=Math.min(gridH/GRID,gridW/GRID);
  gridOffsetX=(W-GRID*cellSize)/2;
  gridOffsetY=(H-GRID*cellSize)/2-H*0.02;
  initBlockPositions();
}

function initBlockPositions(){
  blockPositions=[];
  for(var r=0;r<GRID;r++){
    blockPositions[r]=[];
    for(var c=0;c<GRID;c++){
      var x=gridOffsetX+c*cellSize;
      var y=gridOffsetY+r*cellSize;
      blockPositions[r][c]={x:x,y:y,targetX:x,targetY:y,scale:1,opacity:1};
    }
  }
}

function startLevel(lvlIdx){
  if(lvlIdx>=LEVELS.length)lvlIdx=LEVELS.length-1;
  currentLevel=lvlIdx;
  var lvl=LEVELS[lvlIdx];
  movesLeft=lvl.moves;
  paintPercent=0;
  undoStack=[];
  particles=[];splashes=[];screenFlash=null;
  animating=false;slideAnimating=false;
  
  paintCtx.fillStyle='#fff';
  paintCtx.fillRect(0,0,300,300);
  
  grid=[];
  for(var r=0;r<GRID;r++){
    grid[r]=[];
    for(var c=0;c<GRID;c++){
      grid[r][c]=Math.floor(Math.random()*lvl.colors);
    }
  }
  // Clear initial matches WITHOUT adding paint
  clearMatchesInitial();
  initBlockPositions();
  updateUI();
}

function updateUI(){
  document.getElementById('level-num').textContent=currentLevel+1;
  document.getElementById('moves-left').textContent=movesLeft;
  document.getElementById('paint-pct').textContent=Math.floor(paintPercent)+'%';
  document.getElementById('progress-fill').style.width=Math.min(paintPercent,100)+'%';
}

// Clear matches at level start ‚Äî no paint, no effects, just remove and refill
function clearMatchesInitial(){
  var found=true;
  var safety=0;
  while(found&&safety<50){
    safety++;
    var groups=findMatches();
    if(groups.length===0){found=false;break;}
    for(var gi=0;gi<groups.length;gi++){
      var g=groups[gi];
      for(var ci=0;ci<g.cells.length;ci++){
        grid[g.cells[ci][0]][g.cells[ci][1]]=-1;
      }
    }
    // Gravity + refill
    for(var c=0;c<GRID;c++){
      var write=GRID-1;
      for(var r=GRID-1;r>=0;r--){
        if(grid[r][c]!==-1){
          grid[write][c]=grid[r][c];
          if(write!==r)grid[r][c]=-1;
          write--;
        }
      }
      var lvl=LEVELS[currentLevel];
      for(var r2=write;r2>=0;r2--){
        grid[r2][c]=Math.floor(Math.random()*lvl.colors);
      }
    }
  }
}

// Slide grid with animation
function slideGrid(dir){
  if(animating||slideAnimating||movesLeft<=0)return false;
  
  var oldGrid=grid.map(function(r){return r.slice();});
  var moved=false;
  
  // Calculate new grid
  var newGrid=grid.map(function(r){return r.slice();});
  
  if(dir==='left'||dir==='right'){
    for(var r=0;r<GRID;r++){
      var row=newGrid[r].slice();
      if(dir==='right')row.reverse();
      var nr=row.filter(function(v){return v!==-1;});
      while(nr.length<GRID)nr.push(-1);
      if(dir==='right')nr.reverse();
      for(var c=0;c<GRID;c++){
        if(nr[c]!==newGrid[r][c])moved=true;
        newGrid[r][c]=nr[c];
      }
    }
  } else {
    for(var c=0;c<GRID;c++){
      var col=[];
      for(var r=0;r<GRID;r++)col.push(newGrid[r][c]);
      if(dir==='down')col.reverse();
      var nc=col.filter(function(v){return v!==-1;});
      while(nc.length<GRID)nc.push(-1);
      if(dir==='down')nc.reverse();
      for(var r=0;r<GRID;r++){
        if(nc[r]!==newGrid[r][c])moved=true;
        newGrid[r][c]=nc[r];
      }
    }
  }
  
  if(!moved)return false;
  
  undoStack.push(oldGrid);
  if(undoStack.length>5)undoStack.shift();
  movesLeft--;
  
  GameAudio.play('swoosh');
  
  // Animate slide: compute where each old block goes in newGrid
  slideAnimating=true;
  
  // Map old positions to new
  // For simplicity, just set target positions for newGrid and animate
  grid=newGrid;
  
  // Set block targets
  for(var r=0;r<GRID;r++){
    for(var c=0;c<GRID;c++){
      var bp=blockPositions[r][c];
      bp.targetX=gridOffsetX+c*cellSize;
      bp.targetY=gridOffsetY+r*cellSize;
      // Offset start based on direction for slide feel
      if(dir==='left')bp.x=bp.targetX+cellSize*0.5;
      else if(dir==='right')bp.x=bp.targetX-cellSize*0.5;
      else if(dir==='up')bp.y=bp.targetY+cellSize*0.5;
      else if(dir==='down')bp.y=bp.targetY-cellSize*0.5;
      bp.scale=1;bp.opacity=1;
    }
  }
  
  // Animate over 200ms then check matches
  var startT=performance.now();
  function animSlide(){
    var elapsed=performance.now()-startT;
    var t=Math.min(elapsed/200,1);
    // Ease out with slight overshoot
    var ease=t<1?1-Math.pow(1-t,3)*(1-t*0.15):1;
    
    for(var r=0;r<GRID;r++){
      for(var c=0;c<GRID;c++){
        var bp=blockPositions[r][c];
        bp.x=bp.x+(bp.targetX-bp.x)*0.2;
        bp.y=bp.y+(bp.targetY-bp.y)*0.2;
        if(t>=1){bp.x=bp.targetX;bp.y=bp.targetY;}
      }
    }
    
    if(t<1){
      requestAnimationFrame(animSlide);
    } else {
      slideAnimating=false;
      setTimeout(function(){clearMatches(true);},50);
    }
  }
  requestAnimationFrame(animSlide);
  
  updateUI();
  return true;
}

function findMatches(){
  var visited=[];
  for(var r=0;r<GRID;r++){visited[r]=[];for(var c=0;c<GRID;c++)visited[r][c]=false;}
  var groups=[];
  var dirs=[[-1,0],[1,0],[0,-1],[0,1]];
  
  for(var r=0;r<GRID;r++){
    for(var c=0;c<GRID;c++){
      if(visited[r][c]||grid[r][c]===-1)continue;
      var color=grid[r][c];
      var group=[];
      var stack=[[r,c]];
      visited[r][c]=true;
      while(stack.length){
        var cur=stack.pop();
        group.push(cur);
        for(var d=0;d<4;d++){
          var nr=cur[0]+dirs[d][0],nc=cur[1]+dirs[d][1];
          if(nr>=0&&nr<GRID&&nc>=0&&nc<GRID&&!visited[nr][nc]&&grid[nr][nc]===color){
            visited[nr][nc]=true;
            stack.push([nr,nc]);
          }
        }
      }
      if(group.length>=3)groups.push({color:color,cells:group});
    }
  }
  return groups;
}

function clearMatches(doEffects){
  var groups=findMatches();
  if(groups.length===0){
    if(doEffects)checkGameState();
    return;
  }
  
  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi];
    var colorHex=COLORS[g.color];
    var cx=0,cy=0;
    for(var ci=0;ci<g.cells.length;ci++){cx+=g.cells[ci][1];cy+=g.cells[ci][0];}
    cx/=g.cells.length;cy/=g.cells.length;
    
    if(doEffects){
      addPaintSplash(colorHex,g.cells.length);
      var px=gridOffsetX+(cx+0.5)*cellSize;
      var py=gridOffsetY+(cy+0.5)*cellSize;
      spawnParticles(px,py,colorHex,g.cells.length);
      splashes.push({x:px,y:py,color:colorHex,t:0,size:g.cells.length*10});
      // Screen flash
      screenFlash={color:colorHex,t:0};
      GameAudio.play('match');
      setTimeout(function(){GameAudio.play('pour');},100);
    }
    
    // Shrink animation for matched cells
    for(var ci=0;ci<g.cells.length;ci++){
      var mr=g.cells[ci][0],mc=g.cells[ci][1];
      if(blockPositions[mr]&&blockPositions[mr][mc]){
        blockPositions[mr][mc].scale=0;
      }
      grid[mr][mc]=-1;
    }
    
    paintPercent+=g.cells.length*1.2;
  }
  
  // Gravity
  for(var c=0;c<GRID;c++){
    var write=GRID-1;
    for(var r=GRID-1;r>=0;r--){
      if(grid[r][c]!==-1){
        grid[write][c]=grid[r][c];
        if(write!==r)grid[r][c]=-1;
        write--;
      }
    }
    var lvl=LEVELS[currentLevel];
    for(var r2=write;r2>=0;r2--){
      grid[r2][c]=Math.floor(Math.random()*lvl.colors);
    }
  }
  
  initBlockPositions();
  updateUI();
  setTimeout(function(){clearMatches(doEffects);},250);
}

function addPaintSplash(color,size){
  var px=Math.random()*260+20;
  var py=Math.random()*260+20;
  var radius=10+size*4+Math.random()*15;
  
  paintCtx.save();
  paintCtx.globalAlpha=0.7+Math.random()*0.3;
  var grad=paintCtx.createRadialGradient(px,py,0,px,py,radius);
  grad.addColorStop(0,color);
  grad.addColorStop(0.7,color+'CC');
  grad.addColorStop(1,color+'00');
  paintCtx.fillStyle=grad;
  paintCtx.beginPath();
  paintCtx.arc(px,py,radius,0,Math.PI*2);
  paintCtx.fill();
  
  for(var i=0;i<8+size*2;i++){
    var angle=Math.random()*Math.PI*2;
    var dist=radius+Math.random()*radius*0.8;
    var dx=px+Math.cos(angle)*dist;
    var dy=py+Math.sin(angle)*dist;
    var dr=1.5+Math.random()*4;
    paintCtx.fillStyle=color;
    paintCtx.globalAlpha=0.5+Math.random()*0.5;
    paintCtx.beginPath();
    paintCtx.arc(dx,dy,dr,0,Math.PI*2);
    paintCtx.fill();
  }
  
  paintCtx.strokeStyle=color;
  paintCtx.lineWidth=2+Math.random()*3;
  paintCtx.globalAlpha=0.4;
  paintCtx.beginPath();
  paintCtx.moveTo(px,py);
  paintCtx.quadraticCurveTo(px+Math.random()*60-30,py+Math.random()*60-30,px+Math.random()*80-40,py+Math.random()*80-40);
  paintCtx.stroke();
  paintCtx.restore();
}

function spawnParticles(x,y,color,count){
  var num=20+count*3;
  for(var i=0;i<num;i++){
    var angle=Math.random()*Math.PI*2;
    var speed=2+Math.random()*7;
    particles.push({
      x:x,y:y,
      vx:Math.cos(angle)*speed,
      vy:Math.sin(angle)*speed-2,
      size:2+Math.random()*5,
      color:color,
      life:1,
      decay:0.015+Math.random()*0.02,
      gravity:0.15
    });
  }
}

function checkGameState(){
  var lvl=LEVELS[currentLevel];
  if(paintPercent>=lvl.target){
    setTimeout(showComplete,300);
  } else if(movesLeft<=0){
    setTimeout(showGameOver,300);
  }
}

function showComplete(){
  var lvl=LEVELS[currentLevel];
  var usedMoves=lvl.moves-movesLeft;
  var stars=1;
  if(usedMoves<=lvl.movesStar2)stars=2;
  if(usedMoves<=lvl.movesStar3)stars=3;
  
  if(!progress.levels)progress.levels={};
  var prev=progress.levels[currentLevel]||0;
  progress.levels[currentLevel]=Math.max(prev,stars);
  if(currentLevel+1>=(progress.maxLevel||0))progress.maxLevel=currentLevel+1;
  progress.currentLevel=currentLevel;
  saveProgress();
  
  var overlay=document.getElementById('complete-overlay');
  var starsEl=document.getElementById('complete-stars').children;
  for(var i=0;i<3;i++){
    starsEl[i].className='star';
    (function(idx){
      if(idx<stars)setTimeout(function(){starsEl[idx].classList.add('earned');GameAudio.play('coin');},300+idx*300);
    })(i);
  }
  
  var rc=document.getElementById('result-painting');
  rc.getContext('2d').drawImage(paintCanvas,0,0,200,200);
  
  document.getElementById('complete-msg').textContent=
    stars===3?'Perfect masterpiece! üèÜ':stars===2?'Beautiful work! üé®':'Canvas complete! üñºÔ∏è';
  
  overlay.classList.add('show');
  GameAudio.play('win');
  
  for(var i=0;i<40;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W/2+Math.random()*100-50,y:H*0.2,
          vx:Math.random()*8-4,vy:-3-Math.random()*5,
          size:3+Math.random()*4,
          color:COLORS[Math.floor(Math.random()*COLORS.length)],
          life:1,decay:0.008,gravity:0.12
        });
      },idx*30);
    })(i);
  }
}

function showGameOver(){
  document.getElementById('go-pct').textContent=Math.floor(paintPercent);
  document.getElementById('go-target').textContent=Math.floor(LEVELS[currentLevel].target);
  var rc=document.getElementById('go-painting');
  rc.getContext('2d').drawImage(paintCanvas,0,0,200,200);
  document.getElementById('gameover-overlay').classList.add('show');
  GameAudio.play('error');
}

function nextLevel(){
  document.getElementById('complete-overlay').classList.remove('show');
  startLevel(Math.min(currentLevel+1,LEVELS.length-1));
}

// Input
function onDown(e){swipeStartX=e.clientX;swipeStartY=e.clientY;swiping=true;}
function onMove(e){}
function onUp(e){
  if(!swiping)return;swiping=false;
  handleSwipe(e.clientX-swipeStartX,e.clientY-swipeStartY);
}
function onTouchStart(e){
  if(e.target.tagName!=='CANVAS')return;
  e.preventDefault();
  var t=e.touches[0];swipeStartX=t.clientX;swipeStartY=t.clientY;swiping=true;
  GameAudio.playBGM('paint-splash');
}
function onTouchMove(e){if(e.target.tagName==='CANVAS')e.preventDefault();}
function onTouchEnd(e){
  if(!swiping)return;swiping=false;
  var t=e.changedTouches[0];
  handleSwipe(t.clientX-swipeStartX,t.clientY-swipeStartY);
}
function handleSwipe(dx,dy){
  var minDist=30;
  if(Math.abs(dx)<minDist&&Math.abs(dy)<minDist)return;
  if(Math.abs(dx)>Math.abs(dy)){
    slideGrid(dx>0?'right':'left');
  } else {
    slideGrid(dy>0?'down':'up');
  }
}
function onKey(e){
  var map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down'};
  if(map[e.key]){e.preventDefault();slideGrid(map[e.key]);}
}

// Render
function loop(){
  requestAnimationFrame(loop);
  draw();
  updateParticlesLoop();
}

function draw(){
  ctx.clearRect(0,0,W,H);
  
  // Dark bg
  ctx.fillStyle='#1a1a2e';
  ctx.fillRect(0,0,W,H);
  
  // Screen flash
  if(screenFlash){
    screenFlash.t+=0.04;
    if(screenFlash.t<1){
      ctx.save();
      ctx.globalAlpha=0.1*(1-screenFlash.t);
      ctx.fillStyle=screenFlash.color;
      ctx.fillRect(0,0,W,H);
      ctx.restore();
    } else {
      screenFlash=null;
    }
  }
  
  // Grid bg
  var pad=6;
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,0.03)';
  ctx.beginPath();
  rrect(ctx,gridOffsetX-pad,gridOffsetY-pad,GRID*cellSize+pad*2,GRID*cellSize+pad*2,14);
  ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;
  ctx.beginPath();
  rrect(ctx,gridOffsetX-pad,gridOffsetY-pad,GRID*cellSize+pad*2,GRID*cellSize+pad*2,14);
  ctx.stroke();
  ctx.restore();
  
  // Cells
  var gap=3;
  for(var r=0;r<GRID;r++){
    for(var c=0;c<GRID;c++){
      var val=grid[r][c];
      var bp=blockPositions[r]&&blockPositions[r][c]?blockPositions[r][c]:null;
      var bx=bp?bp.x:gridOffsetX+c*cellSize;
      var by=bp?bp.y:gridOffsetY+r*cellSize;
      var bscale=bp?bp.scale:1;
      var x=bx+gap;
      var y=by+gap;
      var s=cellSize-gap*2;
      
      if(val===-1){
        ctx.fillStyle='rgba(255,255,255,0.02)';
        ctx.beginPath();
        rrect(ctx,x,y,s,s,8);
        ctx.fill();
        continue;
      }
      
      if(bscale<0.05)continue;
      
      var color=COLORS[val];
      var light=COLOR_LIGHT[val]||color;
      var dark=COLOR_DARK[val]||color;
      
      ctx.save();
      if(bscale<1){
        var cx2=x+s/2,cy2=y+s/2;
        ctx.translate(cx2,cy2);
        ctx.scale(bscale,bscale);
        ctx.translate(-cx2,-cy2);
      }
      
      // Shadow
      ctx.shadowColor=color+'44';ctx.shadowBlur=8;ctx.shadowOffsetY=3;
      
      // Gradient fill
      var grd=ctx.createLinearGradient(x,y,x,y+s);
      grd.addColorStop(0,light);
      grd.addColorStop(1,dark);
      ctx.fillStyle=grd;
      ctx.beginPath();
      rrect(ctx,x,y,s,s,10);
      ctx.fill();
      
      ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetY=0;
      
      // 3D highlight
      ctx.globalAlpha=0.25;
      ctx.fillStyle='#fff';
      ctx.beginPath();
      rrect(ctx,x+3,y+3,s-6,s*0.35,7);
      ctx.fill();
      ctx.globalAlpha=1;
      
      // Pattern overlay per color
      ctx.globalAlpha=0.12;
      ctx.strokeStyle='#fff';
      ctx.fillStyle='#fff';
      ctx.lineWidth=1.5;
      drawPattern(val,x,y,s);
      ctx.globalAlpha=1;
      
      ctx.restore();
    }
  }
  
  // Paint canvas preview - bottom left
  var pcSize=76;
  var pcX=8;
  var pcY=H-pcSize-68;
  
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.3)';ctx.shadowBlur=12;
  ctx.fillStyle='#fff';
  ctx.beginPath();
  rrect(ctx,pcX-3,pcY-3,pcSize+6,pcSize+6,8);
  ctx.fill();
  ctx.restore();
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=2;
  ctx.beginPath();
  rrect(ctx,pcX-3,pcY-3,pcSize+6,pcSize+6,8);
  ctx.stroke();
  ctx.drawImage(paintCanvas,pcX,pcY,pcSize,pcSize);
  
  // Tiny label
  ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='bold 9px sans-serif';ctx.textAlign='center';
  ctx.fillText('üñºÔ∏è '+Math.floor(LEVELS[currentLevel].target)+'% target',pcX+pcSize/2,pcY-6);
  
  // Splashes
  for(var i=splashes.length-1;i>=0;i--){
    var sp=splashes[i];
    sp.t+=0.03;
    if(sp.t>=1){splashes.splice(i,1);continue;}
    ctx.save();
    ctx.globalAlpha=(1-sp.t)*0.6;
    ctx.fillStyle=sp.color;
    ctx.beginPath();
    ctx.arc(sp.x,sp.y,sp.size*(0.3+sp.t*2),0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
  
  // Particles
  for(var pi=0;pi<particles.length;pi++){
    var p=particles[pi];
    ctx.save();
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}

function drawPattern(colorIdx,x,y,s){
  var i;
  switch(colorIdx){
    case 0: // Red: diagonal stripes
      for(i=-s;i<s*2;i+=8){
        ctx.beginPath();
        ctx.moveTo(x+i,y);
        ctx.lineTo(x+i+s,y+s);
        ctx.stroke();
      }
      break;
    case 1: // Blue: dots
      for(i=0;i<5;i++){
        for(var j=0;j<5;j++){
          ctx.beginPath();
          ctx.arc(x+s*0.15+i*s*0.18,y+s*0.15+j*s*0.18,1.5,0,Math.PI*2);
          ctx.fill();
        }
      }
      break;
    case 2: // Yellow: stars
      var pts=[[0.25,0.25],[0.75,0.25],[0.5,0.5],[0.25,0.75],[0.75,0.75]];
      for(i=0;i<pts.length;i++){
        drawMiniStar(x+pts[i][0]*s,y+pts[i][1]*s,3);
      }
      break;
    case 3: // Green: waves
      for(i=0;i<4;i++){
        ctx.beginPath();
        var wy=y+s*0.2+i*s*0.2;
        ctx.moveTo(x+4,wy);
        ctx.quadraticCurveTo(x+s*0.25,wy-4,x+s*0.5,wy);
        ctx.quadraticCurveTo(x+s*0.75,wy+4,x+s-4,wy);
        ctx.stroke();
      }
      break;
    case 4: // Purple: diamonds
      var dpts=[[0.3,0.3],[0.7,0.3],[0.5,0.55],[0.3,0.7],[0.7,0.7]];
      for(i=0;i<dpts.length;i++){
        var dx=x+dpts[i][0]*s,dy=y+dpts[i][1]*s;
        ctx.beginPath();
        ctx.moveTo(dx,dy-3);ctx.lineTo(dx+3,dy);ctx.lineTo(dx,dy+3);ctx.lineTo(dx-3,dy);
        ctx.closePath();ctx.fill();
      }
      break;
    case 5: // Orange: zigzag
      for(i=0;i<3;i++){
        ctx.beginPath();
        var zy=y+s*0.25+i*s*0.22;
        ctx.moveTo(x+4,zy);
        for(var zi=0;zi<4;zi++){
          ctx.lineTo(x+8+zi*((s-12)/3),zy+(zi%2?-4:4));
        }
        ctx.stroke();
      }
      break;
  }
}

function drawMiniStar(cx,cy,r){
  ctx.beginPath();
  for(var i=0;i<5;i++){
    var a=Math.PI*2*i/5-Math.PI/2;
    var a2=a+Math.PI/5;
    ctx.lineTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r);
    ctx.lineTo(cx+Math.cos(a2)*r*0.4,cy+Math.sin(a2)*r*0.4);
  }
  ctx.closePath();ctx.fill();
}

function rrect(c,x,y,w,h,r){
  c.moveTo(x+r,y);
  c.lineTo(x+w-r,y);
  c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);
  c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);
  c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);
  c.quadraticCurveTo(x,y,x+r,y);
}

function updateParticlesLoop(){
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=p.gravity;
    p.life-=p.decay;
    if(p.life<=0)particles.splice(i,1);
  }
}

function saveProgress(){localStorage.setItem('ps_progress',JSON.stringify(progress));}
function loadProgress(){
  try{progress=JSON.parse(localStorage.getItem('ps_progress'))||{};}catch(e){progress={};}
  if(!progress.levels)progress.levels={};
  if(!progress.maxLevel)progress.maxLevel=0;
}

function showLevels(){
  document.getElementById('complete-overlay').classList.remove('show');
  document.getElementById('gameover-overlay').classList.remove('show');
  var grd=document.getElementById('level-grid');
  var html='';
  for(var i=0;i<LEVELS.length;i++){
    var unlocked=i<=Math.max(progress.maxLevel||0,0);
    var stars=progress.levels?progress.levels[i]||0:0;
    var starStr='';
    for(var si=0;si<3;si++)starStr+=si<stars?'‚≠ê':'‚òÜ';
    html+='<button class="lvl-btn '+(unlocked?'':'locked')+' '+(i===currentLevel?'current':'')+'" '+(unlocked?'onclick="G.selectLevel('+i+')"':'')+'>'+
      (i+1)+'<div class="lvl-stars">'+(unlocked?starStr:'üîí')+'</div></button>';
  }
  grd.innerHTML=html;
  document.getElementById('levels-overlay').classList.add('show');
}

function selectLevel(i){
  document.getElementById('levels-overlay').classList.remove('show');
  startLevel(i);
}

function restart(){
  document.getElementById('complete-overlay').classList.remove('show');
  document.getElementById('gameover-overlay').classList.remove('show');
  startLevel(currentLevel);
}

function undo(){
  if(!undoStack.length||slideAnimating)return;
  grid=undoStack.pop();
  movesLeft++;
  initBlockPositions();
  updateUI();
  GameAudio.play('whoosh');
}

function toggleMute(){
  var m=GameAudio.toggleMute();
  document.getElementById('mute-btn').textContent=m?'üîá':'üîä';
}

return{init:init,restart:restart,undo:undo,nextLevel:nextLevel,showLevels:showLevels,selectLevel:selectLevel,toggleMute:toggleMute};
})();

window.addEventListener('DOMContentLoaded',G.init);
document.addEventListener('click',function _b(){GameAudio.playBGM('paint-splash');document.removeEventListener('click',_b);},{once:true});
</script>
</body>
</html>
