<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Paint Splash - Color Puzzle Art Game | GameZipper</title>
<meta name="description" content="Swipe and match colorful paint blocks to create stunning abstract art! A satisfying color splash puzzle game with 20 levels. Play free online!">
<meta name="keywords" content="paint puzzle, color splash, art game, color matching game, paint splash game, puzzle game, free online game">
<meta property="og:title" content="Paint Splash - Color Puzzle Art Game">
<meta property="og:description" content="Swipe color blocks, make paint splash, create art! Free browser puzzle game.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://gamezipper.com/paint-splash/">
<link rel="canonical" href="https://gamezipper.com/paint-splash/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
<script src="../game-audio.js"></script>
<script src="../game-audio-auto.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{padding-top:28px;width:100%;height:100%;overflow:hidden;font-family:'Segoe UI','Helvetica Neue',Arial,sans-serif;touch-action:none;user-select:none;-webkit-user-select:none}
body{background:#1a1a2e;display:flex;flex-direction:column;align-items:center}
#top-bar{position:fixed;top:0;left:0;right:0;background:rgba(20,20,40,0.95);color:#fff;padding:6px 12px;font-size:13px;z-index:99999;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.1)}
#top-bar a{color:#7eb8ff;text-decoration:none;font-weight:600;font-size:12px}
#info-strip{display:flex;align-items:center;gap:16px;font-weight:700;font-size:15px}
#info-strip .info-item{display:flex;align-items:center;gap:4px}
#info-strip .info-label{color:rgba(255,255,255,0.5);font-size:11px;font-weight:600;text-transform:uppercase}
#info-strip .info-val{color:#fff;font-size:16px;font-weight:800}
#wrap{width:100%;height:100%;max-width:500px;display:flex;flex-direction:column;padding:44px 0 0 0}
#game-area{flex:1;position:relative;overflow:hidden}
canvas#gameCanvas{width:100%;height:100%;display:block}
#progress-bar{position:fixed;bottom:48px;left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:468px;height:14px;background:rgba(255,255,255,0.1);border-radius:7px;overflow:hidden;z-index:999;border:1px solid rgba(255,255,255,0.15)}
#progress-fill{height:100%;background:linear-gradient(90deg,#FF6B9D,#C084FC,#60A5FA,#34D399,#FBBF24,#FB923C);border-radius:7px;transition:width 0.5s ease;width:0%;position:relative}
#progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(to bottom,rgba(255,255,255,0.3),transparent);border-radius:7px 7px 0 0}
#bottom-strip{position:fixed;bottom:0;left:0;right:0;height:46px;background:rgba(20,20,40,0.95);display:flex;align-items:center;justify-content:center;gap:20px;z-index:999;backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.1)}
.bottom-btn{background:none;border:none;color:rgba(255,255,255,0.7);font-size:22px;cursor:pointer;padding:8px 14px;border-radius:8px;transition:all .15s;position:relative}
.bottom-btn:active{transform:scale(.9);background:rgba(255,255,255,0.1)}
.bottom-btn span{font-size:10px;display:block;color:rgba(255,255,255,0.4);font-weight:600}
.bottom-btn .hint-count{position:absolute;top:2px;right:6px;font-size:9px;background:#FBBF24;color:#000;border-radius:8px;padding:0 4px;font-weight:800}
.bottom-btn.disabled{opacity:0.3;pointer-events:none}
#mute-btn{position:fixed;bottom:52px;right:8px;z-index:1000;background:rgba(255,255,255,0.1);border:none;border-radius:50%;width:32px;height:32px;font-size:16px;cursor:pointer;color:#fff}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.overlay.show{display:flex}
.overlay-box{background:linear-gradient(135deg,#1e1e3a,#2a1e4a);border-radius:20px;padding:28px;max-width:360px;width:100%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);color:#fff}
.overlay-box h2{font-size:22px;margin-bottom:10px}
.overlay-box p{font-size:14px;color:rgba(255,255,255,0.7);line-height:1.6;margin-bottom:8px}
.obtn{display:inline-block;background:linear-gradient(135deg,#FF6B9D,#C084FC);color:#fff;border:none;padding:10px 24px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin:4px;transition:all .15s;box-shadow:0 4px 15px rgba(192,132,252,0.3)}
.obtn:active{transform:scale(.95)}
.obtn.secondary{background:rgba(255,255,255,0.1);box-shadow:none}
.stars-row{display:flex;justify-content:center;gap:8px;margin:12px 0}
.star{font-size:36px;opacity:0.2;transition:all 0.5s;transform:scale(0.5)}
.star.earned{opacity:1;transform:scale(1);filter:drop-shadow(0 0 8px gold)}
#level-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:16px 0;max-height:280px;overflow-y:auto}
.lvl-btn{width:100%;aspect-ratio:1;border-radius:10px;border:2px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);font-size:14px;font-weight:800;cursor:pointer;position:relative;color:#fff;transition:all .15s}
.lvl-btn.locked{opacity:0.3;cursor:default;color:rgba(255,255,255,0.3)}
.lvl-btn.current{border-color:#C084FC;background:rgba(192,132,252,0.2)}
.lvl-btn .lvl-stars{position:absolute;bottom:2px;left:0;right:0;font-size:8px;text-align:center}
.lvl-btn .lvl-name{position:absolute;top:1px;left:0;right:0;font-size:6px;color:rgba(255,255,255,0.5);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;padding:0 2px}
#result-painting{border:6px solid rgba(255,255,255,0.15);border-radius:12px;margin:12px auto;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:block}
#cookie{position:fixed;bottom:48px;left:0;right:0;background:rgba(30,30,50,0.95);color:#fff;padding:10px 16px;font-size:11px;z-index:100000;display:none;align-items:center;justify-content:space-between;border-top:1px solid rgba(255,255,255,0.1)}
#cookie.show{display:flex}
#cookie button{background:#C084FC;color:#fff;border:none;padding:5px 14px;border-radius:6px;cursor:pointer;font-weight:600;font-size:11px}
/* Tutorial overlay */
#tutorial-overlay .overlay-box{max-width:380px}
.tut-step{display:none}
.tut-step.active{display:block}
.tut-highlight{position:absolute;border:3px solid #FBBF24;border-radius:12px;box-shadow:0 0 20px rgba(251,191,36,0.5);pointer-events:none;z-index:10001;animation:tutPulse 1s infinite}
@keyframes tutPulse{0%,100%{box-shadow:0 0 20px rgba(251,191,36,0.5)}50%{box-shadow:0 0 35px rgba(251,191,36,0.8)}}
.tut-arrow{font-size:32px;animation:tutBounce 0.8s infinite}
@keyframes tutBounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
/* Level intro */
#level-intro{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(0,0,0,0.7);transition:opacity 0.3s}
#level-intro.show{display:flex}
#level-intro .intro-box{text-align:center;color:#fff;animation:introIn 0.5s ease}
@keyframes introIn{from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1}}
#level-intro .lvl-title{font-size:28px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#FF6B9D,#FBBF24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
#level-intro .lvl-subtitle{font-size:16px;color:rgba(255,255,255,0.7)}
#level-intro .lvl-diff{font-size:20px;margin-top:8px}
/* Combo text */
.combo-float{position:fixed;pointer-events:none;z-index:9998;font-size:28px;font-weight:900;color:#FBBF24;text-shadow:0 0 10px rgba(251,191,36,0.8),2px 2px 0 #000;animation:comboUp 1s ease forwards}
@keyframes comboUp{0%{transform:translateY(0) scale(0.5);opacity:0}20%{transform:translateY(-10px) scale(1.2);opacity:1}100%{transform:translateY(-80px) scale(0.8);opacity:0}}
/* Hint flash */
@keyframes hintFlash{0%,100%{opacity:0.3}50%{opacity:1}}
</style>
</head>
<body>
<a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#1a1a2e,#16213e,#1a1a2e);color:#00d4ff;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none;border-bottom:2px solid #0a0a1a;text-shadow:0 0 8px rgba(0,212,255,.5)">‚ö° More Games at GameZipper.com</a>
<div id="top-bar">
<a href="../">‚¨Ö Games</a>
<div id="info-strip">
<div class="info-item"><span class="info-label">LV</span><span class="info-val" id="level-num">1</span></div>
<div class="info-item"><span class="info-label">Moves</span><span class="info-val" id="moves-left">30</span></div>
<div class="info-item"><span class="info-label">Paint</span><span class="info-val" id="paint-pct">0%</span></div>
</div>
<a href="../">More ‚û°</a>
</div>

<div id="wrap">
<div id="game-area"><canvas id="gameCanvas"></canvas></div>
</div>

<div id="progress-bar"><div id="progress-fill"></div></div>

<div id="bottom-strip">
<button class="bottom-btn" onclick="G.showLevels()">üìã<span>Levels</span></button>
<button class="bottom-btn" onclick="G.restart()">üîÑ<span>Restart</span></button>
<button class="bottom-btn" onclick="G.undo()">‚Ü©Ô∏è<span>Undo</span></button>
<button class="bottom-btn" id="hint-btn" onclick="G.requestHint()">üí°<span>Hint</span><div class="hint-count" id="hint-count">3</div></button>
</div>

<button id="mute-btn" onclick="G.toggleMute()">üîä</button>

<!-- Interactive Tutorial Overlay -->
<div class="overlay" id="tutorial-overlay">
<div class="overlay-box" style="position:relative">
<div class="tut-step active" id="tut-step-0">
<div style="font-size:56px;margin-bottom:8px">üé®</div>
<h2>Welcome to Paint Splash!</h2>
<p>Let's learn how to create beautiful art!</p>
<button class="obtn" onclick="G.tutNext(1)" style="font-size:16px;padding:12px 36px;margin-top:12px">Let's Go! ‚Üí</button>
</div>
<div class="tut-step" id="tut-step-1">
<div class="tut-arrow">üëÜ</div>
<h2>Step 1: Swipe!</h2>
<p>Swipe <b>up, down, left or right</b> on the grid to slide all color blocks in that direction.</p>
<button class="obtn" onclick="G.tutNext(2)" style="margin-top:12px">Next ‚Üí</button>
</div>
<div class="tut-step" id="tut-step-2">
<div style="font-size:48px">üé®</div>
<h2>Step 2: Match Colors!</h2>
<p>When <b>3 or more same-color</b> blocks connect, they <b>splash paint</b> onto your canvas!</p>
<button class="obtn" onclick="G.tutNext(3)" style="margin-top:12px">Next ‚Üí</button>
</div>
<div class="tut-step" id="tut-step-3">
<div style="font-size:48px">üî•</div>
<h2>Step 3: Combos!</h2>
<p>Chain multiple matches for <b>COMBO bonuses</b>! More matches = more paint coverage!</p>
<button class="obtn" onclick="G.tutNext(4)" style="margin-top:12px">Next ‚Üí</button>
</div>
<div class="tut-step" id="tut-step-4">
<div style="font-size:48px">üñºÔ∏è</div>
<h2>Step 4: Fill the Canvas!</h2>
<p>Reach the target paint % before running out of moves. Use fewer moves for ‚≠ê‚≠ê‚≠ê!</p>
<p style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:4px">üí° Use the Hint button if you're stuck!</p>
<button class="obtn" onclick="G.tutFinish()" style="font-size:18px;padding:14px 44px;margin-top:12px">Start Painting! üé®</button>
</div>
</div>
</div>

<!-- Level Intro -->
<div id="level-intro">
<div class="intro-box">
<div class="lvl-diff" id="intro-diff"></div>
<div class="lvl-title" id="intro-title"></div>
<div class="lvl-subtitle" id="intro-subtitle"></div>
</div>
</div>

<div class="overlay" id="complete-overlay">
<div class="overlay-box">
<div style="font-size:44px" id="complete-emoji">üéâ</div>
<h2 id="complete-title">The Painting is Complete!</h2>
<div class="stars-row" id="complete-stars">
<span class="star">‚≠ê</span><span class="star">‚≠ê</span><span class="star">‚≠ê</span>
</div>
<canvas id="result-painting" width="200" height="200"></canvas>
<p id="complete-msg" style="font-size:13px">Your abstract masterpiece!</p>
<p style="font-size:11px;color:rgba(255,255,255,0.35);margin-top:4px">üì∏ Screenshot your masterpiece!</p>
<div style="display:flex;gap:8px;margin-top:14px;justify-content:center">
<button class="obtn secondary" onclick="G.showLevels()">üìã Levels</button>
<button class="obtn" onclick="G.nextLevel()">Next Level ‚û°</button>
</div>
</div>
</div>

<div class="overlay" id="gameover-overlay">
<div class="overlay-box">
<div style="font-size:44px">üòÖ</div>
<h2>Out of Moves!</h2>
<p>You painted <span id="go-pct">0</span>% but needed <span id="go-target">60</span>%</p>
<canvas id="go-painting" width="200" height="200" style="border:6px solid rgba(255,255,255,0.1);border-radius:12px;margin:12px auto;display:block"></canvas>
<div style="display:flex;gap:8px;margin-top:14px;justify-content:center">
<button class="obtn secondary" onclick="G.showLevels()">üìã Levels</button>
<button class="obtn" onclick="G.restart()">Try Again üîÑ</button>
</div>
</div>
</div>

<div class="overlay" id="levels-overlay">
<div class="overlay-box">
<h2>üé® Select Level</h2>
<div id="level-grid"></div>
<button class="obtn secondary" onclick="document.getElementById('levels-overlay').classList.remove('show')">Close</button>
</div>
</div>

<div id="cookie">
<span>üç™ Cookies save your progress.</span>
<button onclick="document.getElementById('cookie').classList.remove('show');localStorage.setItem('ps_cookie','1')">OK</button>
</div>

<script>
'use strict';
var G=(function(){

// Macaroon palette
var COLORS=['#FF6B9D','#60A5FA','#FBBF24','#34D399','#C084FC','#FB923C'];
var COLOR_LIGHT=['#FF8DB5','#93C5FD','#FCD34D','#6EE7B7','#D8B4FE','#FDBA74'];
var COLOR_DARK=['#DB2777','#2563EB','#D97706','#059669','#7C3AED','#EA580C'];
var OBSTACLE_COLOR='#4B5563';

var LEVEL_NAMES=[
  'Cherry Blossom','Mint Dream','Lemon Drop','Cotton Candy','Lavender Mist',
  'Coral Reef','Ocean Breeze','Peach Sorbet','Emerald Isle','Sunset Glow',
  'Berry Swirl','Tropical Dawn','Violet Haze','Caramel Drizzle','Sapphire Night',
  'Golden Sunset','Rose Garden','Midnight Carnival','Rainbow Cascade','Aurora Finale'
];

// Difficulty curve
var LEVELS=[];
// Levels 1-5: 3 colors, 4√ó4, generous moves
(function(){
  var cfgs=[
    {colors:3,gridSize:4,target:30,moves:20,ms2:14,ms3:10},
    {colors:3,gridSize:4,target:35,moves:18,ms2:13,ms3:9},
    {colors:3,gridSize:4,target:40,moves:18,ms2:13,ms3:9},
    {colors:3,gridSize:4,target:45,moves:16,ms2:12,ms3:8},
    {colors:3,gridSize:4,target:50,moves:16,ms2:11,ms3:8}
  ];
  for(var i=0;i<cfgs.length;i++){
    var c=cfgs[i];
    LEVELS.push({id:i+1,name:LEVEL_NAMES[i],colors:c.colors,gridSize:c.gridSize,target:c.target,moves:c.moves,movesStar2:c.ms2,movesStar3:c.ms3,obstacles:0,difficulty:1});
  }
})();
// Levels 6-10: 4 colors, 5√ó5
(function(){
  var cfgs=[
    {colors:4,gridSize:5,target:45,moves:22,ms2:16,ms3:11},
    {colors:4,gridSize:5,target:50,moves:22,ms2:15,ms3:10},
    {colors:4,gridSize:5,target:55,moves:20,ms2:14,ms3:10},
    {colors:4,gridSize:5,target:60,moves:20,ms2:14,ms3:9},
    {colors:4,gridSize:5,target:65,moves:18,ms2:13,ms3:9}
  ];
  for(var i=0;i<cfgs.length;i++){
    var c=cfgs[i];
    LEVELS.push({id:i+6,name:LEVEL_NAMES[i+5],colors:c.colors,gridSize:c.gridSize,target:c.target,moves:c.moves,movesStar2:c.ms2,movesStar3:c.ms3,obstacles:0,difficulty:2});
  }
})();
// Levels 11-15: 5 colors, 6√ó6, tight moves
(function(){
  var cfgs=[
    {colors:5,gridSize:6,target:55,moves:22,ms2:16,ms3:11},
    {colors:5,gridSize:6,target:60,moves:20,ms2:14,ms3:10},
    {colors:5,gridSize:6,target:65,moves:20,ms2:14,ms3:9},
    {colors:5,gridSize:6,target:70,moves:18,ms2:13,ms3:9},
    {colors:5,gridSize:6,target:75,moves:18,ms2:12,ms3:8}
  ];
  for(var i=0;i<cfgs.length;i++){
    var c=cfgs[i];
    LEVELS.push({id:i+11,name:LEVEL_NAMES[i+10],colors:c.colors,gridSize:c.gridSize,target:c.target,moves:c.moves,movesStar2:c.ms2,movesStar3:c.ms3,obstacles:0,difficulty:3});
  }
})();
// Levels 16-20: 6 colors, 6√ó6, strict, obstacles
(function(){
  var cfgs=[
    {colors:6,gridSize:6,target:65,moves:18,ms2:13,ms3:8,obs:2},
    {colors:6,gridSize:6,target:70,moves:16,ms2:12,ms3:8,obs:3},
    {colors:6,gridSize:6,target:75,moves:16,ms2:11,ms3:7,obs:3},
    {colors:6,gridSize:6,target:80,moves:15,ms2:11,ms3:7,obs:4},
    {colors:6,gridSize:6,target:85,moves:14,ms2:10,ms3:6,obs:5}
  ];
  for(var i=0;i<cfgs.length;i++){
    var c=cfgs[i];
    LEVELS.push({id:i+16,name:LEVEL_NAMES[i+15],colors:c.colors,gridSize:c.gridSize,target:c.target,moves:c.moves,movesStar2:c.ms2,movesStar3:c.ms3,obstacles:c.obs,difficulty:4});
  }
})();

// State
var canvas,ctx,W,H,cellSize,gridOffsetX,gridOffsetY;
var GRID=6; // current grid size
var grid=[];
var obstacleMap=[]; // true = obstacle
var paintCanvas2,paintCtx;
var currentLevel=0,movesLeft=0,paintPercent=0,undoStack=[];
var hintsLeft=3;
var animating=false,particles=[],splashes=[],screenFlash=null;
var comboCount=0; // consecutive match chains
var muted=false,progress={};
var swipeStartX,swipeStartY,swiping=false;
var blockPositions=[];
var slideAnimating=false;
var hintHighlight=null; // {r,c,t} for hint flash
var levelTransition=0; // 0=none, 1=fading out, 2=fading in

function init(){
  canvas=document.getElementById('gameCanvas');
  ctx=canvas.getContext('2d');
  paintCanvas2=document.createElement('canvas');
  paintCanvas2.width=300;paintCanvas2.height=300;
  paintCtx=paintCanvas2.getContext('2d');

  loadProgress();
  resize();
  window.addEventListener('resize',resize);

  canvas.addEventListener('mousedown',onDown);
  canvas.addEventListener('mousemove',onMove);
  canvas.addEventListener('mouseup',onUp);
  canvas.addEventListener('touchstart',onTouchStart,{passive:false});
  canvas.addEventListener('touchmove',onTouchMove,{passive:false});
  canvas.addEventListener('touchend',onTouchEnd,{passive:false});
  document.addEventListener('keydown',onKey);

  if(!localStorage.getItem('ps_cookie')){
    document.getElementById('cookie').classList.add('show');
  }

  var startLvl=progress.currentLevel||0;
  // Show tutorial on level 1 if not done
  if(!localStorage.getItem('ps_tutorial2')&&startLvl===0){
    document.getElementById('tutorial-overlay').classList.add('show');
  }

  startLevel(startLvl);
  requestAnimationFrame(loop);
  updateGameState();
}

// Tutorial
function tutNext(step){
  for(var i=0;i<5;i++){
    var el=document.getElementById('tut-step-'+i);
    if(el)el.classList.remove('active');
  }
  var s=document.getElementById('tut-step-'+step);
  if(s)s.classList.add('active');
}
function tutFinish(){
  document.getElementById('tutorial-overlay').classList.remove('show');
  localStorage.setItem('ps_tutorial2','1');
}

function resize(){
  var dpr=window.devicePixelRatio||1;
  var container=document.getElementById('game-area');
  var w=container.clientWidth,h=container.clientHeight;
  canvas.width=w*dpr;canvas.height=h*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  W=w;H=h;
  var gridH=H*0.72;
  var gridW=W*0.92;
  cellSize=Math.min(gridH/GRID,gridW/GRID);
  gridOffsetX=(W-GRID*cellSize)/2;
  gridOffsetY=(H-GRID*cellSize)/2-H*0.02;
  initBlockPositions();
}

function initBlockPositions(){
  blockPositions=[];
  for(var r=0;r<GRID;r++){
    blockPositions[r]=[];
    for(var c=0;c<GRID;c++){
      var x=gridOffsetX+c*cellSize;
      var y=gridOffsetY+r*cellSize;
      blockPositions[r][c]={x:x,y:y,targetX:x,targetY:y,scale:1,opacity:1};
    }
  }
}

function showLevelIntro(lvlIdx){
  var lvl=LEVELS[lvlIdx];
  var diffStars='';
  for(var i=0;i<4;i++)diffStars+=i<lvl.difficulty?'‚≠ê':'‚òÜ';
  document.getElementById('intro-diff').textContent=diffStars;
  document.getElementById('intro-title').textContent='Level '+(lvlIdx+1)+': '+lvl.name;
  var info=lvl.gridSize+'√ó'+lvl.gridSize+' ¬∑ '+lvl.colors+' colors ¬∑ '+lvl.moves+' moves';
  if(lvl.obstacles>0)info+=' ¬∑ '+lvl.obstacles+' obstacles';
  document.getElementById('intro-subtitle').textContent=info;
  var el=document.getElementById('level-intro');
  el.classList.add('show');
  setTimeout(function(){el.classList.remove('show');},1500);
}

function startLevel(lvlIdx){
  if(lvlIdx>=LEVELS.length)lvlIdx=LEVELS.length-1;
  currentLevel=lvlIdx;
  var lvl=LEVELS[lvlIdx];
  GRID=lvl.gridSize;
  movesLeft=lvl.moves;
  paintPercent=0;
  undoStack=[];
  hintsLeft=3;
  comboCount=0;
  particles=[];splashes=[];screenFlash=null;
  animating=false;slideAnimating=false;
  hintHighlight=null;

  paintCtx.fillStyle='#fff';
  paintCtx.fillRect(0,0,300,300);

  // Generate obstacle map
  obstacleMap=[];
  for(var r=0;r<GRID;r++){
    obstacleMap[r]=[];
    for(var c=0;c<GRID;c++)obstacleMap[r][c]=false;
  }
  if(lvl.obstacles>0){
    var placed=0,safety=0;
    while(placed<lvl.obstacles&&safety<100){
      safety++;
      var or2=Math.floor(Math.random()*GRID),oc=Math.floor(Math.random()*GRID);
      if(!obstacleMap[or2][oc]){obstacleMap[or2][oc]=true;placed++;}
    }
  }

  grid=[];
  for(var r=0;r<GRID;r++){
    grid[r]=[];
    for(var c=0;c<GRID;c++){
      if(obstacleMap[r][c])grid[r][c]=-2; // obstacle
      else grid[r][c]=Math.floor(Math.random()*lvl.colors);
    }
  }
  clearMatchesInitial();
  ensureMatchPossible(lvl.colors);
  resize(); // recalc grid layout
  initBlockPositions();
  updateUI();
  updateGameState();

  // Show level intro (skip for tutorial)
  if(localStorage.getItem('ps_tutorial2')||lvlIdx>0){
    showLevelIntro(lvlIdx);
  }
}

function ensureMatchPossible(numColors){
  var dirs=['left','right','up','down'];
  var hasMatch=false;
  for(var d=0;d<dirs.length;d++){
    var simGrid=simulateSlide(grid,dirs[d]);
    if(findMatchesInGrid(simGrid).length>0){hasMatch=true;break;}
  }
  if(!hasMatch){
    // Find 3 non-obstacle cells in a column
    for(var c=0;c<GRID;c++){
      var avail=[];
      for(var r=0;r<GRID;r++){if(!obstacleMap[r][c])avail.push(r);}
      if(avail.length>=3){
        var color=Math.floor(Math.random()*numColors);
        grid[avail[0]][c]=color;grid[avail[1]][c]=color;grid[avail[2]][c]=color;
        clearMatchesInitial();
        break;
      }
    }
  }
}

function simulateSlide(g,dir){
  var ng=g.map(function(r){return r.slice();});
  if(dir==='left'||dir==='right'){
    for(var r=0;r<GRID;r++){
      var movable=[],positions=[];
      for(var c=0;c<GRID;c++){
        if(ng[r][c]===-2)continue; // obstacle stays
        positions.push(c);
        movable.push(ng[r][c]);
      }
      if(dir==='right')movable.reverse();
      var filtered=movable.filter(function(v){return v!==-1;});
      while(filtered.length<movable.length)filtered.push(-1);
      if(dir==='right')filtered.reverse();
      for(var i=0;i<positions.length;i++)ng[r][positions[i]]=filtered[i];
    }
  } else {
    for(var c=0;c<GRID;c++){
      var movable=[],positions=[];
      for(var r=0;r<GRID;r++){
        if(ng[r][c]===-2)continue;
        positions.push(r);
        movable.push(ng[r][c]);
      }
      if(dir==='down')movable.reverse();
      var filtered=movable.filter(function(v){return v!==-1;});
      while(filtered.length<movable.length)filtered.push(-1);
      if(dir==='down')filtered.reverse();
      for(var i=0;i<positions.length;i++)ng[positions[i]][c]=filtered[i];
    }
  }
  return ng;
}

function findMatchesInGrid(g){
  var groups=[];
  var visited=[];
  for(var r=0;r<GRID;r++){visited[r]=[];for(var c=0;c<GRID;c++)visited[r][c]=false;}
  var dirs2=[[-1,0],[1,0],[0,-1],[0,1]];
  for(var r=0;r<GRID;r++){
    for(var c=0;c<GRID;c++){
      if(visited[r][c]||g[r][c]<0)continue;
      var color=g[r][c];
      var group=[];
      var stack=[[r,c]];
      visited[r][c]=true;
      while(stack.length){
        var cur=stack.pop();group.push(cur);
        for(var d=0;d<4;d++){
          var nr=cur[0]+dirs2[d][0],nc=cur[1]+dirs2[d][1];
          if(nr>=0&&nr<GRID&&nc>=0&&nc<GRID&&!visited[nr][nc]&&g[nr][nc]===color){
            visited[nr][nc]=true;stack.push([nr,nc]);
          }
        }
      }
      if(group.length>=3)groups.push({color:color,cells:group});
    }
  }
  return groups;
}

function updateUI(){
  document.getElementById('level-num').textContent=currentLevel+1;
  document.getElementById('moves-left').textContent=movesLeft;
  document.getElementById('paint-pct').textContent=Math.floor(paintPercent)+'%';
  document.getElementById('progress-fill').style.width=Math.min(paintPercent/LEVELS[currentLevel].target*100,100)+'%';
  // Hint button
  document.getElementById('hint-count').textContent=hintsLeft;
  var hb=document.getElementById('hint-btn');
  if(hintsLeft<=0)hb.classList.add('disabled');
  else hb.classList.remove('disabled');
}

function clearMatchesInitial(){
  var found=true,safety=0;
  while(found&&safety<50){
    safety++;
    var groups=findMatches();
    if(groups.length===0){found=false;break;}
    for(var gi=0;gi<groups.length;gi++){
      var g=groups[gi];
      for(var ci=0;ci<g.cells.length;ci++){
        grid[g.cells[ci][0]][g.cells[ci][1]]=-1;
      }
    }
    applyGravityAndRefill();
  }
}

function applyGravityAndRefill(){
  var lvl=LEVELS[currentLevel];
  for(var c=0;c<GRID;c++){
    // Collect non-obstacle positions
    var positions=[];
    for(var r=0;r<GRID;r++){if(!obstacleMap[r][c])positions.push(r);}
    // Gravity: compact non-empty to bottom of positions
    var vals=[];
    for(var i=0;i<positions.length;i++){
      var v=grid[positions[i]][c];
      if(v>=0)vals.push(v);
    }
    var startFill=positions.length-vals.length;
    for(var i=0;i<positions.length;i++){
      if(i<startFill)grid[positions[i]][c]=Math.floor(Math.random()*lvl.colors);
      else grid[positions[i]][c]=vals[i-startFill];
    }
  }
}

function slideGrid(dir){
  if(animating||slideAnimating||movesLeft<=0)return false;

  var oldGrid=grid.map(function(r){return r.slice();});
  var newGrid=simulateSlide(grid,dir);
  var moved=false;
  for(var r=0;r<GRID&&!moved;r++)for(var c=0;c<GRID;c++)if(newGrid[r][c]!==grid[r][c]){moved=true;break;}
  if(!moved)return false;

  undoStack.push(oldGrid);
  if(undoStack.length>5)undoStack.shift();
  movesLeft--;
  comboCount=0;

  GameAudio.play('swoosh');
  slideAnimating=true;
  grid=newGrid;

  for(var r=0;r<GRID;r++){
    for(var c=0;c<GRID;c++){
      var bp=blockPositions[r]&&blockPositions[r][c]?blockPositions[r][c]:null;
      if(!bp)continue;
      bp.targetX=gridOffsetX+c*cellSize;
      bp.targetY=gridOffsetY+r*cellSize;
      if(dir==='left')bp.x=bp.targetX+cellSize*0.5;
      else if(dir==='right')bp.x=bp.targetX-cellSize*0.5;
      else if(dir==='up')bp.y=bp.targetY+cellSize*0.5;
      else if(dir==='down')bp.y=bp.targetY-cellSize*0.5;
      bp.scale=1;bp.opacity=1;
    }
  }

  var startT=performance.now();
  function animSlide(){
    var elapsed=performance.now()-startT;
    var t=Math.min(elapsed/200,1);
    for(var r=0;r<GRID;r++){
      for(var c=0;c<GRID;c++){
        var bp=blockPositions[r]&&blockPositions[r][c]?blockPositions[r][c]:null;
        if(!bp)continue;
        bp.x+=(bp.targetX-bp.x)*0.25;
        bp.y+=(bp.targetY-bp.y)*0.25;
        if(t>=1){bp.x=bp.targetX;bp.y=bp.targetY;}
      }
    }
    if(t<1)requestAnimationFrame(animSlide);
    else{slideAnimating=false;setTimeout(function(){clearMatches(true);},50);}
  }
  requestAnimationFrame(animSlide);
  updateUI();
  updateGameState();
  return true;
}

function findMatches(){
  return findMatchesInGrid(grid);
}

function clearMatches(doEffects){
  var groups=findMatches();
  if(groups.length===0){
    if(doEffects)checkGameState();
    return;
  }

  if(doEffects)comboCount++;

  for(var gi=0;gi<groups.length;gi++){
    var g=groups[gi];
    var colorHex=COLORS[g.color];
    var cx=0,cy=0;
    for(var ci=0;ci<g.cells.length;ci++){cx+=g.cells[ci][1];cy+=g.cells[ci][0];}
    cx/=g.cells.length;cy/=g.cells.length;

    if(doEffects){
      addPaintSplash(colorHex,g.cells.length);
      var px=gridOffsetX+(cx+0.5)*cellSize;
      var py=gridOffsetY+(cy+0.5)*cellSize;
      spawnParticles(px,py,colorHex,g.cells.length);
      splashes.push({x:px,y:py,color:colorHex,t:0,size:g.cells.length*10});
      screenFlash={color:colorHex,t:0};
      GameAudio.play('match');
      setTimeout(function(){GameAudio.play('pour');},100);

      // Combo display
      if(comboCount>=2){
        showCombo(comboCount,px,py);
      }
    }

    for(var ci=0;ci<g.cells.length;ci++){
      var mr=g.cells[ci][0],mc=g.cells[ci][1];
      if(blockPositions[mr]&&blockPositions[mr][mc])blockPositions[mr][mc].scale=0;
      grid[mr][mc]=-1;
    }
    // Each cell contributes to paint based on grid size
    var cellContrib=100/(GRID*GRID-LEVELS[currentLevel].obstacles);
    paintPercent+=g.cells.length*cellContrib*0.45;
    // Combo bonus
    if(doEffects&&comboCount>=2)paintPercent+=comboCount*0.5;
  }

  applyGravityAndRefill();
  initBlockPositions();
  updateUI();
  updateGameState();
  setTimeout(function(){clearMatches(doEffects);},250);
}

function showCombo(count,x,y){
  var el=document.createElement('div');
  el.className='combo-float';
  el.textContent='√ó'+count+' COMBO!';
  el.style.left=(x/W*100)+'%';
  el.style.top=(y/H*100)+'%';
  document.body.appendChild(el);
  setTimeout(function(){if(el.parentNode)el.parentNode.removeChild(el);},1000);
}

function addPaintSplash(color,size){
  var px=Math.random()*260+20;
  var py=Math.random()*260+20;
  var radius=10+size*4+Math.random()*15;
  paintCtx.save();
  paintCtx.globalAlpha=0.7+Math.random()*0.3;
  var grad=paintCtx.createRadialGradient(px,py,0,px,py,radius);
  grad.addColorStop(0,color);
  grad.addColorStop(0.7,color+'CC');
  grad.addColorStop(1,color+'00');
  paintCtx.fillStyle=grad;
  paintCtx.beginPath();
  paintCtx.arc(px,py,radius,0,Math.PI*2);
  paintCtx.fill();
  // Splatter dots
  for(var i=0;i<8+size*2;i++){
    var angle=Math.random()*Math.PI*2;
    var dist=radius+Math.random()*radius*0.8;
    var dx=px+Math.cos(angle)*dist;
    var dy=py+Math.sin(angle)*dist;
    var dr=1.5+Math.random()*4;
    paintCtx.fillStyle=color;
    paintCtx.globalAlpha=0.5+Math.random()*0.5;
    paintCtx.beginPath();
    paintCtx.arc(dx,dy,dr,0,Math.PI*2);
    paintCtx.fill();
  }
  paintCtx.strokeStyle=color;
  paintCtx.lineWidth=2+Math.random()*3;
  paintCtx.globalAlpha=0.4;
  paintCtx.beginPath();
  paintCtx.moveTo(px,py);
  paintCtx.quadraticCurveTo(px+Math.random()*60-30,py+Math.random()*60-30,px+Math.random()*80-40,py+Math.random()*80-40);
  paintCtx.stroke();
  paintCtx.restore();
}

function spawnParticles(x,y,color,count){
  var num=10+count*2;
  for(var i=0;i<num;i++){
    var angle=Math.random()*Math.PI*2;
    var speed=2+Math.random()*6;
    particles.push({
      x:x,y:y,
      vx:Math.cos(angle)*speed,
      vy:Math.sin(angle)*speed-2,
      size:2+Math.random()*4,
      color:color,
      life:1,
      decay:0.015+Math.random()*0.02,
      gravity:0.15
    });
  }
}

function checkGameState(){
  var lvl=LEVELS[currentLevel];
  updateGameState();
  if(paintPercent>=lvl.target){
    setTimeout(showComplete,300);
  } else if(movesLeft<=0){
    setTimeout(showGameOver,300);
  }
}

function showComplete(){
  var lvl=LEVELS[currentLevel];
  var usedMoves=lvl.moves-movesLeft;
  var stars=1;
  if(usedMoves<=lvl.movesStar2)stars=2;
  if(usedMoves<=lvl.movesStar3)stars=3;

  if(!progress.levels)progress.levels={};
  var prev=progress.levels[currentLevel]||0;
  progress.levels[currentLevel]=Math.max(prev,stars);
  if(currentLevel+1>=(progress.maxLevel||0))progress.maxLevel=currentLevel+1;
  progress.currentLevel=currentLevel;
  saveProgress();

  var overlay=document.getElementById('complete-overlay');
  var starsEl=document.getElementById('complete-stars').children;
  for(var i=0;i<3;i++){
    starsEl[i].className='star';
    (function(idx){
      if(idx<stars)setTimeout(function(){starsEl[idx].classList.add('earned');GameAudio.play('coin');},300+idx*300);
    })(i);
  }

  var rc=document.getElementById('result-painting');
  rc.getContext('2d').drawImage(paintCanvas2,0,0,200,200);

  document.getElementById('complete-title').textContent='The Painting is Complete!';
  document.getElementById('complete-msg').textContent=
    stars===3?'Perfect masterpiece! üèÜ':stars===2?'Beautiful work! üé®':'Canvas complete! üñºÔ∏è';

  overlay.classList.add('show');
  GameAudio.play('win');

  // Rainbow particle explosion
  for(var i=0;i<60;i++){
    (function(idx){
      setTimeout(function(){
        particles.push({
          x:W*Math.random(),y:H*0.3*Math.random(),
          vx:Math.random()*8-4,vy:-2-Math.random()*5,
          size:3+Math.random()*5,
          color:COLORS[Math.floor(Math.random()*COLORS.length)],
          life:1,decay:0.006,gravity:0.1
        });
      },idx*25);
    })(i);
  }
  updateGameState();
}

function showGameOver(){
  document.getElementById('go-pct').textContent=Math.floor(paintPercent);
  document.getElementById('go-target').textContent=Math.floor(LEVELS[currentLevel].target);
  var rc=document.getElementById('go-painting');
  rc.getContext('2d').drawImage(paintCanvas2,0,0,200,200);
  document.getElementById('gameover-overlay').classList.add('show');
  GameAudio.play('error');
  updateGameState();
}

function nextLevel(){
  document.getElementById('complete-overlay').classList.remove('show');
  startLevel(Math.min(currentLevel+1,LEVELS.length-1));
}

// Input handlers
function onDown(e){swipeStartX=e.clientX;swipeStartY=e.clientY;swiping=true;}
function onMove(){}
function onUp(e){
  if(!swiping)return;swiping=false;
  handleSwipe(e.clientX-swipeStartX,e.clientY-swipeStartY);
}
function onTouchStart(e){
  if(e.target.tagName!=='CANVAS')return;
  e.preventDefault();
  var t=e.touches[0];swipeStartX=t.clientX;swipeStartY=t.clientY;swiping=true;
  GameAudio.playBGM('paint-splash');
}
function onTouchMove(e){if(e.target.tagName==='CANVAS')e.preventDefault();}
function onTouchEnd(e){
  if(!swiping)return;swiping=false;
  var t=e.changedTouches[0];
  handleSwipe(t.clientX-swipeStartX,t.clientY-swipeStartY);
}
function handleSwipe(dx,dy){
  var minDist=20;
  var absDx=Math.abs(dx),absDy=Math.abs(dy);
  if(absDx<minDist&&absDy<minDist)return;
  var ratio=Math.max(absDx,absDy)/(Math.min(absDx,absDy)+0.1);
  if(ratio<1.3)return;
  try{if(navigator.vibrate)navigator.vibrate(15);}catch(e2){}
  if(absDx>absDy)slideGrid(dx>0?'right':'left');
  else slideGrid(dy>0?'down':'up');
}
function onKey(e){
  var map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down'};
  if(map[e.key]){e.preventDefault();slideGrid(map[e.key]);}
}

// Render loop
function loop(){
  requestAnimationFrame(loop);
  draw();
  updateParticlesLoop();
}

function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#1a1a2e';
  ctx.fillRect(0,0,W,H);

  // Screen flash
  if(screenFlash){
    screenFlash.t+=0.04;
    if(screenFlash.t<1){
      ctx.save();
      ctx.globalAlpha=0.1*(1-screenFlash.t);
      ctx.fillStyle=screenFlash.color;
      ctx.fillRect(0,0,W,H);
      ctx.restore();
    } else screenFlash=null;
  }

  // Grid bg
  var pad=6;
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,0.03)';
  ctx.beginPath();
  rrect(ctx,gridOffsetX-pad,gridOffsetY-pad,GRID*cellSize+pad*2,GRID*cellSize+pad*2,14);
  ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;
  ctx.beginPath();
  rrect(ctx,gridOffsetX-pad,gridOffsetY-pad,GRID*cellSize+pad*2,GRID*cellSize+pad*2,14);
  ctx.stroke();
  ctx.restore();

  var gap=3;
  for(var r=0;r<GRID;r++){
    for(var c=0;c<GRID;c++){
      var val=grid[r][c];
      var bp=blockPositions[r]&&blockPositions[r][c]?blockPositions[r][c]:null;
      var bx=bp?bp.x:gridOffsetX+c*cellSize;
      var by=bp?bp.y:gridOffsetY+r*cellSize;
      var bscale=bp?bp.scale:1;
      var x=bx+gap,y=by+gap,s=cellSize-gap*2;

      // Obstacle
      if(val===-2){
        ctx.fillStyle=OBSTACLE_COLOR;
        ctx.beginPath();
        rrect(ctx,x,y,s,s,8);
        ctx.fill();
        // Cross pattern
        ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=2;
        ctx.beginPath();ctx.moveTo(x+s*0.3,y+s*0.3);ctx.lineTo(x+s*0.7,y+s*0.7);ctx.stroke();
        ctx.beginPath();ctx.moveTo(x+s*0.7,y+s*0.3);ctx.lineTo(x+s*0.3,y+s*0.7);ctx.stroke();
        continue;
      }

      if(val===-1){
        ctx.fillStyle='rgba(255,255,255,0.02)';
        ctx.beginPath();rrect(ctx,x,y,s,s,8);ctx.fill();
        continue;
      }
      if(bscale<0.05)continue;

      var color=COLORS[val]||'#888';
      var light=COLOR_LIGHT[val]||color;
      var dark=COLOR_DARK[val]||color;

      ctx.save();
      if(bscale<1){
        var cx2=x+s/2,cy2=y+s/2;
        ctx.translate(cx2,cy2);ctx.scale(bscale,bscale);ctx.translate(-cx2,-cy2);
      }

      // Hint highlight
      if(hintHighlight&&hintHighlight.r===r&&hintHighlight.c===c){
        var ht=hintHighlight.t;
        var hAlpha=0.3+0.7*Math.abs(Math.sin(ht*8));
        ctx.shadowColor='#FBBF24';ctx.shadowBlur=20;
        ctx.globalAlpha=hAlpha;
      }

      ctx.shadowColor=color+'44';ctx.shadowBlur=8;ctx.shadowOffsetY=3;
      var grd=ctx.createLinearGradient(x,y,x,y+s);
      grd.addColorStop(0,light);grd.addColorStop(1,dark);
      ctx.fillStyle=grd;
      ctx.beginPath();rrect(ctx,x,y,s,s,10);ctx.fill();
      ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetY=0;

      // 3D highlight
      ctx.globalAlpha=0.25;ctx.fillStyle='#fff';
      ctx.beginPath();rrect(ctx,x+3,y+3,s-6,s*0.35,7);ctx.fill();
      ctx.globalAlpha=1;

      // Pattern
      ctx.globalAlpha=0.12;ctx.strokeStyle='#fff';ctx.fillStyle='#fff';ctx.lineWidth=1.5;
      drawPattern(val,x,y,s);
      ctx.globalAlpha=1;
      ctx.restore();
    }
  }

  // Paint canvas preview
  var pcSize=76;
  var pcX=8,pcY=H-pcSize-68;
  ctx.save();
  ctx.shadowColor='rgba(0,0,0,0.3)';ctx.shadowBlur=12;
  ctx.fillStyle='#fff';
  ctx.beginPath();rrect(ctx,pcX-3,pcY-3,pcSize+6,pcSize+6,8);ctx.fill();
  ctx.restore();
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=2;
  ctx.beginPath();rrect(ctx,pcX-3,pcY-3,pcSize+6,pcSize+6,8);ctx.stroke();
  ctx.drawImage(paintCanvas2,pcX,pcY,pcSize,pcSize);
  ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='bold 9px sans-serif';ctx.textAlign='center';
  ctx.fillText('üñºÔ∏è '+Math.floor(LEVELS[currentLevel].target)+'% target',pcX+pcSize/2,pcY-6);

  // Splashes
  for(var i=splashes.length-1;i>=0;i--){
    var sp=splashes[i];sp.t+=0.03;
    if(sp.t>=1){splashes.splice(i,1);continue;}
    ctx.save();ctx.globalAlpha=(1-sp.t)*0.6;ctx.fillStyle=sp.color;
    ctx.beginPath();ctx.arc(sp.x,sp.y,sp.size*(0.3+sp.t*2),0,Math.PI*2);ctx.fill();ctx.restore();
  }

  // Particles
  for(var pi=0;pi<particles.length;pi++){
    var p=particles[pi];
    ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill();ctx.restore();
  }

  // Update hint highlight
  if(hintHighlight){
    hintHighlight.t+=0.016;
    if(hintHighlight.t>1)hintHighlight=null;
  }
}

function drawPattern(colorIdx,x,y,s){
  var i;
  switch(colorIdx%6){
    case 0:for(i=-s;i<s*2;i+=8){ctx.beginPath();ctx.moveTo(x+i,y);ctx.lineTo(x+i+s,y+s);ctx.stroke();}break;
    case 1:for(i=0;i<5;i++){for(var j=0;j<5;j++){ctx.beginPath();ctx.arc(x+s*0.15+i*s*0.18,y+s*0.15+j*s*0.18,1.5,0,Math.PI*2);ctx.fill();}}break;
    case 2:var pts=[[0.25,0.25],[0.75,0.25],[0.5,0.5],[0.25,0.75],[0.75,0.75]];for(i=0;i<pts.length;i++)drawMiniStar(x+pts[i][0]*s,y+pts[i][1]*s,3);break;
    case 3:for(i=0;i<4;i++){ctx.beginPath();var wy=y+s*0.2+i*s*0.2;ctx.moveTo(x+4,wy);ctx.quadraticCurveTo(x+s*0.25,wy-4,x+s*0.5,wy);ctx.quadraticCurveTo(x+s*0.75,wy+4,x+s-4,wy);ctx.stroke();}break;
    case 4:var dpts=[[0.3,0.3],[0.7,0.3],[0.5,0.55],[0.3,0.7],[0.7,0.7]];for(i=0;i<dpts.length;i++){var dx2=x+dpts[i][0]*s,dy2=y+dpts[i][1]*s;ctx.beginPath();ctx.moveTo(dx2,dy2-3);ctx.lineTo(dx2+3,dy2);ctx.lineTo(dx2,dy2+3);ctx.lineTo(dx2-3,dy2);ctx.closePath();ctx.fill();}break;
    case 5:for(i=0;i<3;i++){ctx.beginPath();var zy=y+s*0.25+i*s*0.22;ctx.moveTo(x+4,zy);for(var zi=0;zi<4;zi++)ctx.lineTo(x+8+zi*((s-12)/3),zy+(zi%2?-4:4));ctx.stroke();}break;
  }
}

function drawMiniStar(cx,cy,r){
  ctx.beginPath();
  for(var i=0;i<5;i++){
    var a=Math.PI*2*i/5-Math.PI/2,a2=a+Math.PI/5;
    ctx.lineTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r);
    ctx.lineTo(cx+Math.cos(a2)*r*0.4,cy+Math.sin(a2)*r*0.4);
  }
  ctx.closePath();ctx.fill();
}

function rrect(c,x,y,w,h,r){
  c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);
  c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);
  c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);
}

function updateParticlesLoop(){
  for(var i=particles.length-1;i>=0;i--){
    var p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=p.gravity;
    p.life-=p.decay;
    if(p.life<=0)particles.splice(i,1);
  }
}

function saveProgress(){localStorage.setItem('ps_progress',JSON.stringify(progress));}
function loadProgress(){
  try{progress=JSON.parse(localStorage.getItem('ps_progress'))||{};}catch(e){progress={};}
  if(!progress.levels)progress.levels={};
  if(!progress.maxLevel)progress.maxLevel=0;
}

function showLevels(){
  document.getElementById('complete-overlay').classList.remove('show');
  document.getElementById('gameover-overlay').classList.remove('show');
  var grd2=document.getElementById('level-grid');
  var html='';
  for(var i=0;i<LEVELS.length;i++){
    var unlocked=i<=Math.max(progress.maxLevel||0,0);
    var stars=progress.levels?progress.levels[i]||0:0;
    var starStr='';
    for(var si=0;si<3;si++)starStr+=si<stars?'‚≠ê':'‚òÜ';
    html+='<button class="lvl-btn '+(unlocked?'':'locked')+' '+(i===currentLevel?'current':'')+'" '+(unlocked?'onclick="G.selectLevel('+i+')"':'')+'>'+
      '<div class="lvl-name">'+(unlocked?LEVELS[i].name:'')+'</div>'+
      (i+1)+'<div class="lvl-stars">'+(unlocked?starStr:'üîí')+'</div></button>';
  }
  grd2.innerHTML=html;
  document.getElementById('levels-overlay').classList.add('show');
}

function selectLevel(i){
  document.getElementById('levels-overlay').classList.remove('show');
  startLevel(i);
}

function restart(){
  document.getElementById('complete-overlay').classList.remove('show');
  document.getElementById('gameover-overlay').classList.remove('show');
  startLevel(currentLevel);
}

function undo(){
  if(!undoStack.length||slideAnimating)return;
  grid=undoStack.pop();
  movesLeft++;
  initBlockPositions();
  updateUI();
  updateGameState();
  GameAudio.play('whoosh');
}

function toggleMute(){
  var m=GameAudio.toggleMute();
  document.getElementById('mute-btn').textContent=m?'üîá':'üîä';
}

function requestHint(){
  if(hintsLeft<=0||slideAnimating)return;
  hintsLeft--;
  updateUI();
  updateGameState();

  // Find best swipe direction, then highlight cells that would match
  var best=findBestSwipe();
  if(best&&best.dir){
    var sim=simulateSlide(grid,best.dir);
    var matches=findMatchesInGrid(sim);
    if(matches.length>0){
      // Highlight first match group's cells in current grid
      var group=matches[0];
      // Show direction hint
      var dirText=best.dir==='left'?'‚Üê Swipe Left':best.dir==='right'?'‚Üí Swipe Right':best.dir==='up'?'‚Üë Swipe Up':'‚Üì Swipe Down';
      var tutDiv=document.createElement('div');
      tutDiv.style='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(251,191,36,0.95);color:#000;padding:16px 32px;border-radius:12px;font-size:20px;font-weight:800;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
      tutDiv.textContent=dirText;
      document.body.appendChild(tutDiv);
      setTimeout(function(){if(tutDiv.parentNode)tutDiv.parentNode.removeChild(tutDiv);},1200);
      // Highlight a cell
      if(group.cells.length>0){
        hintHighlight={r:group.cells[0][0],c:group.cells[0][1],t:0};
      }
    }
  }
  GameAudio.play('coin');
}

function findBestSwipe(){
  var dirs=['left','right','up','down'],best=null,bestScore=-1;
  for(var d=0;d<dirs.length;d++){
    var sim=simulateSlide(grid,dirs[d]),changed=false;
    for(var r=0;r<GRID&&!changed;r++)for(var c=0;c<GRID;c++)if(sim[r][c]!==grid[r][c]){changed=true;break;}
    if(!changed)continue;
    var matches=findMatchesInGrid(sim),score=0;
    for(var m=0;m<matches.length;m++)score+=matches[m].cells.length;
    if(score>bestScore){bestScore=score;best={dir:dirs[d],score:score};}
  }
  return best;
}

function updateGameState(){
  var lvl=LEVELS[currentLevel];
  var isOver=movesLeft<=0&&paintPercent<lvl.target;
  var isWin=paintPercent>=lvl.target;
  window._gameState={
    level:currentLevel+1,
    moves:movesLeft,
    maxMoves:lvl.moves,
    colors:lvl.colors,
    isGameOver:isOver,
    isWin:isWin,
    hintsLeft:hintsLeft
  };
}

return{init:init,restart:restart,undo:undo,nextLevel:nextLevel,showLevels:showLevels,selectLevel:selectLevel,toggleMute:toggleMute,requestHint:requestHint,tutNext:tutNext,tutFinish:tutFinish};
})();

window.addEventListener('DOMContentLoaded',G.init);
document.addEventListener('click',function _b(){GameAudio.playBGM('paint-splash');document.removeEventListener('click',_b);},{once:true});
</script>
<script src="../sound-toggle.js"></script>
</body>
</html>