<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>üé™ Memory Master - Carnival</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{padding-top:28px;width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a0a0a}
canvas{display:block;width:100%;height:100%;touch-action:none;position:relative;z-index:1}
/* Circus tent stripe background */
#bg-layer{position:fixed;inset:0;z-index:0;pointer-events:none;
  background:repeating-linear-gradient(45deg,
    #8b0000 0px,#8b0000 30px,
    #cc0000 30px,#cc0000 60px,
    #ffd700 60px,#ffd700 62px,
    #cc0000 62px,#cc0000 92px,
    #8b0000 92px,#8b0000 122px);
  opacity:.15}
/* Floating balloons */
.balloon{position:fixed;pointer-events:none;z-index:0;font-size:32px;opacity:.8}
/* Confetti burst */
.confetti{position:fixed;pointer-events:none;z-index:10000;animation:confettiFall 1.5s ease-out forwards}
@keyframes confettiFall{0%{opacity:1;transform:translate(0,0) rotate(0deg) scale(1)}100%{opacity:0;transform:translate(var(--dx),var(--dy)) rotate(var(--rot)) scale(.3)}}
/* Curtain effect */
#curtain-left,#curtain-right{position:fixed;top:0;bottom:0;width:0;z-index:200;pointer-events:none;transition:width 1s ease-in-out}
#curtain-left{left:0;background:linear-gradient(90deg,#8b0000,#cc0000,#8b0000)}
#curtain-right{right:0;background:linear-gradient(90deg,#8b0000,#cc0000,#8b0000)}
.curtain-close #curtain-left,.curtain-close #curtain-right{width:50%}
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
  <script src="../game-audio.js?v=8"></script>
</head>
<body>
<div id="bg-layer"></div>
<div id="curtain-left"></div>
<div id="curtain-right"></div>
<a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#8b0000,#cc0000,#8b0000);color:#ffd700;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none;border-bottom:2px solid #ffd700;text-shadow:1px 1px 2px rgba(0,0,0,.5)">üé™ More Games at GameZipper.com</a>
<canvas id="c"></canvas>
<div id="fx-overlay" style="position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden"></div>

<script>
// Floating balloons
(function(){
  const colors=['üéà'];
  const balloonColors=['red','blue','yellow','green'];
  const balloons=[];
  for(let i=0;i<8;i++){
    const el=document.createElement('div');
    el.className='balloon';
    el.textContent='üéà';
    el.style.fontSize=(28+Math.random()*16)+'px';
    // Color filter approximation via hue-rotate
    el.style.filter='hue-rotate('+[0,200,60,120][i%4]+'deg)';
    document.body.appendChild(el);
    balloons.push({
      el,x:Math.random()*window.innerWidth,y:window.innerHeight+30+Math.random()*200,
      speed:0.3+Math.random()*0.4,phase:Math.random()*Math.PI*2,
      swayAmp:10+Math.random()*15,swaySpeed:0.01+Math.random()*0.015
    });
  }
  function animBalloons(){
    const h=window.innerHeight,w=window.innerWidth;
    for(const b of balloons){
      b.y-=b.speed;b.phase+=b.swaySpeed;
      const sway=Math.sin(b.phase)*b.swayAmp;
      if(b.y<-50){b.y=h+30;b.x=Math.random()*w;}
      b.el.style.transform=`translate(${b.x+sway}px,${b.y}px)`;
    }
    requestAnimationFrame(animBalloons);
  }
  animBalloons();
})();

(function(){
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const overlay=document.getElementById('fx-overlay');
let W,H,dpr;
const themes={
  animals:['üê∂','üê±','üê∞','ü¶ä','üêª','üêº','üê®','ü¶Å','üê∏','üêµ','üê∑','üêÆ','üêî','ü¶Ñ','üêù'],
  fruits:['üçé','üçä','üçã','üçá','üçì','üçë','üçí','ü•ù','üçå','üçâ','ü´ê','ü•≠','üçç','ü••','üçà'],
  flags:['üáØüáµ','üá∞üá∑','üá∫üá∏','üá¨üáß','üá´üá∑','üá©üá™','üáÆüáπ','üá™üá∏','üáßüá∑','üá®üá¶','üá¶üá∫','üá∑üá∫','üáÆüá≥','üá≤üáΩ','üáπüá∑'],
  faces:['üòÄ','üòÇ','ü•∞','üòé','ü§©','üòú','ü§ó','üòá','ü•≥','üòè','ü§î','üò¥','ü§Ø','üò±','ü´°']
};
const themeNames={animals:'üê± Animals',fruits:'üçé Fruits',flags:'üåç Flags',faces:'üòÄ Emoji'};
const themeKeys=Object.keys(themes);

const difficulties=[
  {name:'Easy',cols:4,rows:3},
  {name:'Normal',cols:4,rows:4},
  {name:'Hard',cols:5,rows:4},
  {name:'Extreme',cols:6,rows:5}
];

let state='menu';
let selDiff=1, selTheme=0;
let cards=[], cols=0, rows=0;
let first=null, second=null, lockBoard=false;
let moves=0, startTime=0, elapsed=0, timerInterval=null;
let matched=0, totalPairs=0;
let comboCount=0, comboTimer2=null;
let particles=[];
let cardAnims={};
let bestScores=JSON.parse(localStorage.getItem('mm_best')||'{}');

let audioCtx2;
function getAC2(){if(!audioCtx2)audioCtx2=new(window.AudioContext||window.webkitAudioContext)();return audioCtx2;}
function sfxFlip(){try{const a=getAC2(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='sine';o.frequency.value=800;g.gain.setValueAtTime(.15,a.currentTime);g.gain.exponentialRampToValueAtTime(.01,a.currentTime+.08);o.start(a.currentTime);o.stop(a.currentTime+.08);}catch(e){}}
function sfxMatch(){try{const a=getAC2();[523,659,784].forEach((f,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.2,a.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.01,a.currentTime+i*.08+.2);o.start(a.currentTime+i*.08);o.stop(a.currentTime+i*.08+.2);});}catch(e){}}
function sfxFail(){try{const a=getAC2(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='square';o.frequency.setValueAtTime(300,a.currentTime);o.frequency.exponentialRampToValueAtTime(200,a.currentTime+.15);g.gain.setValueAtTime(.1,a.currentTime);g.gain.exponentialRampToValueAtTime(.01,a.currentTime+.15);o.start(a.currentTime);o.stop(a.currentTime+.15);}catch(e){}}

let gridX,gridY,cardW,cardH,gap;

function resize(){
  dpr=window.devicePixelRatio||1;
  W=window.innerWidth;H=window.innerHeight-28;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  if(state==='playing')calcGrid();
}
window.addEventListener('resize',resize);

function calcGrid(){
  gap=Math.min(W,H)*0.02;
  const topBar=60,bottomBar=50;
  const availW=W-gap*2, availH=H-topBar-bottomBar-gap*2;
  cardW=Math.min((availW-(cols-1)*gap)/cols, 120);
  cardH=Math.min((availH-(rows-1)*gap)/rows, 140);
  if(cardW/cardH>0.85) cardW=cardH*0.75;
  if(cardH/cardW>1.5) cardH=cardW*1.4;
  const totalW=cols*cardW+(cols-1)*gap;
  const totalH=rows*cardH+(rows-1)*gap;
  gridX=(W-totalW)/2;
  gridY=topBar+(availH-totalH)/2+gap;
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.random()*i+1|0;[a[i],a[j]]=[a[j],a[i]]}return a}

function startGame(){
  const d=difficulties[selDiff];
  cols=d.cols;rows=d.rows;
  totalPairs=(cols*rows)/2;
  const pool=themes[themeKeys[selTheme]].slice(0,totalPairs);
  
  // Smart shuffle: place pairs with controlled distance for better difficulty curve
  // Easy: pairs closer together; Hard: pairs far apart
  const deck=[...pool,...pool];
  // Fisher-Yates shuffle first
  for(let i=deck.length-1;i>0;i--){const j=Math.random()*i+1|0;[deck[i],deck[j]]=[deck[j],deck[i]];}
  
  // For easy difficulty, nudge pairs slightly closer together
  if(selDiff===0){
    for(let p=0;p<pool.length;p++){
      const emoji=pool[p];
      const indices=[];
      for(let i=0;i<deck.length;i++) if(deck[i]===emoji) indices.push(i);
      if(indices.length===2){
        const dist=Math.abs(indices[0]-indices[1]);
        // If pair is too far apart (>60% of deck), try to move closer
        if(dist>deck.length*0.6){
          const target=Math.min(indices[0]+Math.floor(deck.length*0.3), deck.length-1);
          if(target!==indices[1] && deck[target]!==emoji){
            [deck[indices[1]], deck[target]]=[deck[target], deck[indices[1]]];
          }
        }
      }
    }
  }
  
  cards=deck.map((emoji,i)=>({emoji,flipped:false,matched:false,index:i}));
  first=null;second=null;lockBoard=false;
  moves=0;elapsed=0;matched=0;comboCount=0;
  particles=[];cardAnims={};
  state='playing';
  calcGrid();
  startTime=Date.now();
  if(timerInterval)clearInterval(timerInterval);
  timerInterval=setInterval(()=>{if(state==='playing')elapsed=((Date.now()-startTime)/1000)|0},200);
  
  // Brief peek: show all cards for a moment at start (shorter for harder difficulties)
  const peekTime=selDiff===0?1500:selDiff===1?800:400;
  cards.forEach(c=>c.flipped=true);
  lockBoard=true;
  setTimeout(()=>{
    cards.forEach(c=>{if(!c.matched)c.flipped=false;});
    lockBoard=false;
  },peekTime);
}

function cardRect(i){
  const col=i%cols, row=(i/cols)|0;
  return {x:gridX+col*(cardW+gap),y:gridY+row*(cardH+gap),w:cardW,h:cardH};
}

function hitCard(px,py){
  for(let i=0;i<cards.length;i++){
    const r=cardRect(i);
    if(px>=r.x&&px<=r.x+r.w&&py>=r.y&&py<=r.y+r.h)return i;
  }
  return -1;
}

function flipCard(i){
  if(lockBoard||cards[i].flipped||cards[i].matched)return;
  cards[i].flipped=true;
  cardAnims[i]={phase:'flipOpen',progress:0,start:performance.now()};
  sfxFlip();
  if(!first&&first!==0){first=i}
  else if(first!==null&&(second===null)){
    second=i;moves++;
    lockBoard=true;
    setTimeout(checkMatch,600);
  }
}

// DOM confetti burst for match
function spawnConfetti(ci){
  const r=cardRect(ci);
  const cx=r.x+r.w/2, cy=r.y+r.h/2;
  const emojis=['üéä','üéâ'];
  const confColors=['#ff0000','#ffd700','#00ff00','#0088ff','#ff00ff','#ff6600','#00ffff','#ff69b4'];
  for(let i=0;i<10;i++){
    const el=document.createElement('div');
    el.className='confetti';
    if(i<2){
      el.textContent=emojis[i];el.style.fontSize='24px';
    }else{
      el.style.width=(4+Math.random()*8)+'px';
      el.style.height=(8+Math.random()*12)+'px';
      el.style.background=confColors[Math.floor(Math.random()*confColors.length)];
      el.style.borderRadius='2px';
    }
    el.style.left=cx+'px';el.style.top=cy+'px';
    const angle=Math.random()*Math.PI*2;
    const dist=60+Math.random()*120;
    el.style.setProperty('--dx',Math.cos(angle)*dist+'px');
    el.style.setProperty('--dy',(Math.sin(angle)*dist+40)+'px');
    el.style.setProperty('--rot',(Math.random()*720-360)+'deg');
    overlay.appendChild(el);
    setTimeout(()=>el.remove(),1500);
  }
}

function checkMatch(){
  if(cards[first].emoji===cards[second].emoji){
    cards[first].matched=true;cards[second].matched=true;
    spawnParticles(first);spawnParticles(second);
    spawnConfetti(first);spawnConfetti(second);
    matchFlashAlpha=0.4;
    sfxMatch();
    matched++;
    comboCount++;
    if(comboTimer2)clearTimeout(comboTimer2);
    comboTimer2=setTimeout(()=>{comboCount=0},3000);
    if(comboCount>=2){
      // Show combo text
      const comboEl=document.createElement('div');
      comboEl.style.cssText='position:fixed;top:30%;left:50%;transform:translateX(-50%);color:#ffd700;font-size:'+(28+comboCount*4)+'px;font-weight:bold;text-shadow:0 0 20px #ff0,0 0 40px #f80;z-index:10001;pointer-events:none;animation:confettiFall 1s ease-out forwards;';
      comboEl.style.setProperty('--dx','0px');comboEl.style.setProperty('--dy','-60px');comboEl.style.setProperty('--rot','0deg');
      comboEl.textContent=comboCount+'x Combo! üî•';
      overlay.appendChild(comboEl);setTimeout(()=>comboEl.remove(),1000);
    }
    if(matched===totalPairs){
      // Curtain close then open
      document.body.classList.add('curtain-close');
      setTimeout(()=>{
        state='complete';
        clearInterval(timerInterval);
        saveBest();
        document.body.classList.remove('curtain-close');
      },1200);
    }
  }else{
    sfxFail();
    comboCount=0;
    cardAnims[first]={phase:'flipClose',progress:0,start:performance.now()};
    cardAnims[second]={phase:'flipClose',progress:0,start:performance.now()};
    setTimeout(()=>{cards[first].flipped=false;cards[second].flipped=false;first=null;second=null;lockBoard=false},350);
    lockBoard=true;
    setTimeout(()=>{lockBoard=false},350);
    setTimeout(()=>{first=null;second=null},350);
    return;
  }
  first=null;second=null;lockBoard=false;
}

function saveBest(){
  const key=selDiff+'_'+selTheme;
  const score={moves,time:elapsed};
  if(!bestScores[key]||moves<bestScores[key].moves){
    bestScores[key]=score;
    localStorage.setItem('mm_best',JSON.stringify(bestScores));
  }
}

function getStars(){
  const optimal=totalPairs;
  const ratio=moves/optimal;
  if(ratio<=1.5)return 3;
  if(ratio<=2.2)return 2;
  return 1;
}

function spawnParticles(ci){
  const r=cardRect(ci);
  const cx=r.x+r.w/2, cy=r.y+r.h/2;
  const colors=['#FFD700','#FF0000','#FF6B6B','#00FF7F','#FF69B4','#FFA500','#00BFFF'];
  for(let j=0;j<24;j++){
    const angle=Math.random()*Math.PI*2;
    const speed=2+Math.random()*6;
    particles.push({x:cx,y:cy,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:1,color:colors[j%colors.length],size:3+Math.random()*6});
  }
}

let matchFlashAlpha=0;

function drawRoundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

function drawCarnivalBg(){
  // Dark carnival gradient
  const g=ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*.7);
  g.addColorStop(0,'#2a0a0a');g.addColorStop(.5,'#1a0505');g.addColorStop(1,'#0a0202');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  // Subtle spotlights
  ctx.globalAlpha=.05;
  ctx.fillStyle='#ffd700';
  ctx.beginPath();ctx.arc(W*.2,H*.3,150,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(W*.8,H*.4,120,0,Math.PI*2);ctx.fill();
  ctx.globalAlpha=1;
}

function drawMenu(){
  drawCarnivalBg();
  const cx=W/2;
  ctx.textAlign='center';ctx.textBaseline='middle';
  // Carnival title
  ctx.font='bold 42px sans-serif';
  ctx.fillStyle='#ffd700';
  ctx.strokeStyle='#8b0000';ctx.lineWidth=4;
  ctx.strokeText('üé™ Memory Master',cx,H*0.1);
  ctx.fillText('üé™ Memory Master',cx,H*0.1);
  ctx.shadowColor='#ffd700';ctx.shadowBlur=15;
  ctx.fillText('üé™ Memory Master',cx,H*0.1);
  ctx.shadowBlur=0;
  ctx.font='16px sans-serif';ctx.fillStyle='rgba(255,215,0,0.7)';
  ctx.fillText('üé™ The Greatest Card Show! üé™',cx,H*0.1+40);

  // Ticket-style difficulty buttons
  const btnW=Math.min(260,W*0.65),btnH=48,btnGap=12;
  let startY=H*0.22;
  for(let i=0;i<difficulties.length;i++){
    const by=startY+i*(btnH+btnGap);
    const bx=cx-btnW/2;
    // Ticket style: red bg + gold border + serrated edge
    drawRoundRect(bx,by,btnW,btnH,8);
    ctx.fillStyle=i===selDiff?'#cc0000':'#8b0000';
    ctx.fill();
    ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.stroke();
    // Serrated edges (small notches)
    ctx.fillStyle=i===selDiff?'#2a0a0a':'#1a0505';
    for(let n=0;n<6;n++){
      ctx.beginPath();ctx.arc(bx,by+8+n*7,3,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(bx+btnW,by+8+n*7,3,0,Math.PI*2);ctx.fill();
    }
    ctx.fillStyle='#ffd700';
    ctx.font=i===selDiff?'bold 17px sans-serif':'17px sans-serif';
    ctx.fillText('üéüÔ∏è '+difficulties[i].name+' ('+difficulties[i].cols+'√ó'+difficulties[i].rows+')',cx,by+btnH/2);
    difficulties[i]._rect={x:bx,y:by,w:btnW,h:btnH};
  }

  // Theme: "Performance Program"
  startY+=difficulties.length*(btnH+btnGap)+20;
  ctx.font='bold 16px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('üé≠ Choose Performance',cx,startY);
  startY+=30;
  const tBtnW=Math.min(70,W*0.18),tBtnH=40,tGap=10;
  const totalTW=themeKeys.length*tBtnW+(themeKeys.length-1)*tGap;
  let tx=cx-totalTW/2;
  window._tRects=[];
  for(let i=0;i<themeKeys.length;i++){
    const bx=tx+i*(tBtnW+tGap);
    drawRoundRect(bx,startY,tBtnW,tBtnH,10);
    ctx.fillStyle=i===selTheme?'#cc0000':'rgba(139,0,0,0.6)';
    ctx.fill();
    ctx.strokeStyle='#ffd700';ctx.lineWidth=i===selTheme?2:1;ctx.stroke();
    ctx.fillStyle='#ffd700';
    ctx.font='13px sans-serif';
    ctx.fillText(themeNames[themeKeys[i]],bx+tBtnW/2,startY+tBtnH/2);
    window._tRects.push({x:bx,y:startY,w:tBtnW,h:tBtnH});
  }

  // Start button: "SHOWTIME! üé™"
  startY+=tBtnH+35;
  const sBtnW=Math.min(220,W*0.55),sBtnH=54;
  const sbx=cx-sBtnW/2;
  drawRoundRect(sbx,startY,sBtnW,sBtnH,27);
  const sg=ctx.createLinearGradient(sbx,startY,sbx+sBtnW,startY);
  sg.addColorStop(0,'#cc0000');sg.addColorStop(.5,'#ff4400');sg.addColorStop(1,'#cc0000');
  ctx.fillStyle=sg;ctx.fill();
  ctx.strokeStyle='#ffd700';ctx.lineWidth=3;ctx.stroke();
  ctx.font='bold 20px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('ÂºÄÂú∫ÔºÅüé™',cx,startY+sBtnH/2);
  window._startBtn={x:sbx,y:startY,w:sBtnW,h:sBtnH};

  const key=selDiff+'_'+selTheme;
  if(bestScores[key]){
    startY+=sBtnH+25;
    ctx.font='14px sans-serif';ctx.fillStyle='rgba(255,215,0,0.5)';
    ctx.fillText('Best: '+bestScores[key].moves+' moves / '+bestScores[key].time+'s',cx,startY);
  }
}

function drawPlaying(now){
  drawCarnivalBg();
  // Top bar
  ctx.fillStyle='rgba(139,0,0,0.5)';ctx.fillRect(0,0,W,50);
  ctx.textAlign='left';ctx.textBaseline='middle';
  ctx.font='bold 16px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('Moves: '+moves,15,25);
  ctx.textAlign='center';
  ctx.fillText(difficulties[selDiff].name,W/2,25);
  ctx.textAlign='right';
  const m=(elapsed/60)|0,s=elapsed%60;
  ctx.fillText((m<10?'0':'')+m+':'+(s<10?'0':'')+s,W-15,25);

  for(let i=0;i<cards.length;i++){
    const c=cards[i];
    const r=cardRect(i);
    let scaleX=1;
    let showFront=c.flipped||c.matched;

    if(cardAnims[i]){
      const a=cardAnims[i];
      const dur=300;
      a.progress=Math.min(1,(now-a.start)/dur);
      if(a.phase==='flipOpen'){
        if(a.progress<0.5){scaleX=1-a.progress*2;showFront=false;}
        else{scaleX=(a.progress-0.5)*2;showFront=true;}
      }else if(a.phase==='flipClose'){
        if(a.progress<0.5){scaleX=1-a.progress*2;showFront=true;}
        else{scaleX=(a.progress-0.5)*2;showFront=false;}
      }
      if(a.progress>=1)delete cardAnims[i];
    }

    if(c.matched&&!cardAnims[i]){ctx.globalAlpha=0.3;}

    const cx2=r.x+r.w/2, cy2=r.y+r.h/2;
    const drawW=r.w*Math.max(0.02,scaleX);

    ctx.fillStyle='rgba(0,0,0,0.2)';
    drawRoundRect(cx2-drawW/2+2,r.y+3,drawW,r.h,10);ctx.fill();

    if(showFront){
      drawRoundRect(cx2-drawW/2,r.y,drawW,r.h,10);
      ctx.fillStyle='#fff8f0';ctx.fill();
      ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.stroke();
      if(scaleX>0.3){
        ctx.textAlign='center';ctx.textBaseline='middle';
        const fontSize=Math.min(cardW,cardH)*0.45;
        ctx.font=fontSize+'px sans-serif';
        ctx.fillText(c.emoji,cx2,cy2);
      }
    }else{
      drawRoundRect(cx2-drawW/2,r.y,drawW,r.h,10);
      const bg=ctx.createLinearGradient(cx2-drawW/2,r.y,cx2+drawW/2,r.y+r.h);
      bg.addColorStop(0,'#8b0000');bg.addColorStop(.5,'#cc0000');bg.addColorStop(1,'#8b0000');
      ctx.fillStyle=bg;ctx.fill();
      ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.stroke();
      if(scaleX>0.3){
        ctx.fillStyle='rgba(255,215,0,0.3)';
        ctx.font='bold '+(Math.min(cardW,cardH)*0.3)+'px sans-serif';
        ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText('üé™',cx2,cy2);
      }
    }
    ctx.globalAlpha=1;
  }

  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=0.02;
    if(p.life<=0){particles.splice(i,1);continue;}
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  if(matchFlashAlpha>0){
    ctx.fillStyle='rgba(255,215,0,'+matchFlashAlpha+')';
    ctx.fillRect(0,0,W,H);
    matchFlashAlpha-=0.03;
  }

  // Bottom bar
  ctx.fillStyle='rgba(139,0,0,0.5)';ctx.fillRect(0,H-44,W,44);
  ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font='15px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('‚Üê Main Menu',W/2,H-22);
  window._backBtn={x:0,y:H-44,w:W,h:44};
}

function drawComplete(){
  drawCarnivalBg();
  const cx=W/2;
  ctx.textAlign='center';ctx.textBaseline='middle';

  ctx.font='bold 36px sans-serif';ctx.fillStyle='#ffd700';
  ctx.strokeStyle='#8b0000';ctx.lineWidth=3;
  ctx.strokeText('üé™ Bravo!',cx,H*0.2);
  ctx.fillText('üé™ Bravo!',cx,H*0.2);

  const stars=getStars();
  ctx.font='48px sans-serif';
  ctx.fillText('‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars),cx,H*0.32);

  ctx.font='20px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('Moves: '+moves,cx,H*0.43);
  const m2=(elapsed/60)|0,s2=elapsed%60;
  ctx.fillText('Time: '+(m2<10?'0':'')+m2+':'+(s2<10?'0':'')+s2,cx,H*0.5);

  ctx.font='14px sans-serif';ctx.fillStyle='rgba(255,215,0,0.5)';
  ctx.fillText('Minimum moves: '+totalPairs,cx,H*0.57);

  const btnW=200,btnH=50,bx=cx-btnW/2,by=H*0.65;
  drawRoundRect(bx,by,btnW,btnH,25);
  const g2=ctx.createLinearGradient(bx,by,bx+btnW,by);
  g2.addColorStop(0,'#cc0000');g2.addColorStop(1,'#8b0000');
  ctx.fillStyle=g2;ctx.fill();
  ctx.strokeStyle='#ffd700';ctx.lineWidth=2;ctx.stroke();
  ctx.font='bold 18px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('Encore! üé™',cx,by+btnH/2);
  window._replayBtn={x:bx,y:by,w:btnW,h:btnH};

  const by2=by+btnH+20;
  drawRoundRect(bx,by2,btnW,btnH,25);
  ctx.fillStyle='rgba(139,0,0,0.5)';ctx.fill();
  ctx.strokeStyle='#ffd700';ctx.lineWidth=1;ctx.stroke();
  ctx.font='16px sans-serif';ctx.fillStyle='#ffd700';
  ctx.fillText('Main Menu',cx,by2+btnH/2);
  window._menuBtn={x:bx,y:by2,w:btnW,h:btnH};

  // Celebration particles
  if(Math.random()<0.1){
    const colors=['#FFD700','#FF0000','#FF6B6B','#00FF7F','#FF69B4'];
    particles.push({x:Math.random()*W,y:H+10,vx:(Math.random()-0.5)*2,vy:-3-Math.random()*3,life:1,color:colors[Math.random()*colors.length|0],size:3+Math.random()*4});
  }
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life-=0.008;
    if(p.life<=0){particles.splice(i,1);continue;}
    ctx.globalAlpha=p.life;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}

function frame(now){
  ctx.clearRect(0,0,W,H);
  if(state==='menu')drawMenu();
  else if(state==='playing')drawPlaying(now);
  else if(state==='complete')drawComplete();
  requestAnimationFrame(frame);
}

function inRect(px,py,r){return r&&px>=r.x&&px<=r.x+r.w&&py>=r.y&&py<=r.y+r.h}

function handleClick(px,py){
  if(state==='menu'){
    for(let i=0;i<difficulties.length;i++){
      if(inRect(px,py,difficulties[i]._rect)){selDiff=i;return;}
    }
    if(window._tRects){
      for(let i=0;i<window._tRects.length;i++){
        if(inRect(px,py,window._tRects[i])){selTheme=i;return;}
      }
    }
    if(inRect(px,py,window._startBtn)){startGame();return;}
  }else if(state==='playing'){
    if(inRect(px,py,window._backBtn)){state='menu';clearInterval(timerInterval);return;}
    const ci=hitCard(px,py);
    if(ci>=0)flipCard(ci);
  }else if(state==='complete'){
    if(inRect(px,py,window._replayBtn)){startGame();return;}
    if(inRect(px,py,window._menuBtn)){state='menu';return;}
  }
}

canvas.addEventListener('click',e=>{
  const rect=canvas.getBoundingClientRect();
  handleClick(e.clientX-rect.left,e.clientY-rect.top);
});
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const t=e.touches[0];
  handleClick(t.clientX-rect.left,t.clientY-rect.top);
},{passive:false});

resize();
requestAnimationFrame(frame);
window._gameState={get state(){return state},get moves(){return moves},get matched(){return matched},get totalPairs(){return totalPairs},get elapsed(){return elapsed},get cards(){return cards},start:function(){startGame()}};
})();
</script>
<div id="tutorial-overlay" style="position:fixed;inset:0;pointer-events:auto;background:rgba(0,0,0,0.82);display:flex;align-items:center;justify-content:center;z-index:999999">
<div style="background:linear-gradient(135deg,#2a0a0a,#400a0a);border-radius:20px;padding:36px 28px;max-width:340px;text-align:center;color:#ffd700;box-shadow:0 8px 32px rgba(0,0,0,0.5);border:3px solid #ffd700">
<div style="font-size:56px;margin-bottom:12px">üé™</div>
<h2 style="font-size:24px;color:#ffd700;margin-bottom:16px">How to Play</h2>
<p style="font-size:16px;line-height:1.9;text-align:left;color:#ffcc80">
üëÜ Tap a card to <b>flip</b> it over<br>
üîç Find and <b>match all pairs!</b><br>
‚≠ê Fewer moves = more stars ‚≠ê‚≠ê‚≠ê
</p>
<p style="font-size:14px;color:#cc9944;margin-top:12px">üé≠ Choose your act and difficulty, then showtime!</p>
<button onclick="(function(){var cvs=document.querySelector('canvas');if(cvs)cvs.style.pointerEvents='auto';var ov=document.getElementById('tutorial-overlay');if(ov)ov.remove();localStorage.setItem('tutorial_memory','1')})()" ontouchend="event.preventDefault();event.stopPropagation();(function(){var cvs=document.querySelector('canvas');if(cvs)cvs.style.pointerEvents='auto';var ov=document.getElementById('tutorial-overlay');if(ov)ov.remove();localStorage.setItem('tutorial_memory','1')})()" style2="touch-action:manipulation" style="margin-top:20px;padding:14px 36px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(135deg,#cc0000,#8b0000);color:#ffd700;cursor:pointer;font-weight:bold;border:2px solid #ffd700;box-shadow:0 4px 15px rgba(139,0,0,.5)">ÂºÄÂú∫ÔºÅüé™</button>
</div></div>
<script>
(function(){
  var ov=document.getElementById('tutorial-overlay');
  var cvs=document.querySelector('canvas');
  if(localStorage.getItem('tutorial_memory')){if(ov)ov.remove();}
  else{
    if(ov)ov.style.display='flex';
    if(cvs)cvs.style.pointerEvents='none';
    function closeTut(e){if(cvs)cvs.style.pointerEvents='auto';if(ov)ov.remove();localStorage.setItem('tutorial_memory','1');}
    if(ov){ov.addEventListener('touchend',function(e){e.preventDefault();closeTut();});ov.addEventListener('click',closeTut);}
  }
})();
</script>
  <script src="../game-audio-auto.js?v=8"></script>
<script src="../sound-toggle.js?v=8"></script>
</body>
</html>
