<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Space Flappy - Cosmic Adventure</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0b0033;display:flex;justify-content:center;align-items:center}
canvas{display:block;max-width:100%;max-height:100%}
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
  <script src="/../game-audio.js"></script>
</head>
<body><a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,0.85);color:#4ecdc4;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none">‚¨Ö More Games at GameZipper.com</a>
<canvas id="c"></canvas>
<script>
(function(){
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const W=400,H=700;
canvas.width=W;canvas.height=H;

const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playFlapSound(){
  if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';o.frequency.setValueAtTime(600,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(900,audioCtx.currentTime+0.05);
  o.frequency.exponentialRampToValueAtTime(400,audioCtx.currentTime+0.1);
  g.gain.setValueAtTime(0.08,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1);
}
function playScoreSound(){
  if(audioCtx.state==='suspended')audioCtx.resume();
  const notes=[800,1000,1200];
  notes.forEach((f,i)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0.1,audioCtx.currentTime+i*0.06);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+i*0.06+0.15);
  o.connect(g);g.connect(audioCtx.destination);o.start(audioCtx.currentTime+i*0.06);o.stop(audioCtx.currentTime+i*0.06+0.15);});
}
function playCrashSound(){
  if(audioCtx.state==='suspended')audioCtx.resume();
  const bufSize=audioCtx.sampleRate*0.3;
  const buf=audioCtx.createBuffer(1,bufSize,audioCtx.sampleRate);
  const data=buf.getChannelData(0);
  for(let i=0;i<bufSize;i++)data[i]=(Math.random()*2-1)*Math.pow(1-i/bufSize,2);
  const src=audioCtx.createBufferSource();src.buffer=buf;
  const g=audioCtx.createGain();g.gain.setValueAtTime(0.2,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.3);
  src.connect(g);g.connect(audioCtx.destination);src.start();
}

// Load sprite images
const imgShip=new Image();imgShip.src='images/ship.png';
const imgBgTile=new Image();imgBgTile.src='images/bg_space.png';
const imgMeteor1=new Image();imgMeteor1.src='images/meteor1.png';
const imgMeteor2=new Image();imgMeteor2.src='images/meteor2.png';
const imgStar=new Image();imgStar.src='images/star_gold.png';
const imgShield=new Image();imgShield.src='images/shield_gold.png';
let bgPattern=null;
imgBgTile.onload=function(){bgPattern=ctx.createPattern(imgBgTile,'repeat');};

const CANDY_COLORS=['#ff69b4','#ff6b9d','#ff85c0','#ffb6c1','#dda0dd','#da70d6','#ba55d3'];
const READY=0,PLAYING=1,GAMEOVER=2;
let state=READY,score=0,bestScore=parseInt(localStorage.getItem('flappyWingsBest'))||0;
let frameCount=0,scoreBounce=0;

// Death
let deathRotation=0,deathFallVy=0,deathY=0,flashAlpha=0;
let deathPhase=0,deathTimer=0,slowMoTimer=0;
let deathSquash=1,deathFragments=[];

// Rainbow trail
let rainbowTrail=[];
const RAINBOW=['#4466dd','#6688ff','#88aaff','#44ccff','#22ffcc','#88ff88'];

// Candy drops on score
let candyDrops=[];
const CANDY_EMOJI=['üç¨','üç≠','üç©','üßÅ','üç´'];

// Pipe flash
let pipeFlashMap={};

// Cotton candy clouds
let clouds=[];
function initClouds(){
  clouds=[];
  for(let i=0;i<6;i++){
    clouds.push({
      x:Math.random()*W*1.5,y:50+Math.random()*200,
      w:60+Math.random()*80,h:30+Math.random()*20,
      speed:0.2+Math.random()*0.3,
      pink:Math.random()>0.5
    });
  }
}
initClouds();

// Particles
let particles=[];
function spawnScoreParticles(x,y){
  for(let i=0;i<15;i++){
    const a=Math.random()*Math.PI*2,sp=2+Math.random()*4;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,
      color:CANDY_COLORS[i%CANDY_COLORS.length],size:3+Math.random()*4});
  }
}

// Screen flash
let screenFlashAlpha=0;

// Candy rain on death
let candyRain=[];

// Bird
let bird={x:80,y:H/2,vy:0,radius:18,wingAngle:0,wingDir:1};
const GRAVITY=0.45,FLAP=-7.5;

// Pipes (lollipop)
let pipes=[];
const PIPE_W=60,PIPE_SPEED=2.5,PIPE_INTERVAL=90;
let pipeTimer=0;
const GAP_START=150,GAP_MIN=100;
function getGap(){return Math.max(GAP_MIN,GAP_START-score*2.5);}

const GROUND_H=80;
let groundX=0;

function resetGame(){
  bird.y=H/2;bird.vy=0;bird.wingAngle=0;
  pipes=[];pipeTimer=PIPE_INTERVAL-30;score=0;frameCount=0;
  scoreBounce=0;deathRotation=0;flashAlpha=0;
  deathPhase=0;deathTimer=0;slowMoTimer=0;deathY=0;deathFallVy=0;
  deathSquash=1;deathFragments=[];
  rainbowTrail=[];particles=[];screenFlashAlpha=0;pipeFlashMap={};
  candyDrops=[];candyRain=[];
}

function flap(){
  if(audioCtx.state==='suspended')audioCtx.resume();
  if(state===READY){state=PLAYING;resetGame();}
  if(state===PLAYING){bird.vy=FLAP;playFlapSound();}
  if(state===GAMEOVER&&frameCount>30){state=READY;resetGame();}
}

canvas.addEventListener('pointerdown',e=>{e.preventDefault();flap();});
document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();flap();}});

function collides(){
  const by=bird.y,bx=bird.x,br=bird.radius-2;
  if(by+br>H-GROUND_H||by-br<0)return true;
  for(const p of pipes){
    if(bx+br>p.x&&bx-br<p.x+PIPE_W){
      if(by-br<p.gapY||by+br>p.gapY+p.gap)return true;
    }
  }
  return false;
}

function update(){
  frameCount++;

  // Clouds
  for(const c of clouds){
    c.x-=c.speed;
    if(c.x<-c.w)c.x=W+c.w;
  }

  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=0.12;p.life-=0.025;
    if(p.life<=0)particles.splice(i,1);
  }
  if(screenFlashAlpha>0)screenFlashAlpha-=0.06;

  // Candy drops
  for(let i=candyDrops.length-1;i>=0;i--){
    const c=candyDrops[i];c.y+=c.vy;c.vy+=0.15;c.rot+=c.rotV;c.life-=0.01;
    if(c.life<=0||c.y>H)candyDrops.splice(i,1);
  }

  // Candy rain
  for(let i=candyRain.length-1;i>=0;i--){
    const c=candyRain[i];c.y+=c.vy;c.vy+=0.08;c.rot+=c.rotV;c.life-=0.005;
    if(c.life<=0||c.y>H)candyRain.splice(i,1);
  }

  // Pipe flash decay
  for(const k in pipeFlashMap){pipeFlashMap[k]-=0.04;if(pipeFlashMap[k]<=0)delete pipeFlashMap[k];}

  // Death fragments
  for(let i=deathFragments.length-1;i>=0;i--){
    const f=deathFragments[i];f.x+=f.vx;f.y+=f.vy;f.vy+=0.2;f.rot+=f.rotV;f.life-=0.015;
    if(f.life<=0)deathFragments.splice(i,1);
  }

  if(state===GAMEOVER){
    deathTimer++;
    if(deathPhase===0){
      slowMoTimer++;
      if(slowMoTimer>20){deathPhase=1;deathTimer=0;flashAlpha=0.8;}
    }else if(deathPhase===1){
      flashAlpha=Math.max(0,flashAlpha-0.03);
      deathRotation+=0.15;deathSquash=Math.max(0.3,deathSquash-0.03);
      deathFallVy+=0.5;deathY+=deathFallVy;
      if(bird.y+deathY>H-GROUND_H-bird.radius){
        if(deathFallVy>3){deathFallVy*=-0.3;deathY=H-GROUND_H-bird.radius-bird.y;}
        else{deathPhase=2;deathTimer=0;}
      }
    }
    return;
  }
  if(state!==PLAYING)return;
  
  bird.vy+=GRAVITY;bird.y+=bird.vy;
  bird.wingAngle+=bird.wingDir*0.3;
  if(bird.wingAngle>1||bird.wingAngle<-1)bird.wingDir*=-1;

  // Rainbow trail
  if(frameCount%2===0){
    for(let i=0;i<6;i++){
      rainbowTrail.push({x:bird.x-10-i*4,y:bird.y+i*2-5,color:RAINBOW[i],alpha:0.8,size:4-i*0.3});
    }
    if(rainbowTrail.length>60)rainbowTrail.splice(0,12);
  }
  for(const t of rainbowTrail)t.alpha*=0.92;

  pipeTimer++;
  if(pipeTimer>=PIPE_INTERVAL){
    pipeTimer=0;
    const gap=getGap();
    const gapY=80+Math.random()*(H-GROUND_H-gap-160);
    pipes.push({x:W,gapY,gap,scored:false,id:Math.random(),
      stripeOffset:Math.random()*20,
      color:CANDY_COLORS[Math.floor(Math.random()*CANDY_COLORS.length)]});
  }
  for(let i=pipes.length-1;i>=0;i--){
    pipes[i].x-=PIPE_SPEED;
    if(!pipes[i].scored&&pipes[i].x+PIPE_W<bird.x){
      pipes[i].scored=true;score++;
      scoreBounce=1;screenFlashAlpha=0.1;
      spawnScoreParticles(bird.x,bird.y);
      pipeFlashMap[pipes[i].id]=1;
      playScoreSound();
      // Drop 3 candy emoji
      for(let j=0;j<3;j++){
        candyDrops.push({
          x:bird.x-30+Math.random()*60,y:-20-Math.random()*40,
          vy:1+Math.random()*2,rot:0,rotV:0.05+Math.random()*0.1,
          life:1,emoji:CANDY_EMOJI[Math.floor(Math.random()*CANDY_EMOJI.length)]
        });
      }
      if(score>bestScore){bestScore=score;localStorage.setItem('flappyWingsBest',bestScore);}
    }
    if(pipes[i].x<-PIPE_W)pipes.splice(i,1);
  }

  groundX=(groundX-PIPE_SPEED)%40;
  if(scoreBounce>0)scoreBounce=Math.max(0,scoreBounce-0.05);

  if(collides()){
    state=GAMEOVER;flashAlpha=0;
    deathRotation=0;deathFallVy=0;deathY=0;
    deathPhase=0;deathTimer=0;slowMoTimer=0;deathSquash=1;
    playCrashSound();rainbowTrail=[];
    // Bird shatters into 5 candy fragments
    for(let i=0;i<5;i++){
      const a=Math.random()*Math.PI*2,sp=3+Math.random()*5;
      deathFragments.push({
        x:bird.x,y:bird.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-3,
        rot:0,rotV:0.1+Math.random()*0.2,life:1,
        color:CANDY_COLORS[i%CANDY_COLORS.length],size:8+Math.random()*6
      });
    }
    // Candy rain
    for(let i=0;i<30;i++){
      candyRain.push({
        x:Math.random()*W,y:-Math.random()*300,
        vy:2+Math.random()*3,rot:0,rotV:0.03+Math.random()*0.06,
        life:1,emoji:CANDY_EMOJI[Math.floor(Math.random()*CANDY_EMOJI.length)]
      });
    }
  }
}

function drawBg(){
  // Tiled space background
  if(bgPattern){
    ctx.fillStyle=bgPattern;
    ctx.save();ctx.translate(0,0);ctx.fillRect(0,0,W,H-GROUND_H);ctx.restore();
  }else{
    const g=ctx.createLinearGradient(0,0,0,H-GROUND_H);
    g.addColorStop(0,'#0b0033');g.addColorStop(0.5,'#1a0a4e');g.addColorStop(1,'#0d003a');
    ctx.fillStyle=g;ctx.fillRect(0,0,W,H-GROUND_H);
  }
  // Animated nebula overlay
  ctx.globalAlpha=0.1;
  const nebulaGrad=ctx.createRadialGradient(W*0.3+Math.sin(frameCount*0.005)*30,200,0,W*0.5,200,200);
  nebulaGrad.addColorStop(0,'#6600cc');nebulaGrad.addColorStop(1,'transparent');
  ctx.fillStyle=nebulaGrad;ctx.fillRect(0,0,W,H);ctx.globalAlpha=1;

  // Cotton candy clouds as floating nebulae
  for(const c of clouds){
    ctx.save();
    for(let j=0;j<5;j++){
      const ox=(j-2)*c.w*0.2;
      const oy=Math.sin(j*1.2)*c.h*0.2;
      const r=c.h*0.5+Math.sin(j*0.8)*5;
      ctx.beginPath();ctx.arc(c.x+ox,c.y+oy,r,0,Math.PI*2);
      ctx.fillStyle=c.pink?'rgba(100,50,180,'+(0.15+j*0.02)+')':'rgba(50,50,150,'+(0.12+j*0.02)+')';ctx.fill();
    }
    ctx.restore();
  }
}

function drawGround(){
  // Asteroid field / metallic ground
  const g=ctx.createLinearGradient(0,H-GROUND_H,0,H);
  g.addColorStop(0,'#2a1a3a');g.addColorStop(0.1,'#3a2a4a');g.addColorStop(0.5,'#1a0a2a');g.addColorStop(1,'#0a0018');
  ctx.fillStyle=g;ctx.fillRect(0,H-GROUND_H,W,GROUND_H);
  // Glowing edge line
  ctx.strokeStyle='rgba(100,50,200,0.6)';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(0,H-GROUND_H);ctx.lineTo(W,H-GROUND_H);ctx.stroke();
  // Meteor texture tiles
  if(imgMeteor1.complete){
    ctx.globalAlpha=0.15;
    for(let x=groundX;x<W;x+=50){
      ctx.drawImage(imgMeteor1,x,H-GROUND_H+10,40,40);
    }
    ctx.globalAlpha=1;
  }
}

function drawLollipopPipe(x,gapY,gap,pipeId,stripeOffset,pipeColor){
  const flash=pipeFlashMap[pipeId]||0;
  
  // Space pillar style with meteor texture
  function drawSpacePillar(px,py,pw,ph){
    ctx.save();
    ctx.beginPath();ctx.rect(px,py,pw,ph);ctx.clip();
    // Base metallic gradient
    const g=ctx.createLinearGradient(px,0,px+pw,0);
    g.addColorStop(0,'#1a0a3a');g.addColorStop(0.3,'#3a2a5a');g.addColorStop(0.5,'#4a3a6a');g.addColorStop(0.7,'#3a2a5a');g.addColorStop(1,'#1a0a3a');
    ctx.fillStyle=g;ctx.fillRect(px,py,pw,ph);
    // Meteor texture overlay
    if(imgMeteor2.complete){
      ctx.globalAlpha=0.3;
      for(let sy=py;sy<py+ph;sy+=84){
        ctx.drawImage(imgMeteor2,px+5,sy,pw-10,60);
      }
      ctx.globalAlpha=1;
    }
    // Glow edges
    ctx.fillStyle='rgba(100,50,200,0.3)';ctx.fillRect(px,py,3,ph);
    ctx.fillStyle='rgba(100,50,200,0.15)';ctx.fillRect(px+pw-3,py,3,ph);
    ctx.restore();
  }

  // Top pipe
  drawSpacePillar(x,0,PIPE_W,gapY);
  // Bottom pipe
  drawSpacePillar(x,gapY+gap,PIPE_W,H-GROUND_H-(gapY+gap));

  // Energy orb caps
  const ballR=PIPE_W*0.55;
  [gapY, gapY+gap].forEach((cy,idx)=>{
    const grad=ctx.createRadialGradient(x+PIPE_W/2-5,cy-3,2,x+PIPE_W/2,cy,ballR);
    grad.addColorStop(0,'#fff');grad.addColorStop(0.3,'#8866ff');grad.addColorStop(1,'#4400aa');
    ctx.beginPath();ctx.arc(x+PIPE_W/2,cy,ballR,0,Math.PI*2);
    ctx.fillStyle=grad;ctx.fill();
    ctx.strokeStyle='rgba(150,100,255,0.6)';ctx.lineWidth=2;ctx.stroke();
    // Glow
    ctx.shadowColor='#8866ff';ctx.shadowBlur=15;
    ctx.beginPath();ctx.arc(x+PIPE_W/2,cy,ballR*0.5,0,Math.PI*2);
    ctx.fillStyle='rgba(150,100,255,0.2)';ctx.fill();
    ctx.shadowBlur=0;
  });

  // Score flash
  if(flash>0){
    ctx.save();ctx.globalAlpha=flash*0.3;
    ctx.fillStyle='rgba(150,100,255,0.5)';
    ctx.fillRect(x-5,0,PIPE_W+10,H);
    ctx.restore();
  }
}

function drawBird(){
  const {x,y,vy,radius}=bird;
  const drawY=state===GAMEOVER?y+deathY:y;
  const rot=state===GAMEOVER?deathRotation:Math.min(Math.max(vy*3,-30),70)*Math.PI/180;
  const sq=state===GAMEOVER?deathSquash:1;

  ctx.save();ctx.translate(x,drawY);ctx.rotate(rot);ctx.scale(sq,2-sq);

  if(imgShip.complete){
    // Draw spaceship sprite
    const sw=radius*2.8,sh=radius*2.1;
    ctx.shadowColor='#6688ff';ctx.shadowBlur=12;
    ctx.drawImage(imgShip,-sw/2,-sh/2,sw,sh);
    ctx.shadowBlur=0;
    // Engine glow
    if(state===PLAYING&&vy<0){
      ctx.globalAlpha=0.6;
      const flameH=8+Math.random()*8;
      const grd=ctx.createLinearGradient(0,sh/2,0,sh/2+flameH);
      grd.addColorStop(0,'#66aaff');grd.addColorStop(1,'transparent');
      ctx.fillStyle=grd;
      ctx.fillRect(-6,sh/2-4,12,flameH);
      ctx.globalAlpha=1;
    }
  }else{
    // Fallback: draw a simple ship shape
    ctx.fillStyle='#6688ff';
    ctx.beginPath();ctx.moveTo(radius,0);ctx.lineTo(-radius,-radius*0.7);ctx.lineTo(-radius*0.5,0);ctx.lineTo(-radius,radius*0.7);ctx.closePath();ctx.fill();
  }

  ctx.restore();
}

function drawRainbowTrail(){
  for(const t of rainbowTrail){
    if(t.alpha<0.05)continue;
    ctx.beginPath();ctx.arc(t.x,t.y,t.size,0,Math.PI*2);
    ctx.fillStyle=t.color;ctx.globalAlpha=t.alpha;ctx.fill();
  }
  ctx.globalAlpha=1;
}

function drawScore(){
  ctx.textAlign='center';ctx.textBaseline='top';
  const bounce=1+scoreBounce*0.6;
  ctx.save();ctx.translate(W/2,50);ctx.scale(bounce,bounce);

  // Candy panel background
  ctx.fillStyle='rgba(10,0,40,0.85)';
  ctx.strokeStyle='#6688ff';ctx.lineWidth=3;
  ctx.beginPath();ctx.roundRect(-50,-10,100,55,15);ctx.fill();ctx.stroke();

  ctx.font='bold 42px Arial';
  ctx.fillStyle='#fff';
  ctx.shadowColor='#6688ff';ctx.shadowBlur=10;
  ctx.fillText(score,0,0);
  ctx.shadowBlur=0;
  ctx.restore();
}

function getMedal(s){
  if(s>=50)return 'üíé';if(s>=30)return 'ü•á';if(s>=20)return 'ü•à';if(s>=10)return 'ü•â';return '';
}

function drawReady(){
  ctx.textAlign='center';
  // Space title
  ctx.font='bold 38px Arial';
  ctx.fillStyle='#6688ff';ctx.shadowColor='#4466dd';ctx.shadowBlur=20;
  ctx.fillText('SPACE FLAPPY',W/2,H/4);
  ctx.shadowBlur=0;
  ctx.fillStyle='#aaccff';ctx.font='bold 36px Arial';
  ctx.fillText('SPACE FLAPPY',W/2,H/4);

  ctx.font='20px Arial';ctx.fillStyle='#8899cc';
  ctx.fillText('Tap or Space to Start',W/2,H/2+40);

  // Ship sprite bouncing
  if(imgShip.complete){
    const sy=H/2-20+Math.sin(frameCount*0.08)*10;
    ctx.drawImage(imgShip,W/2-50,sy,99,75);
  }
  // Star decorations
  if(imgStar.complete){
    const starY=H/2-20+Math.sin(frameCount*0.08+1)*10;
    ctx.drawImage(imgStar,W/2-90,starY,30,30);
    ctx.drawImage(imgStar,W/2+60,starY+5,30,30);
  }
}

function drawGameOver(){
  if(flashAlpha>0){
    ctx.fillStyle='rgba(100,50,200,'+flashAlpha+')';ctx.fillRect(0,0,W,H);
  }

  // Death fragments
  for(const f of deathFragments){
    ctx.save();ctx.translate(f.x,f.y);ctx.rotate(f.rot);
    ctx.globalAlpha=f.life;ctx.fillStyle=f.color;
    ctx.beginPath();ctx.arc(0,0,f.size,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }

  // Candy rain
  for(const c of candyRain){
    ctx.save();ctx.translate(c.x,c.y);ctx.rotate(c.rot);
    ctx.globalAlpha=c.life;ctx.font='24px Arial';ctx.textAlign='center';
    ctx.fillText(c.emoji,0,0);ctx.restore();
  }

  if(deathPhase===0){
    ctx.fillStyle='rgba(100,50,200,'+(0.1+slowMoTimer*0.015)+')';ctx.fillRect(0,0,W,H);
  }
  if(deathPhase<2)return;

  ctx.fillStyle='rgba(10,0,40,0.7)';ctx.fillRect(0,0,W,H);
  ctx.textAlign='center';
  const t=Math.min(1,(frameCount-deathTimer)/20);
  const spring=t<1?1+0.3*Math.sin(t*Math.PI*3)*Math.pow(1-t,2):1;
  const pw=280,ph=260,px=(W-pw)/2,py=H/2-150;
  ctx.save();ctx.translate(W/2,py+ph/2);ctx.scale(spring,spring);ctx.translate(-W/2,-(py+ph/2));

  // Space panel
  ctx.fillStyle='rgba(10,5,40,0.95)';
  ctx.strokeStyle='#6688ff';ctx.lineWidth=4;
  ctx.beginPath();ctx.roundRect(px,py,pw,ph,20);ctx.fill();ctx.stroke();

  ctx.fillStyle='#aaccff';ctx.font='bold 36px Arial';
  ctx.fillText('GAME OVER',W/2,py+45);

  const medal=getMedal(score);
  if(medal){ctx.font='48px Arial';ctx.fillText(medal,W/2,py+95);}

  ctx.fillStyle='#6688ff';ctx.font='26px Arial';
  ctx.fillText('Score: '+score,W/2,py+135);
  ctx.fillStyle='#8899cc';
  ctx.fillText('Best: '+bestScore,W/2,py+170);

  // Play again button
  ctx.fillStyle='#4466dd';ctx.beginPath();ctx.roundRect(W/2-80,py+195,160,44,12);ctx.fill();
  ctx.fillStyle='#fff';ctx.font='bold 22px Arial';ctx.fillText('Play Again üöÄ',W/2,py+223);
  ctx.restore();
}

function draw(){
  ctx.clearRect(0,0,W,H);
  drawBg();
  for(const p of pipes)drawLollipopPipe(p.x,p.gapY,p.gap,p.id,p.stripeOffset,p.color);
  drawGround();
  if(state===PLAYING)drawRainbowTrail();
  drawBird();

  // Particles
  for(const p of particles){
    ctx.globalAlpha=p.life;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;

  // Candy drops
  for(const c of candyDrops){
    ctx.save();ctx.translate(c.x,c.y);ctx.rotate(c.rot);
    ctx.globalAlpha=c.life;ctx.font='28px Arial';ctx.textAlign='center';
    ctx.fillText(c.emoji,0,0);ctx.restore();
  }

  // Screen flash
  if(screenFlashAlpha>0){
    ctx.fillStyle='rgba(100,50,200,'+screenFlashAlpha+')';
    ctx.fillRect(0,0,W,H);
  }

  if(state===PLAYING)drawScore();
  if(state===READY){drawScore();drawReady();}
  if(state===GAMEOVER)drawGameOver();
}

function readyFloat(){
  if(state===READY){
    bird.y=H/2+Math.sin(frameCount*0.05)*15;
    bird.wingAngle+=0.05*bird.wingDir;
    if(bird.wingAngle>1||bird.wingAngle<-1)bird.wingDir*=-1;
  }
}

function gameLoop(){update();readyFloat();draw();requestAnimationFrame(gameLoop);}
gameLoop();
})();
</script>

<div id="tutorial-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,0,40,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;">
  <div style="background:rgba(10,5,40,0.97);border:3px solid #6688ff;border-radius:20px;padding:32px 28px 24px;max-width:340px;width:90%;color:#aaccff;text-align:center;box-shadow:0 8px 30px rgba(50,50,200,0.3);">
    <div style="font-size:28px;font-weight:bold;margin-bottom:18px;color:#88aaff">üöÄ How to Play</div>
    <div style="font-size:16px;line-height:1.8;text-align:left;margin-bottom:20px;color:#8899cc;">üëÜ Tap to boost your ship!<br>üåå Navigate through space pillars<br>üí• Don't hit the pillars or asteroid field!<br><br>ü•â10pts &nbsp; ü•à20pts &nbsp; ü•á30pts &nbsp; üíé50pts</div>
    <button  onmousedown="var o=document.getElementById('tutorial-overlay');if(o)o.remove();var c=document.getElementById('gameCanvas')||document.querySelector('canvas');if(c)c.style.pointerEvents='auto';" style="touch-action:manipulation;cursor:pointer;position:relative;z-index:10000000;background:linear-gradient(135deg,#4466dd,#6688ff);color:#fff;border:none;border-radius:12px;padding:14px 36px;font-size:18px;font-weight:bold;cursor:pointer;user-select:none;-webkit-user-select:none;" >Got it! üöÄ</button>"
  </div>
</div>
<script>if(!localStorage.getItem('flappy-wings-tutorial-seen')){document.getElementById('tutorial-overlay').style.display='flex';}else{document.getElementById('tutorial-overlay').style.display='none';}</script>

<script>
(function(){
  var ov = document.getElementById('tutorial-overlay');
  if (!ov) return;
  
  // Get canvas for pointer-events reset
  var cvs = document.getElementById('gameCanvas') || document.querySelector('canvas');
  
  // Â¶ÇÊûúÂ∑≤ÊòæÁ§∫ËøátutorialÔºåÁßªÈô§overlay
  if (localStorage.getItem('tutorial-seen-' + window.location.pathname)) {
    ov.remove();
    return;
  }
  
  // ËÆæÁΩÆoverlayÁöÑÂÖ®Â±èclick/touch‰∫ã‰ª∂ÂÖ≥Èó≠
  var closeTut = function(e) {
    e && e.preventDefault && e.preventDefault();
    e && e.stopPropagation && e.stopPropagation();
    if (cvs) cvs.style.pointerEvents = 'auto';
    ov.remove();
    localStorage.setItem('tutorial-seen-' + window.location.pathname, '1');
  };
  
  // Â§öÁßç‰∫ã‰ª∂Â§ÑÁêÜ
  ov.addEventListener('click', closeTut, true);
  ov.addEventListener('touchend', closeTut, true);
  ov.addEventListener('pointerdown', closeTut, true);
  
  // Disable canvas events during tutorial
  if (cvs) cvs.style.pointerEvents = 'none';
})();
</script>
  <script src="/../game-audio-auto.js"></script>
</body>
</html>
