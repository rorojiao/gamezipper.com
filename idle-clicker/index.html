<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Mana Clicker - Alchemy Workshop</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#1a0a2e;color:#e0d0ff;font-family:'Segoe UI',sans-serif;overflow:hidden;height:100vh;display:flex;flex-direction:column;padding-top:24px}
/* Magic particle background canvas */
#magic-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
#header{text-align:center;padding:10px;background:linear-gradient(180deg,rgba(20,5,40,.9),rgba(30,10,50,.8));position:relative;z-index:1;border-bottom:1px solid rgba(138,43,226,.3)}
#header h1{color:#a78bfa;font-size:1.4em;text-shadow:0 0 15px rgba(167,139,250,.5)}
#stats{display:flex;justify-content:center;gap:20px;font-size:1.1em;margin-top:4px}
#stats span{color:#a78bfa}
#game{display:flex;flex:1;overflow:hidden;position:relative;z-index:1}
#cookie-area{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-width:0}
#cookie{width:min(55vw,280px);height:min(55vw,280px);border-radius:50%;cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent;transition:transform .1s;display:flex;align-items:center;justify-content:center;position:relative;
  background:radial-gradient(circle at 35% 30%,#9f7aea,#7c3aed 40%,#5b21b6 60%,#3b0764 80%);
  box-shadow:inset 0 -8px 20px rgba(0,0,0,.4),inset 0 8px 20px rgba(167,139,250,.4),0 0 40px rgba(124,58,237,.5),0 0 80px rgba(124,58,237,.2);
  animation:orbPulse 2s ease-in-out infinite alternate;
  overflow:hidden;
}
/* Planet sprite inside orb */
.orb-sprite{position:absolute;width:70%;height:70%;object-fit:contain;opacity:0.6;pointer-events:none;animation:vortexSpin 8s linear infinite;mix-blend-mode:screen}
/* Decorative sprites */
.idle-deco{position:fixed;z-index:0;pointer-events:none;opacity:0.15}
.idle-deco.spin{animation:decoSpin 10s linear infinite}
@keyframes decoSpin{to{transform:rotate(360deg)}}
.idle-deco.float{animation:decoFloat 4s ease-in-out infinite}
@keyframes decoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
@keyframes orbPulse{0%{box-shadow:inset 0 -8px 20px rgba(0,0,0,.4),inset 0 8px 20px rgba(167,139,250,.4),0 0 40px rgba(124,58,237,.4),0 0 80px rgba(124,58,237,.2)}100%{box-shadow:inset 0 -8px 20px rgba(0,0,0,.4),inset 0 8px 20px rgba(167,139,250,.4),0 0 70px rgba(124,58,237,.7),0 0 120px rgba(124,58,237,.4)}}
/* Energy vortex inside orb */
#cookie::before{content:'';position:absolute;width:60%;height:60%;border-radius:50%;
  background:conic-gradient(from 0deg,rgba(167,139,250,.3),rgba(96,165,250,.3),rgba(167,139,250,.3),rgba(236,72,153,.3),rgba(167,139,250,.3));
  animation:vortexSpin 3s linear infinite;pointer-events:none}
@keyframes vortexSpin{to{transform:rotate(360deg)}}
#cookie::after{content:'';position:absolute;width:35%;height:25%;top:18%;left:22%;border-radius:50%;
  background:radial-gradient(ellipse,rgba(255,255,255,.25),transparent);pointer-events:none}
/* Rune particles on click */
.rune{position:fixed;pointer-events:none;z-index:200;font-size:20px;animation:runeFly .8s ease-out forwards;color:#a78bfa;text-shadow:0 0 8px rgba(167,139,250,.8)}
@keyframes runeFly{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(0.5) rotate(180deg)}}
/* Click flash */
#cookie.bounce{animation:bounce .15s}
@keyframes bounce{0%{transform:scale(.88)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
#cookie:active{transform:scale(.92)}
.float-text{position:absolute;color:#a78bfa;font-weight:bold;font-size:1.4em;pointer-events:none;animation:floatUp .8s forwards;text-shadow:0 0 8px rgba(167,139,250,.6)}
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-80px)}}
/* Gold flash ‚Üí Magic flash */
.gold-flash{position:fixed;inset:0;background:radial-gradient(circle,rgba(167,139,250,0.4),transparent 70%);z-index:150;pointer-events:none;animation:goldFlash .4s ease-out forwards}
@keyframes goldFlash{0%{opacity:1}100%{opacity:0}}
.light-beam{position:absolute;width:4px;background:linear-gradient(180deg,rgba(167,139,250,0),rgba(167,139,250,0.8),rgba(167,139,250,0));pointer-events:none;z-index:99;animation:beamDown .6s ease-out forwards}
@keyframes beamDown{0%{height:0;opacity:1;top:-50%}60%{height:150%;opacity:1}100%{height:150%;opacity:0}}
.score-bounce{animation:scoreBounce .2s cubic-bezier(.34,1.56,.64,1)}
@keyframes scoreBounce{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.crumb{position:fixed;border-radius:50%;pointer-events:none;z-index:200;animation:crumbFall .8s ease-in forwards}
@keyframes crumbFall{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(80px) scale(0.3)}}

#shop{width:280px;background:rgba(20,5,40,.9);overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px;border-left:1px solid rgba(138,43,226,.2)}
#shop h2{color:#a78bfa;text-align:center;font-size:1em;margin-bottom:4px}
.upgrade{background:url('images/panel_grey.png') center/100% 100% no-repeat,rgba(59,7,100,.6);border:2px solid rgba(138,43,226,.3);border-radius:8px;padding:10px;cursor:pointer;transition:background .2s,border-color .2s,box-shadow .2s}
.upgrade:hover{background:rgba(91,33,182,.4);box-shadow:0 0 15px rgba(138,43,226,.3)}
.upgrade.affordable{border-color:#a78bfa;box-shadow:0 0 10px rgba(167,139,250,.2)}
.upgrade.locked{opacity:.4;cursor:default}
.upgrade .name{font-weight:bold;color:#a78bfa;font-size:.95em}
.upgrade .info{font-size:.8em;color:#9080b0;margin-top:2px}
.upgrade .owned{float:right;color:#34d399;font-weight:bold}

/* Golden Cookie ‚Üí Magic Potion */
#golden-cookie{position:absolute;width:50px;height:50px;cursor:pointer;display:none;z-index:100;font-size:40px;line-height:50px;text-align:center;
  animation:potionGlow 1s ease-in-out infinite alternate}
@keyframes potionGlow{0%{transform:scale(1) rotate(-5deg);filter:drop-shadow(0 0 15px gold)}100%{transform:scale(1.15) rotate(5deg);filter:drop-shadow(0 0 30px gold)}}

/* Magic circle on purchase */
#magic-circle{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0) rotate(0deg);width:200px;height:200px;pointer-events:none;z-index:200;opacity:0;transition:none}
#magic-circle.show{animation:magicCircleAnim 0.8s ease-out forwards}
@keyframes magicCircleAnim{0%{opacity:1;transform:translate(-50%,-50%) scale(0) rotate(0deg)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2) rotate(180deg)}100%{opacity:0;transform:translate(-50%,-50%) scale(1.5) rotate(360deg)}}

.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;padding:12px 24px;border-radius:12px;font-weight:bold;font-size:.95em;z-index:10000;animation:toastIn .4s ease-out,toastOut .4s ease-in 2.6s forwards;box-shadow:0 4px 20px rgba(124,58,237,.5);white-space:nowrap}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-30px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes toastOut{to{opacity:0;transform:translateX(-50%) translateY(-30px)}}

#achiev-btn{position:fixed;bottom:10px;left:10px;background:#7c3aed;color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;z-index:100;font-size:.85em;box-shadow:0 0 10px rgba(124,58,237,.3)}
#achiev-panel{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,5,20,.9);z-index:9999;display:none;align-items:center;justify-content:center}
#achiev-panel.show{display:flex}
#achiev-inner{background:rgba(30,10,50,.95);border:2px solid rgba(138,43,226,.4);border-radius:16px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
#achiev-inner h2{color:#a78bfa;margin-bottom:12px;text-align:center}
.achiev-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(59,7,100,.4);border:1px solid rgba(138,43,226,.2)}
.achiev-item.locked{opacity:.35}
.achiev-item .a-icon{font-size:1.5em}
.achiev-item .a-info{flex:1}
.achiev-item .a-name{font-weight:bold;color:#a78bfa;font-size:.9em}
.achiev-item .a-desc{font-size:.75em;color:#9080b0}
#achiev-close{float:right;background:#7c3aed;color:#fff;border:none;padding:4px 12px;border-radius:6px;cursor:pointer;font-weight:bold}

#buff-bar{position:fixed;bottom:10px;right:10px;z-index:100;display:flex;flex-direction:column;gap:4px}
.buff-tag{background:rgba(167,139,250,.9);color:#fff;padding:4px 10px;border-radius:6px;font-size:.75em;font-weight:bold;animation:buffPulse 1s infinite alternate}
@keyframes buffPulse{to{opacity:.7}}

@media(max-width:600px){
  #game{flex-direction:column}
  #cookie-area{flex:none;height:45vh}
  #shop{width:100%;flex:1;flex-direction:row;flex-wrap:wrap;overflow-y:auto;padding:6px;border-left:none;border-top:1px solid rgba(138,43,226,.2)}
  #shop h2{width:100%}
  .upgrade{flex:1 1 45%;min-width:140px}
  #cookie{width:min(45vw,200px);height:min(45vw,200px)}
}
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
  <script src="../game-audio.js"></script>
</head>
<body>
<a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,0.85);color:#4ecdc4;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none">‚¨Ö More Games at GameZipper.com</a>
<canvas id="magic-bg"></canvas>
<img class="idle-deco float" src="images/powerup_star.png" style="top:80px;left:10px;width:28px" alt="">
<img class="idle-deco float" src="images/powerup_bolt.png" style="top:180px;right:12px;width:24px;animation-delay:1s" alt="">
<img class="idle-deco spin" src="images/star_gold.png" style="bottom:80px;left:15px;width:20px" alt="">
<img class="idle-deco float" src="images/gem_blue.png" style="top:50%;left:8px;width:22px;animation-delay:2s" alt="">
<img class="idle-deco spin" src="images/ufo.png" style="top:100px;right:40px;width:36px;opacity:0.1" alt="">
<img class="idle-deco float" src="images/shield_gold.png" style="bottom:120px;right:10px;width:22px;animation-delay:0.5s" alt="">
<div id="header">
<h1>üß™ Alchemy Workshop</h1>
<div id="stats"><div>‚ö° Mana: <span id="count">0</span></div><div>MPS: <span id="cps">0</span></div><div id="prestige-stat" style="display:none">‚ôªÔ∏è <span id="plevel">0</span></div></div>
</div>
<div id="game">
<div id="cookie-area">
<div id="cookie"><img class="orb-sprite" src="images/orb_planet.png" alt=""></div>
<div id="golden-cookie">üß™</div>
</div>
<div id="shop"><h2>‚ú® Spellbook</h2></div>
</div>
<button id="achiev-btn" onclick="toggleAchievements()">üìñ Grimoire</button>
<button id="prestige-btn" onclick="doPrestige()" style="position:fixed;bottom:10px;left:120px;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:bold;z-index:100;font-size:.85em;box-shadow:0 0 10px rgba(245,158,11,.3);display:none">‚ôªÔ∏è Prestige</button>
<div id="buff-bar"></div>
<div id="achiev-panel" onclick="if(event.target===this)toggleAchievements()">
<div id="achiev-inner"><button id="achiev-close" onclick="toggleAchievements()">‚úï</button><h2>üìñ Arcane Achievements</h2><div id="achiev-list"></div></div>
</div>
<!-- Magic circle overlay -->
<canvas id="magic-circle" width="200" height="200"></canvas>
<script>
// Draw hexagram on magic circle canvas
(function(){
  const mc=document.getElementById('magic-circle');
  const mctx=mc.getContext('2d');
  mctx.translate(100,100);
  mctx.strokeStyle='#a78bfa';mctx.lineWidth=2;mctx.shadowColor='#a78bfa';mctx.shadowBlur=15;
  // Outer circle
  mctx.beginPath();mctx.arc(0,0,90,0,Math.PI*2);mctx.stroke();
  mctx.beginPath();mctx.arc(0,0,80,0,Math.PI*2);mctx.stroke();
  // Hexagram (two overlapping triangles)
  for(let t=0;t<2;t++){
    mctx.beginPath();
    for(let i=0;i<3;i++){
      const a=(i*2*Math.PI/3)-(Math.PI/2)+(t?Math.PI/3:0);
      const x=Math.cos(a)*70,y=Math.sin(a)*70;
      i===0?mctx.moveTo(x,y):mctx.lineTo(x,y);
    }
    mctx.closePath();mctx.stroke();
  }
  // Inner runes
  const runes=['‚ú¶','‚óá','‚ñ≥','‚ô¶','‚òÜ','‚úß'];
  mctx.font='14px serif';mctx.fillStyle='#a78bfa';mctx.textAlign='center';mctx.textBaseline='middle';
  for(let i=0;i<6;i++){
    const a=i*Math.PI/3-Math.PI/2;
    mctx.fillText(runes[i],Math.cos(a)*50,Math.sin(a)*50);
  }
})();

// Magic background particles
(function(){
  const c=document.getElementById('magic-bg');
  const ctx=c.getContext('2d');
  let particles=[];
  function resize(){
    const dpr=window.devicePixelRatio||1;
    c.width=window.innerWidth*dpr;c.height=window.innerHeight*dpr;
    c.style.width=window.innerWidth+'px';c.style.height=window.innerHeight+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize();window.addEventListener('resize',resize);
  // Init floating magic particles
  for(let i=0;i<40;i++){
    particles.push({
      x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,
      vx:(Math.random()-0.5)*0.3,vy:-0.2-Math.random()*0.3,
      r:1+Math.random()*2,alpha:0.2+Math.random()*0.4,
      color:['#a78bfa','#60a5fa','#c084fc','#818cf8','#e879f9'][Math.floor(Math.random()*5)],
      phase:Math.random()*Math.PI*2
    });
  }
  function draw(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    const t=performance.now()/1000;
    for(const p of particles){
      p.x+=p.vx+Math.sin(t+p.phase)*0.2;p.y+=p.vy;
      if(p.y<-10){p.y=window.innerHeight+10;p.x=Math.random()*window.innerWidth;}
      if(p.x<-10)p.x=window.innerWidth+10;
      if(p.x>window.innerWidth+10)p.x=-10;
      const flicker=0.5+0.5*Math.sin(t*2+p.phase);
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=p.color;ctx.globalAlpha=p.alpha*flicker;
      ctx.shadowColor=p.color;ctx.shadowBlur=8;
      ctx.fill();ctx.shadowBlur=0;
    }
    ctx.globalAlpha=1;
    requestAnimationFrame(draw);
  }
  draw();
})();

(function(){
const upgrades=[
  {name:'ü™Ñ Magic Wand',baseCost:10,cps:1,icon:'ü™Ñ',owned:0},
  {name:'üßô Apprentice',baseCost:100,cps:5,icon:'üßô',owned:0},
  {name:'üìñ Spell Book',baseCost:500,cps:20,icon:'üìñ',owned:0},
  {name:'‚öóÔ∏è Alchemy Lab',baseCost:2000,cps:100,icon:'‚öóÔ∏è',owned:0},
  {name:'üíé Crystal Mine',baseCost:10000,cps:500,icon:'üíé',owned:0},
  {name:'üè∞ Wizard Tower',baseCost:50000,cps:2000,icon:'üè∞',owned:0},
  {name:'üêâ Dragon Familiar',baseCost:250000,cps:8000,icon:'üêâ',owned:0},
  {name:'üåô Moon Portal',baseCost:1500000,cps:30000,icon:'üåô',owned:0},
  {name:'‚è≥ Time Rift',baseCost:10000000,cps:120000,icon:'‚è≥',owned:0},
  {name:'üåå Void Gate',baseCost:80000000,cps:500000,icon:'üåå',owned:0},
  {name:'üí´ Celestial Forge',baseCost:500000000,cps:2000000,icon:'üí´',owned:0},
  {name:'üîÆ Philosopher Stone',baseCost:5000000000,cps:10000000,icon:'üîÆ',owned:0}
];
let cookies=0,totalCookies=0,totalCps=0,lastSave=Date.now(),lastTick=Date.now();
let clickValue=1,cpsMultiplier=1,clickMultiplier=1;
const purchasedTypes=new Set();
const RUNE_SYMBOLS=['‚ú¶','‚úß','‚òÜ','‚óá','‚ñ≥','‚ô¶','‚ü°','‚äπ','‚ú∂','‚ãÜ'];

const actx=new(window.AudioContext||window.webkitAudioContext)();
function playClick(){const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.frequency.value=600;o.type='sine';g.gain.value=.12;o.start();o.frequency.exponentialRampToValueAtTime(900,actx.currentTime+0.05);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.12);o.stop(actx.currentTime+.12)}
function playBuy(){const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.type='triangle';o.frequency.value=523;g.gain.value=.2;o.start();o.frequency.exponentialRampToValueAtTime(1047,actx.currentTime+.15);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.2);o.stop(actx.currentTime+.2)}
function playAchievement(){const notes=[523,659,784,1047];notes.forEach((f,i)=>{const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.type='sine';o.frequency.value=f;g.gain.value=.15;o.start(actx.currentTime+i*.1);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+i*.1+.3);o.stop(actx.currentTime+i*.1+.3)})}
function playGolden(){const notes=[880,1108,1318,1568];notes.forEach((f,i)=>{const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.type='sine';o.frequency.value=f;g.gain.value=.12;o.start(actx.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+i*.08+.4);o.stop(actx.currentTime+i*.08+.4)})}
function playGoldenClick(){[1200,1500,1800].forEach((f,i)=>{const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.type='triangle';o.frequency.value=f;g.gain.value=.15;o.start(actx.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+i*.06+.25);o.stop(actx.currentTime+i*.06+.25)})}

let prestigeLevel=0,prestigeMultiplier=1;
const achievements=[
  {id:'first',name:'First Spark',desc:'Channel your first mana',icon:'‚ö°',check:()=>totalCookies>=1},
  {id:'hundred',name:'Mana Pool',desc:'Channel 100 mana',icon:'ü´ß',check:()=>totalCookies>=100},
  {id:'thousand',name:'Arcane Surge',desc:'Channel 1,000 mana',icon:'üåä',check:()=>totalCookies>=1000},
  {id:'tenk',name:'Mana Master',desc:'Channel 10,000 mana',icon:'üßô',check:()=>totalCookies>=10000},
  {id:'hundred_k',name:'Grand Wizard',desc:'Channel 100,000 mana',icon:'ü™Ñ',check:()=>totalCookies>=1e5},
  {id:'million',name:'Archmage',desc:'Channel 1,000,000 mana',icon:'üåü',check:()=>totalCookies>=1e6},
  {id:'ten_m',name:'Mana Overlord',desc:'Channel 10,000,000 mana',icon:'üëë',check:()=>totalCookies>=1e7},
  {id:'hundred_m',name:'Reality Bender',desc:'Channel 100,000,000 mana',icon:'üåÄ',check:()=>totalCookies>=1e8},
  {id:'billion',name:'Cosmic Sorcerer',desc:'Channel 1,000,000,000 mana',icon:'üåå',check:()=>totalCookies>=1e9},
  {id:'trillion',name:'Omnipotent',desc:'Channel 1,000,000,000,000 mana',icon:'üí•',check:()=>totalCookies>=1e12},
  {id:'speed',name:'Rapid Casting',desc:'Cast 10 times in 1 second',icon:'‚ö°',check:()=>false},
  {id:'grandma10',name:"Apprentice Guild",desc:'Recruit 10 Apprentices',icon:'üßô',check:()=>upgrades[1].owned>=10},
  {id:'factory5',name:'Lab Master',desc:'Own 5 Alchemy Labs',icon:'‚öóÔ∏è',check:()=>upgrades[3].owned>=5},
  {id:'cursor50',name:'Wand Collection',desc:'Own 50 Magic Wands',icon:'ü™Ñ',check:()=>upgrades[0].owned>=50},
  {id:'dragon1',name:'Dragon Tamer',desc:'Summon your first Dragon',icon:'üêâ',check:()=>upgrades[6].owned>=1},
  {id:'moon1',name:'Moonwalker',desc:'Open a Moon Portal',icon:'üåô',check:()=>upgrades[7].owned>=1},
  {id:'timerift1',name:'Time Lord',desc:'Create a Time Rift',icon:'‚è≥',check:()=>upgrades[8].owned>=1},
  {id:'void1',name:'Void Walker',desc:'Open a Void Gate',icon:'üåå',check:()=>upgrades[9].owned>=1},
  {id:'allTypes',name:'Full Curriculum',desc:'Own at least 1 of each spell',icon:'üåà',check:()=>upgrades.every(u=>u.owned>0)},
  {id:'golden3',name:'Potion Finder',desc:'Find 3 magic potions',icon:'üß™',check:()=>goldenClicks>=3},
  {id:'golden10',name:'Potion Master',desc:'Find 10 magic potions',icon:'üß™',check:()=>goldenClicks>=10},
  {id:'prestige1',name:'Rebirth',desc:'Perform your first Prestige',icon:'‚ôªÔ∏è',check:()=>prestigeLevel>=1},
  {id:'prestige5',name:'Eternal Return',desc:'Prestige 5 times',icon:'üîÑ',check:()=>prestigeLevel>=5}
];
const unlockedAch=new Set();
let goldenClicks=0;

function checkAchievements(){
  achievements.forEach(a=>{
    if(!unlockedAch.has(a.id)&&a.check()){
      unlockedAch.add(a.id);
      showToast(`üìñ ${a.name}: ${a.desc}`);
      playAchievement();
    }
  });
}

function showToast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),3000);
}

const clickTimes=[];
function trackSpeed(){
  const now=Date.now();clickTimes.push(now);
  while(clickTimes.length>0&&now-clickTimes[0]>1000)clickTimes.shift();
  if(clickTimes.length>=10&&!unlockedAch.has('speed')){
    unlockedAch.add('speed');showToast('üìñ Rapid Casting: 10 casts in 1 second!');playAchievement();
  }
}

function toggleAchievements(){
  const p=document.getElementById('achiev-panel');p.classList.toggle('show');
  if(p.classList.contains('show'))renderAchievements();
}
window.toggleAchievements=toggleAchievements;

function renderAchievements(){
  const list=document.getElementById('achiev-list');
  list.innerHTML=achievements.map(a=>`<div class="achiev-item ${unlockedAch.has(a.id)?'':'locked'}"><span class="a-icon">${a.icon}</span><div class="a-info"><div class="a-name">${a.name} ${unlockedAch.has(a.id)?'‚úÖ':''}</div><div class="a-desc">${a.desc}</div></div></div>`).join('');
}

let goldenTimer=null;
function scheduleGolden(){const delay=(30+Math.random()*90)*1000;goldenTimer=setTimeout(spawnGolden,delay);}
function spawnGolden(){
  const gc=document.getElementById('golden-cookie');
  const area=document.getElementById('cookie-area');
  const ar=area.getBoundingClientRect();
  gc.style.left=Math.random()*(ar.width-60)+'px';
  gc.style.top=Math.random()*(ar.height-60)+'px';
  gc.style.display='block';playGolden();
  const beam=document.createElement('div');beam.className='light-beam';
  beam.style.left=(parseFloat(gc.style.left)+25)+'px';beam.style.height='0';
  area.appendChild(beam);setTimeout(()=>beam.remove(),600);
  const hideTimer=setTimeout(()=>{gc.style.display='none';scheduleGolden()},10000);
  gc.onclick=function(e){
    e.stopPropagation();gc.style.display='none';clearTimeout(hideTimer);
    goldenClicks++;playGoldenClick();triggerGoldenEffect();checkAchievements();scheduleGolden();
  };
}

function triggerGoldenEffect(){
  const r=Math.random();
  if(r<0.33){
    cpsMultiplier=2;showToast('üåü Arcane Frenzy! 2x MPS for 30 seconds!');
    showBuff('2x MPS',30000);setTimeout(()=>{cpsMultiplier=1},30000);
  }else if(r<0.66){
    const bonus=Math.max(totalCps*60,100);
    cookies+=bonus;totalCookies+=bonus;
    showToast('üåü Mana Surge! +'+fmt(bonus)+' mana!');
  }else{
    clickMultiplier=10;showToast('üåü Power Channeling! 10x clicks for 15 seconds!');
    showBuff('10x Cast',15000);setTimeout(()=>{clickMultiplier=1},15000);
  }
}

function showBuff(text,duration){
  const bar=document.getElementById('buff-bar');
  const tag=document.createElement('div');tag.className='buff-tag';tag.textContent=text;
  bar.appendChild(tag);setTimeout(()=>tag.remove(),duration);
}

// Show magic circle on purchase
function showMagicCircle(){
  const mc=document.getElementById('magic-circle');
  mc.classList.remove('show');void mc.offsetWidth;mc.classList.add('show');
  setTimeout(()=>mc.classList.remove('show'),800);
}

function fmt(n){if(n>=1e12)return(n/1e12).toFixed(1)+'T';if(n>=1e9)return(n/1e9).toFixed(1)+'B';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return Math.floor(n).toString()}
function cost(u){return Math.floor(u.baseCost*Math.pow(1.15,u.owned))}
function calcCps(){totalCps=upgrades.reduce((s,u)=>s+u.cps*u.owned,0)*prestigeMultiplier}

// Prestige system
function canPrestige(){return totalCookies>=1e6}
function prestigeGain(){return Math.max(1,Math.floor(Math.pow(totalCookies/1e6,0.5)))}
function doPrestige(){
  if(!canPrestige())return;
  const gain=prestigeGain();
  prestigeLevel+=gain;prestigeMultiplier=1+prestigeLevel*0.1;
  cookies=0;totalCookies=0;
  upgrades.forEach(u=>u.owned=0);
  purchasedTypes.clear();calcCps();
  showToast(`‚ôªÔ∏è Prestige! +${gain} levels ‚Üí ${prestigeMultiplier.toFixed(1)}x multiplier`);
  playAchievement();checkAchievements();updateUI();save();
}
window.doPrestige=doPrestige;

const cookieEl=document.getElementById('cookie');
cookieEl.addEventListener('click',function(e){
  if(actx.state==='suspended')actx.resume();
  const val=clickValue*clickMultiplier*prestigeMultiplier;
  cookies+=val;totalCookies+=val;
  playClick();trackSpeed();
  cookieEl.classList.remove('bounce');void cookieEl.offsetWidth;cookieEl.classList.add('bounce');
  // Rune particles
  const r=cookieEl.getBoundingClientRect();
  const cx=r.left+r.width/2,cy=r.top+r.height/2;
  for(let i=0;i<6;i++){
    const rn=document.createElement('div');rn.className='rune';
    rn.textContent=RUNE_SYMBOLS[Math.floor(Math.random()*RUNE_SYMBOLS.length)];
    rn.style.left=(cx+Math.random()*60-30)+'px';rn.style.top=(cy+Math.random()*40-20)+'px';
    rn.style.fontSize=(16+Math.random()*10)+'px';
    document.body.appendChild(rn);setTimeout(()=>rn.remove(),800);
  }
  const countEl=document.getElementById('count');
  countEl.classList.remove('score-bounce');void countEl.offsetWidth;countEl.classList.add('score-bounce');
  const ft=document.createElement('div');ft.className='float-text';ft.textContent='+'+fmt(val);
  ft.style.left=(r.left+r.width/2-10+Math.random()*40-20)+'px';
  ft.style.top=(r.top-10)+'px';ft.style.position='fixed';
  document.body.appendChild(ft);setTimeout(()=>ft.remove(),800);
  checkAchievements();updateUI();
});

const shopEl=document.getElementById('shop');
function renderShop(){
  const existing=shopEl.querySelectorAll('.upgrade');
  if(existing.length===0){
    upgrades.forEach((u,i)=>{
      const d=document.createElement('div');d.className='upgrade';d.dataset.idx=i;
      d.innerHTML=`<span class="owned" id="own${i}">0</span><div class="name">${u.name}</div><div class="info">+${u.cps}/s | Cost: <span id="cost${i}">${fmt(cost(u))}</span></div>`;
      d.addEventListener('click',()=>buy(i));shopEl.appendChild(d);
    });
  }
  upgrades.forEach((u,i)=>{
    const c=cost(u);const el=shopEl.children[i+1];
    el.className='upgrade'+(cookies>=c?' affordable':' locked');
    document.getElementById('cost'+i).textContent=fmt(c);
    document.getElementById('own'+i).textContent=u.owned;
  });
}

function buy(i){
  const u=upgrades[i],c=cost(u);if(cookies<c)return;
  cookies-=c;u.owned++;calcCps();playBuy();
  purchasedTypes.add(i);
  // Magic circle effect
  showMagicCircle();
  // Purple flash
  const gf=document.createElement('div');gf.className='gold-flash';
  document.body.appendChild(gf);setTimeout(()=>gf.remove(),400);
  checkAchievements();updateUI();
}

let displayedCps=0;
function updateUI(){
  document.getElementById('count').textContent=fmt(cookies);
  const targetCps=totalCps*cpsMultiplier;
  if(displayedCps!==targetCps){
    const diff=targetCps-displayedCps;
    displayedCps+=diff>0?Math.max(1,Math.ceil(diff/10)):-Math.max(1,Math.ceil(-diff/10));
    if(Math.abs(displayedCps-targetCps)<2)displayedCps=targetCps;
  }
  document.getElementById('cps').textContent=fmt(displayedCps);
  // Prestige button
  const pBtn=document.getElementById('prestige-btn');
  if(pBtn){if(canPrestige()){pBtn.style.display='block';pBtn.textContent='‚ôªÔ∏è Prestige (+'+prestigeGain()+')';}else{pBtn.style.display='none';}}
  const pStat=document.getElementById('prestige-stat');
  if(pStat&&prestigeLevel>0){pStat.style.display='';document.getElementById('plevel').textContent=prestigeLevel+' ('+prestigeMultiplier.toFixed(1)+'x)';}
  renderShop();
}

function tick(){
  const now=Date.now();const dt=(now-lastTick)/1000;lastTick=now;
  const earned=totalCps*cpsMultiplier*dt;
  cookies+=earned;totalCookies+=earned;
  if(now-lastSave>10000){save();lastSave=now}
  updateUI();checkAchievements();requestAnimationFrame(tick);
}

function save(){
  const d={cookies,totalCookies,upgrades:upgrades.map(u=>u.owned),time:Date.now(),types:[...purchasedTypes],achievements:[...unlockedAch],goldenClicks,prestigeLevel,prestigeMultiplier};
  localStorage.setItem('idleCookie',JSON.stringify(d));
}
function load(){
  try{
    const d=JSON.parse(localStorage.getItem('idleCookie'));if(!d)return;
    d.upgrades.forEach((n,i)=>{upgrades[i].owned=n});
    cookies=d.cookies||0;totalCookies=d.totalCookies||cookies;
    if(d.types)d.types.forEach(t=>purchasedTypes.add(t));
    if(d.achievements)d.achievements.forEach(a=>unlockedAch.add(a));
    if(d.goldenClicks)goldenClicks=d.goldenClicks;
    if(d.prestigeLevel){prestigeLevel=d.prestigeLevel;prestigeMultiplier=d.prestigeMultiplier||1+prestigeLevel*0.1;}
    calcCps();
    if(d.time&&totalCps>0){
      const away=(Date.now()-d.time)/1000;
      if(away>5){const earned=totalCps*away;cookies+=earned;totalCookies+=earned;
        setTimeout(()=>alert('Welcome back! You channeled '+fmt(earned)+' mana while away ('+Math.floor(away/60)+' min).'),300);}
    }
  }catch(e){}
}

load();updateUI();requestAnimationFrame(tick);scheduleGolden();
window.addEventListener('beforeunload',save);
})();
</script>
<div id="tutorial-overlay" style="position:fixed;inset:0;pointer-events:auto;background:rgba(10,5,20,0.9);display:flex;align-items:center;justify-content:center;z-index:999999">
<div style="background:rgba(30,10,50,0.95);border:2px solid rgba(138,43,226,.4);border-radius:20px;padding:36px 28px;max-width:340px;text-align:center;color:#e0d0ff;box-shadow:0 0 30px rgba(124,58,237,0.3)">
<div style="font-size:56px;margin-bottom:12px">üîÆ</div>
<h2 style="font-size:24px;color:#a78bfa;margin-bottom:16px">How to Play</h2>
<p style="font-size:16px;line-height:1.9;text-align:left;color:#c0b0e0">
üëÜ Tap the crystal orb to <b>channel mana</b>!<br>
üõí Buy spells to <b>auto-channel</b> more<br>
üß™ Watch for <b>Magic Potions</b> ‚Äî tap for bonuses!<br>
üìñ Unlock arcane achievements!
</p>
<p style="font-size:14px;color:#8070a0;margin-top:12px">üí§ Tip: Mana keeps flowing even when you're away!</p>
<button  onmousedown="var o=document.getElementById('tutorial-overlay');if(o)o.remove();var c=document.getElementById('gameCanvas')||document.querySelector('canvas');if(c)c.style.pointerEvents='auto';" style="touch-action:manipulation;cursor:pointer;position:relative;z-index:10000000;margin-top:20px;padding:14px 36px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;cursor:pointer;font-weight:bold;box-shadow:0 0 15px rgba(124,58,237,.4);cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;touch-action:manipulation;cursor:pointer;position:relative;z-index:10000000;margin-top:20px;padding:14px 36px;font-size:18px;border:none;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:#fff;cursor:pointer;font-weight:bold;box-shadow:0 0 15px rgba(124,58,237,.4)" >Got it! üîÆ</button>"
</div></div>
<script>if(localStorage.getItem('tutorial_idle'))document.getElementById('tutorial-overlay').remove();</script>
<script>
(function(){
  var ov = document.getElementById('tutorial-overlay');
  if (!ov) return;
  
  // Get canvas for pointer-events reset
  var cvs = document.getElementById('gameCanvas') || document.querySelector('canvas');
  
  // Â¶ÇÊûúÂ∑≤ÊòæÁ§∫ËøátutorialÔºåÁßªÈô§overlay
  if (localStorage.getItem('tutorial-seen-' + window.location.pathname)) {
    ov.remove();
    return;
  }
  
  // ËÆæÁΩÆoverlayÁöÑÂÖ®Â±èclick/touch‰∫ã‰ª∂ÂÖ≥Èó≠
  var closeTut = function(e) {
    e && e.preventDefault && e.preventDefault();
    e && e.stopPropagation && e.stopPropagation();
    if (cvs) cvs.style.pointerEvents = 'auto';
    ov.remove();
    localStorage.setItem('tutorial-seen-' + window.location.pathname, '1');
  };
  
  // Â§öÁßç‰∫ã‰ª∂Â§ÑÁêÜ
  ov.addEventListener('click', closeTut, true);
  ov.addEventListener('touchend', closeTut, true);
  ov.addEventListener('pointerdown', closeTut, true);
  
  // Disable canvas events during tutorial
  if (cvs) cvs.style.pointerEvents = 'none';
})();
</script>
  <script src="../game-audio-auto.js"></script>
</body>
</html>
