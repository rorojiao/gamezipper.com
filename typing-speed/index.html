<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typing Speed Test - Free Online WPM Typing Game | GameZipper</title>
<meta name="description" content="Test your typing speed with this free online typing game. Measure your WPM and accuracy in 30s, 60s, or survival mode. How fast can you type?">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#00ff41;font-family:'Courier New',monospace;min-height:100vh;display:flex;flex-direction:column;align-items:center;position:relative;overflow-x:hidden}
#matrix-bg{position:fixed;inset:0;z-index:0;pointer-events:none}
.topbar{width:100%;background:rgba(0,10,0,0.9);padding:10px 16px;text-align:center;position:sticky;top:0;z-index:100;border-bottom:1px solid #003300}
.topbar a{color:#00ff41;text-decoration:none;font-size:14px;font-weight:600;font-family:'Courier New',monospace}
.topbar a:hover{color:#33ff66;text-shadow:0 0 10px #00ff41}
.container{width:100%;max-width:800px;padding:20px 16px;flex:1;position:relative;z-index:1}
h1{text-align:center;font-size:28px;margin:16px 0 8px;color:#00ff41;text-shadow:0 0 20px rgba(0,255,65,0.5);font-family:'Courier New',monospace;letter-spacing:2px}
.subtitle{text-align:center;color:#008020;margin-bottom:24px;font-size:14px;font-family:'Courier New',monospace}
.mode-bar{display:flex;gap:8px;justify-content:center;margin-bottom:24px;flex-wrap:wrap}
.mode-btn{padding:10px 24px;border:1px solid #003300;background:rgba(0,10,0,0.8);color:#008020;border-radius:4px;cursor:pointer;font-size:15px;font-weight:600;transition:all .2s;font-family:'Courier New',monospace}
.mode-btn::before{content:'> '}
.mode-btn:hover{border-color:#00ff41;color:#00ff41;text-shadow:0 0 8px #00ff41}
.mode-btn.active{border-color:#00ff41;background:rgba(0,30,0,0.8);color:#00ff41;box-shadow:0 0 15px rgba(0,255,65,0.2);text-shadow:0 0 10px #00ff41}
.stats-bar{display:flex;justify-content:space-around;margin-bottom:20px;padding:12px;background:rgba(0,10,0,0.8);border-radius:4px;border:1px solid #003300}
.stat{text-align:center}
.stat-val{font-size:28px;font-weight:700;color:#00ff41;text-shadow:0 0 10px rgba(0,255,65,0.5);font-family:'Courier New',monospace;animation:ledFlicker 3s ease-in-out infinite}
@keyframes ledFlicker{0%,100%{opacity:1}50%{opacity:0.85}}
.stat-label{font-size:11px;color:#005500;text-transform:uppercase;letter-spacing:2px}
.text-display{background:rgba(0,10,0,0.8);border-radius:4px;padding:24px;font-size:20px;line-height:1.8;max-height:calc(1.8em * 3 + 48px);min-height:calc(1.8em * 3 + 48px);overflow:hidden;border:1px solid #003300;margin-bottom:20px;position:relative;user-select:none;-webkit-user-select:none;font-family:'Courier New',monospace;word-wrap:break-word;overflow-wrap:break-word;scroll-behavior:smooth}
.char{transition:color .1s}
.char.correct{color:#005500}
.char.current{color:#00ff41;background:rgba(0,255,65,.15);border-radius:2px;text-shadow:0 0 8px #00ff41}
.char.wrong{color:#ff0040;animation:glitch .1s;text-shadow:0 0 8px #ff0040}
.char.upcoming{color:#003300}
.char.word-complete{animation:wordPulse 0.3s ease-out}
@keyframes glitch{0%{transform:translate(2px,-1px);filter:hue-rotate(90deg)}50%{transform:translate(-2px,1px);filter:hue-rotate(-90deg)}100%{transform:translate(0);filter:none}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}
@keyframes wordPulse{0%{text-shadow:0 0 5px #00ff41}50%{text-shadow:0 0 20px #00ff41,0 0 40px #00ff41}100%{text-shadow:0 0 0}}
.input-area{width:100%;padding:14px 18px;font-size:18px;background:rgba(0,10,0,0.9);border:1px solid #00ff41;border-radius:4px;color:#00ff41;outline:none;transition:all .2s;font-family:'Courier New',monospace;caret-color:#00ff41;box-shadow:0 0 10px rgba(0,255,65,0.1)}
.input-area:focus{border-color:#33ff66;box-shadow:0 0 20px rgba(0,255,65,0.3)}
.input-area::placeholder{color:#005500}
.mobile-hint{display:none;text-align:center;color:#005500;font-size:13px;margin-top:8px}
.result-card{display:none;background:rgba(0,10,0,0.9);border-radius:8px;padding:32px;text-align:center;border:1px solid #003300;margin-top:20px}
.result-card h2{font-size:24px;margin-bottom:20px;color:#00ff41;text-shadow:0 0 15px rgba(0,255,65,0.5)}
.result-rank{font-size:64px;margin:16px 0}
.result-rank-name{font-size:22px;font-weight:700;margin-bottom:20px;font-family:'Courier New',monospace}
.result-stats{display:flex;justify-content:center;gap:32px;margin:20px 0;flex-wrap:wrap}
.result-stat{text-align:center}
.result-stat .val{font-size:36px;font-weight:700;color:#00ff41;text-shadow:0 0 10px rgba(0,255,65,0.5)}
.result-stat .lbl{font-size:12px;color:#005500;text-transform:uppercase;letter-spacing:1px}
.restart-btn{margin-top:20px;padding:12px 32px;background:rgba(0,30,0,0.8);color:#00ff41;border:1px solid #00ff41;border-radius:4px;font-size:16px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'Courier New',monospace;text-shadow:0 0 8px rgba(0,255,65,0.5)}
.restart-btn:hover{background:rgba(0,50,0,0.8);box-shadow:0 0 20px rgba(0,255,65,0.3)}
.restart-btn:active{transform:scale(.97)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;justify-content:center;align-items:center}
.overlay.show{display:flex}
.modal{background:rgba(0,10,0,0.95);border-radius:8px;padding:32px;max-width:440px;width:90%;border:1px solid #003300;text-align:center;font-family:'Courier New',monospace}
.modal h2{font-size:22px;margin-bottom:16px;color:#00ff41;text-shadow:0 0 15px rgba(0,255,65,0.5)}
.modal p,.modal li{color:#008020;font-size:15px;line-height:1.7;text-align:left}
.modal ol{padding-left:20px;margin:12px 0}
.modal .tip{background:rgba(0,20,0,0.8);padding:10px 14px;border-radius:4px;margin-top:12px;font-size:14px;color:#005500;border:1px solid #002200}
.modal button{margin-top:20px;padding:10px 28px;background:rgba(0,30,0,0.8);color:#00ff41;border:1px solid #00ff41;border-radius:4px;font-size:15px;cursor:pointer;font-weight:600;font-family:'Courier New',monospace}
.start-msg{text-align:center;color:#005500;font-size:16px;padding:32px 0}

/* Green flash for new record */
#green-flash{position:fixed;inset:0;background:rgba(0,255,65,0.2);pointer-events:none;z-index:50;opacity:0;transition:opacity 0.15s}
#green-flash.active{opacity:1}
#record-text{position:fixed;top:30%;left:50%;transform:translate(-50%,-50%) scale(0);font-size:36px;font-weight:900;color:#00ff41;text-shadow:0 0 30px #00ff41;z-index:51;pointer-events:none;opacity:0;font-family:'Courier New',monospace}
#record-text.show{animation:recordPop 1s cubic-bezier(0.175,0.885,0.32,1.275) forwards}
@keyframes recordPop{0%{transform:translate(-50%,-50%) scale(0);opacity:0}50%{transform:translate(-50%,-50%) scale(1.3);opacity:1}100%{transform:translate(-50%,-50%) scale(1);opacity:0}}

/* Correct char green lines */
.green-line{position:fixed;height:2px;background:linear-gradient(90deg,transparent,#00ff41,transparent);pointer-events:none;z-index:50;animation:lineFlash 0.2s ease-out forwards}
@keyframes lineFlash{0%{opacity:1;width:0}50%{opacity:1;width:100px}100%{opacity:0;width:150px}}
.green-line.left{animation:lineFlashLeft 0.2s ease-out forwards}
@keyframes lineFlashLeft{0%{opacity:1;width:0;transform:translateX(0)}50%{opacity:1;width:100px;transform:translateX(-100px)}100%{opacity:0;width:150px;transform:translateX(-150px)}}

/* Sprite decorations */
.deco-ship{position:fixed;z-index:0;opacity:0.15;pointer-events:none}
.deco-ship.left{top:120px;left:10px;width:48px;animation:shipFloat 4s ease-in-out infinite}
.deco-ship.right{top:200px;right:10px;width:48px;animation:shipFloat 4s ease-in-out infinite reverse}
@keyframes shipFloat{0%,100%{transform:translateY(0) rotate(-5deg)}50%{transform:translateY(-20px) rotate(5deg)}}
.deco-star{position:fixed;z-index:0;opacity:0.2;pointer-events:none;animation:starTwinkle 2s ease-in-out infinite}
@keyframes starTwinkle{0%,100%{opacity:0.15;transform:scale(1)}50%{opacity:0.35;transform:scale(1.2)}}
.deco-powerup{position:fixed;z-index:0;opacity:0.12;pointer-events:none;animation:powerupSpin 6s linear infinite}
@keyframes powerupSpin{to{transform:rotate(360deg)}}
/* Button with sprite background */
.mode-btn{background-image:url('images/btn_blue.png');background-size:100% 100%;background-repeat:no-repeat;background-color:transparent}
.mode-btn.active{background-image:url('images/btn_green.png')}
.restart-btn{background-image:url('images/btn_green.png');background-size:100% 100%;background-repeat:no-repeat;background-color:transparent}
.stats-bar{background-image:url('images/panel_grey.png');background-size:100% 100%;background-repeat:no-repeat}
.text-display{background-image:url('images/panel_blue.png');background-size:100% 100%;background-repeat:no-repeat}
@media(max-width:600px){
  h1{font-size:22px}
  .text-display{font-size:17px;padding:16px}
  .stat-val{font-size:22px}
  .mobile-hint{display:block}
  .result-stats{gap:16px}
  .result-stat .val{font-size:28px}
}
</style>
  <script src="../game-audio.js"></script>
</head>
<body>
<canvas id="matrix-bg"></canvas>
<img src="images/ship.png" class="deco-ship left" alt="">
<img src="images/ship.png" class="deco-ship right" alt="" style="transform:scaleX(-1)">
<img src="images/star.png" class="deco-star" style="top:80px;right:60px;width:24px" alt="">
<img src="images/star.png" class="deco-star" style="top:300px;left:30px;width:20px;animation-delay:0.7s" alt="">
<img src="images/star.png" class="deco-star" style="bottom:100px;right:40px;width:16px;animation-delay:1.3s" alt="">
<img src="images/powerup.png" class="deco-powerup" style="bottom:60px;left:20px;width:32px" alt="">
<img src="images/meteor.png" class="deco-powerup" style="top:400px;right:15px;width:28px;animation-delay:2s" alt="">
<div id="green-flash"></div>
<div id="record-text">NEW RECORD!</div>
<div class="topbar"><a href="https://gamezipper.com/">‚¨Ö More Games at GameZipper.com</a></div>
<div class="container">
  <h1>‚ö° TYPING_SPEED_TEST</h1>
  <p class="subtitle">[SYSTEM] How fast can you hack?</p>
  <div class="mode-bar">
    <button class="mode-btn active" data-mode="30">30s</button>
    <button class="mode-btn" data-mode="60">60s</button>
    <button class="mode-btn" data-mode="survival">survival</button>
  </div>
  <div class="stats-bar">
    <div class="stat"><div class="stat-val" id="wpm">0</div><div class="stat-label">WPM</div></div>
    <div class="stat"><div class="stat-val" id="accuracy">100%</div><div class="stat-label">Accuracy</div></div>
    <div class="stat"><div class="stat-val" id="timer">--</div><div class="stat-label" id="timer-label">Time</div></div>
  </div>
  <div class="text-display" id="textDisplay"><div class="start-msg">[AWAITING INPUT] Start typing to begin...</div></div>
  <input class="input-area" id="inputArea" placeholder="> start typing here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="latin">
  <p class="mobile-hint">üì± Tap the input box to open your keyboard</p>
  <div class="result-card" id="resultCard">
    <h2>üèÅ [TRANSMISSION COMPLETE]</h2>
    <div class="result-rank" id="resultEmoji"></div>
    <div class="result-rank-name" id="resultRank" style="animation:ledFlicker 2s ease-in-out infinite"></div>
    <div class="result-stats">
      <div class="result-stat"><div class="val" id="rWpm">0</div><div class="lbl">WPM</div></div>
      <div class="result-stat"><div class="val" id="rAcc">0%</div><div class="lbl">Accuracy</div></div>
      <div class="result-stat"><div class="val" id="rChars">0</div><div class="lbl">Characters</div></div>
    </div>
    <button class="restart-btn" id="restartBtn">> TRY AGAIN</button>
  </div>
</div>
<div class="overlay" id="tutorialOverlay">
  <div class="modal">
    <h2>‚å®Ô∏è [INSTRUCTIONS]</h2>
    <ol>
      <li>Choose a time mode (<b>&gt; 30s</b>, <b>&gt; 60s</b>, or <b>&gt; survival</b>)</li>
      <li>Type the words shown on screen as fast as you can!</li>
      <li>Your speed (WPM) and accuracy are tracked in real-time</li>
    </ol>
    <p style="margin-top:8px"><b>Survival mode:</b> No time limit, but 3 mistakes and you're out! ‚ùå‚ùå‚ùå</p>
    <div class="tip">üí° [TIP] Focus on accuracy first ‚Äî speed comes with practice! üéØ</div>
    <button id="tutorialClose">> GOT IT</button>
  </div>
</div>
<script>
// Matrix rain background
(function(){
  const canvas=document.getElementById('matrix-bg');
  const ctx=canvas.getContext('2d');
  let W,H;
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥0123456789';
  let columns=[];
  let fontSize=14;
  let rainSpeed=1;
  let density=1;

  function resize(){
    W=window.innerWidth;H=window.innerHeight;
    canvas.width=W;canvas.height=H;
    const colCount=Math.floor(W/fontSize);
    columns=[];
    for(let i=0;i<colCount;i++){
      columns.push({y:Math.random()*H,speed:0.5+Math.random()*1.5,chars:[]});
    }
  }

  function draw(){
    ctx.fillStyle='rgba(0,0,0,0.05)';
    ctx.fillRect(0,0,W,H);
    ctx.font=fontSize+'px monospace';
    
    for(let i=0;i<columns.length;i++){
      const col=columns[i];
      const char=chars[Math.floor(Math.random()*chars.length)];
      const x=i*fontSize;
      
      // Bright head
      ctx.fillStyle='#00ff41';
      ctx.globalAlpha=0.9;
      ctx.fillText(char,x,col.y);
      
      // Dimmer trail
      ctx.fillStyle='#008020';
      ctx.globalAlpha=0.4*density;
      const trailChar=chars[Math.floor(Math.random()*chars.length)];
      ctx.fillText(trailChar,x,col.y-fontSize);
      
      ctx.globalAlpha=1;
      
      col.y+=col.speed*fontSize*rainSpeed;
      if(col.y>H+100){
        col.y=-fontSize;
        col.speed=0.5+Math.random()*1.5;
      }
    }
    requestAnimationFrame(draw);
  }

  // Expose for end-game flood effect
  window.matrixFlood=function(){
    rainSpeed=3;density=2;
    setTimeout(()=>{rainSpeed=1;density=1;},500);
  };

  window.addEventListener('resize',resize);
  resize();
  draw();
})();

// Main game
(function(){
const WORDS_EASY=["the","be","to","of","and","a","in","it","for","not","on","he","as","you","do","at","but","by","we","or","an","my","one","all","so","up","out","if","who","go","me","no","him","see","now","its","how","our","two","new","day","us","old","big","own","try","run","let","set","end"];
const WORDS_MED=["that","have","this","from","they","say","will","would","there","their","what","about","which","when","make","time","just","know","take","people","into","year","good","some","could","them","other","than","then","look","only","come","over","think","also","back","after","work","first","well","even","want","give","most","find","here","thing","many","long","world","very","life","hand","high","place","while","last","might","home","never","best","same","keep","help","start","part","small","night","close","live","every","name","play","move","feel","house","again","turn","show","open","must","write","both","next","word","food","kind","tell","left","right","line","need","hard","fast","real","city","hold","power","grow","talk","wait","sure","fire"];
const WORDS_HARD=["between","because","change","study","learn","water","earth","group","stand","plan","warm","free","cool","head","sound","story","light","early","build","watch","care","rest","area","draw","step","clear","team","class","color","white","paper","music","bring","child","game","dark","deep","mean","land","blue","green","happy","full","side","form","love","stop","state","done","level","front","wide","able","final","began","south","born","note","west","space","power","young","quick","under","group","world","write","point","study","still","could","while","would","their","about","those","might","every","house","after","first","story","human","earth","great","right","level","along","often","place","young"];
const WORDS=WORDS_EASY.concat(WORDS_MED).concat(WORDS_HARD); // fallback
let mode="30",timeLeft=30,running=false,finished=false,startTime=0;
let charIndex=0,correct=0,wrong=0,totalTyped=0,survivalErrors=0;
let text="",timerInterval=null;
let bestWpm=parseInt(localStorage.getItem('typing_best_wpm')||'0');
let lastWordEnd=0;
const $d=id=>document.getElementById(id);
const display=$d("textDisplay"),input=$d("inputArea"),wpmEl=$d("wpm"),accEl=$d("accuracy"),timerEl=$d("timer"),timerLbl=$d("timer-label");
const resultCard=$d("resultCard"),rWpm=$d("rWpm"),rAcc=$d("rAcc"),rChars=$d("rChars"),rEmoji=$d("resultEmoji"),rRank=$d("resultRank");

const actx=new(window.AudioContext||window.webkitAudioContext)();
function playTick(){const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.frequency.value=1200;g.gain.value=.06;o.start();g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.03);o.stop(actx.currentTime+.03)}
function playBuzz(){const o=actx.createOscillator(),g=actx.createGain();o.type="sawtooth";o.connect(g);g.connect(actx.destination);o.frequency.value=150;g.gain.value=.12;o.start();g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.1);o.stop(actx.currentTime+.1)}
function playCountdown(){const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.frequency.value=1000;g.gain.value=.1;o.start();g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.08);o.stop(actx.currentTime+.08)}
function playCheer(){[523,659,784,1047].forEach((f,i)=>{const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.frequency.value=f;g.gain.value=.08;o.start(actx.currentTime+i*.12);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+i*.12+.3);o.stop(actx.currentTime+i*.12+.3)})}
function playWordComplete(){const o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);o.type='sine';o.frequency.value=880;g.gain.value=.06;o.start();g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+.1);o.stop(actx.currentTime+.1)}

let currentWpm=0;
function genText(){
  let w=[];
  // Adaptive word selection based on current typing speed
  for(let i=0;i<60;i++){
    let pool;
    if(currentWpm<25) pool=WORDS_EASY;
    else if(currentWpm<50) pool=Math.random()<0.6?WORDS_MED:WORDS_EASY;
    else if(currentWpm<70) pool=Math.random()<0.5?WORDS_HARD:WORDS_MED;
    else pool=Math.random()<0.7?WORDS_HARD:WORDS_MED;
    w.push(pool[Math.random()*pool.length|0]);
  }
  return w.join(" ");
}
function renderText(){
  let html="";
  for(let i=0;i<text.length;i++){
    let cls="upcoming";
    if(i<charIndex)cls="correct";
    if(i===charIndex)cls="current";
    html+=`<span class="char ${cls}" data-i="${i}">${text[i]===" "?"&nbsp;":text[i]}</span>`;
  }
  display.innerHTML=html;
}

function spawnGreenLines(el){
  if(!el)return;
  const rect=el.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const cy=rect.top+rect.height/2;
  // Right line
  const r=document.createElement('div');
  r.className='green-line';
  r.style.cssText=`left:${cx}px;top:${cy}px;`;
  document.body.appendChild(r);
  setTimeout(()=>r.remove(),200);
  // Left line
  const l=document.createElement('div');
  l.className='green-line left';
  l.style.cssText=`left:${cx}px;top:${cy}px;`;
  document.body.appendChild(l);
  setTimeout(()=>l.remove(),200);
}

function reset(){
  running=false;finished=false;charIndex=0;correct=0;wrong=0;totalTyped=0;survivalErrors=0;lastWordEnd=0;
  clearInterval(timerInterval);
  text=genText();
  if(mode==="survival"){timeLeft=0;timerLbl.textContent="Errors";timerEl.textContent="0/3"}
  else{timeLeft=parseInt(mode);timerLbl.textContent="Time";timerEl.textContent=timeLeft}
  wpmEl.textContent="0";accEl.textContent="100%";
  resultCard.style.display="none";input.value="";input.disabled=false;
  renderText();input.focus();
}

function startTimer(){
  if(mode==="survival"){startTime=Date.now();running=true;timerInterval=setInterval(updateStats,500);return}
  startTime=Date.now();running=true;
  timerInterval=setInterval(()=>{
    const elapsed=(Date.now()-startTime)/1000|0;
    timeLeft=Math.max(0,parseInt(mode)-elapsed);
    timerEl.textContent=timeLeft;
    if(timeLeft<=5&&timeLeft>0)playCountdown();
    if(timeLeft<=0)endGame();
    updateStats();
  },500);
}

function updateStats(){
  const elapsed=Math.max((Date.now()-startTime)/1000,1);
  const wpm=Math.round((correct/5)/(elapsed/60))||0;
  currentWpm=wpm;
  const acc=totalTyped?Math.round(correct/totalTyped*100):100;
  wpmEl.textContent=wpm;accEl.textContent=acc+"%";
  
  // Check for new record
  if(wpm>bestWpm&&wpm>10&&running){
    bestWpm=wpm;
    localStorage.setItem('typing_best_wpm',bestWpm);
    const flash=$d('green-flash');
    flash.classList.add('active');
    setTimeout(()=>flash.classList.remove('active'),200);
    const rt=$d('record-text');
    rt.className='show';
    setTimeout(()=>{rt.className=''},1000);
  }
}

function endGame(){
  finished=true;running=false;clearInterval(timerInterval);
  input.disabled=true;playCheer();
  // Matrix flood effect
  if(window.matrixFlood)window.matrixFlood();
  
  const elapsed=Math.max((Date.now()-startTime)/1000,1);
  const wpm=Math.round((correct/5)/(elapsed/60))||0;
  const acc=totalTyped?Math.round(correct/totalTyped*100):100;
  rWpm.textContent=wpm;rAcc.textContent=acc+"%";rChars.textContent=correct;
  let emoji,rank;
  if(wpm<20){emoji="üê¢";rank="[LEVEL: TURTLE]"}
  else if(wpm<40){emoji="üê∞";rank="[LEVEL: RABBIT]"}
  else if(wpm<60){emoji="ü¶ä";rank="[LEVEL: FOX]"}
  else if(wpm<80){emoji="üêÜ";rank="[LEVEL: CHEETAH]"}
  else{emoji="ü¶Ö";rank="[LEVEL: EAGLE]"}
  rEmoji.textContent=emoji;rRank.textContent=rank;rRank.style.color=wpm>=80?"#ffd700":wpm>=60?"#00ff41":"#008020";
  resultCard.style.display="block";
}

var composing=false;
input.addEventListener("compositionstart",function(){composing=true;});
input.addEventListener("compositionend",function(){
  composing=false;
  // IME produced non-Latin text (Chinese/Japanese/Korean) ‚Äî discard it
  // Only allow ASCII characters through for English typing test
  var val=input.value;
  input.value="";
  // Filter: only process if all chars are ASCII printable
  var ascii=val.replace(/[^\x20-\x7E]/g,"");
  if(ascii.length>0){
    input.value=ascii;
    handleInput();
  }
});

function handleInput(){
  if(finished||composing)return;
  if(actx.state==="suspended")actx.resume();
  if(!running)startTimer();
  const val=input.value;
  // Process all characters in the input
  for(let i=0;i<val.length;i++){
    if(finished)break;
    const ch=val[i];
    if(ch===text[charIndex]){
      correct++;totalTyped++;charIndex++;playTick();
      const spans=display.querySelectorAll(".char");
      if(spans[charIndex-1])spawnGreenLines(spans[charIndex-1]);
      if(text[charIndex-1]===' '||charIndex>=text.length){
        playWordComplete();
        for(let j=lastWordEnd;j<charIndex;j++){
          if(spans[j])spans[j].classList.add('word-complete');
        }
        lastWordEnd=charIndex;
      }
      if(charIndex>=text.length){text+=(" "+genText())}
    }else{
      wrong++;totalTyped++;
      if(mode==="survival"){survivalErrors++;timerEl.textContent=survivalErrors+"/3";if(survivalErrors>=3){endGame();break}}
      playBuzz();
      const spans=display.querySelectorAll(".char");
      if(spans[charIndex]){spans[charIndex].classList.add("wrong");setTimeout(()=>spans[charIndex]&&spans[charIndex].classList.remove("wrong"),100)}
    }
  }
  // Use setTimeout to avoid iOS keyboard issues with immediate value clear
  setTimeout(function(){input.value="";},0);
  renderText();
  updateStats();
  // Scroll text-display to keep current char visible (3-line window)
  const cur=display.querySelector(".current");
  if(cur){
    const containerTop=display.scrollTop;
    const containerH=display.clientHeight;
    const charTop=cur.offsetTop;
    const lineH=cur.offsetHeight*1.8;
    // Keep current char on the first visible line
    if(charTop>containerTop+lineH){
      display.scrollTop=charTop-lineH*0.5;
    }
  }
}

input.addEventListener("input",function(e){
  // Block IME composition intermediate states (Chinese/Japanese/Korean input)
  if(e.isComposing||composing){input.value="";return;}
  handleInput();
});

// Block keydown during IME (keyCode 229 = IME processing)
input.addEventListener("keydown",function(e){
  if(e.isComposing||e.keyCode===229||composing){return;}
});

input.addEventListener("paste",e=>e.preventDefault());

document.querySelectorAll(".mode-btn").forEach(btn=>{
  btn.addEventListener("click",function(){
    document.querySelectorAll(".mode-btn").forEach(b=>b.classList.remove("active"));
    this.classList.add("active");
    mode=this.dataset.mode;
    reset();
  });
});

$d("restartBtn").addEventListener("click",reset);

if(!localStorage.getItem("typing_tutorial_seen")){
  $d("tutorialOverlay").classList.add("show");
}
$d("tutorialClose").addEventListener("click",()=>{
  $d("tutorialOverlay").classList.remove("show");
  localStorage.setItem("typing_tutorial_seen","1");
  input.focus();
});

reset();
window._gameState={get mode(){return mode},get timeLeft(){return timeLeft},get running(){return running},get finished(){return finished},get wpm(){return bestWpm},get correct(){return correct},get wrong(){return wrong}};
})();
</script>
  <script src="../game-audio-auto.js"></script>
</body>
</html>
