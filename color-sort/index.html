<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Color Sort Puzzle - Ice Crystal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{padding-top:28px;font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;-webkit-tap-highlight-color:transparent;user-select:none;background:#0a1628}
#bg-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
#snow-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
#header{text-align:center;padding:16px 8px 8px;position:relative;z-index:1}
#header h1{font-size:28px;color:#b0e0ff;text-shadow:0 0 10px rgba(176,224,255,.6),0 0 30px rgba(176,224,255,.3),0 2px 4px rgba(0,0,0,.5);-webkit-text-stroke:1px rgba(255,255,255,.3)}
#level-info{font-size:16px;color:#7ec8e3;margin-top:4px}
#controls{display:flex;gap:12px;margin:10px 0;flex-wrap:wrap;justify-content:center;position:relative;z-index:1}
.btn{padding:10px 22px;border:2px solid rgba(255,255,255,.4);border-radius:25px;font-size:15px;font-weight:600;cursor:pointer;transition:all .25s;background:rgba(176,224,255,.15);color:#d0f0ff;backdrop-filter:blur(4px);position:relative;overflow:hidden;background-size:cover;background-position:center}
.btn:hover{background:rgba(255,255,255,.25);box-shadow:0 0 15px rgba(176,224,255,.4);border-color:rgba(255,255,255,.7)}
.btn:active{transform:scale(.95)}
.btn .ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.4);transform:scale(0);animation:rippleAnim .5s ease-out forwards;pointer-events:none}
@keyframes rippleAnim{to{transform:scale(3);opacity:0}}
#btn-undo{background:url('images/btn_yellow.png') center/100% 100% no-repeat,rgba(255,160,50,.2);border-color:rgba(255,160,50,.5);color:#ffc070}
#btn-restart{background:url('images/btn_red.png') center/100% 100% no-repeat,rgba(255,80,80,.2);border-color:rgba(255,80,80,.5);color:#ff9090}
#btn-levels{background:url('images/btn_green.png') center/100% 100% no-repeat,rgba(80,255,130,.2);border-color:rgba(80,255,130,.5);color:#90ffa0}
#btn-hint{background:url('images/btn_blue.png') center/100% 100% no-repeat,rgba(80,200,255,.2);border-color:rgba(80,200,255,.5);color:#90d8ff}
#game-area{display:flex;flex-wrap:wrap;justify-content:center;align-items:flex-end;gap:18px;padding:20px 10px;max-width:900px;position:relative;z-index:1}
.tube{position:relative;cursor:pointer;transition:transform .25s cubic-bezier(.4,0,.2,1),filter .3s}
.tube.selected{transform:translateY(-24px)}
.tube.selected .tube-body{box-shadow:0 0 25px rgba(176,224,255,.6)}
.tube.hint-source .tube-body,.tube.hint-target .tube-body{animation:hintPulse 1s ease-in-out infinite}
@keyframes hintPulse{0%,100%{box-shadow:0 0 8px 2px rgba(176,224,255,.5)}50%{box-shadow:0 0 25px 8px rgba(176,224,255,.8)}}
.tube-body{width:80px;height:260px;border-radius:0 0 26px 26px;position:relative;
  background:linear-gradient(90deg,rgba(176,224,255,.12) 0%,rgba(200,230,255,.06) 30%,rgba(200,230,255,.04) 70%,rgba(176,224,255,.1) 100%);
  border:2px solid rgba(176,224,255,.35);border-top:none;overflow:visible;transition:box-shadow .3s;
  clip-path:polygon(5% 0%,95% 0%,100% 100%,0% 100%)}
/* Ice frost texture overlay */
.tube-body::before{content:'';position:absolute;inset:0;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.07'/%3E%3C/svg%3E");
  pointer-events:none;opacity:.5;border-radius:0 0 26px 26px}
.tube-body::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:70px;height:10px;border-radius:50%;background:rgba(176,224,255,.08);filter:blur(4px);pointer-events:none}
.tube-rim{width:60px;height:8px;margin:0 auto -3px;border-radius:4px 4px 0 0;
  background:linear-gradient(180deg,rgba(176,224,255,.4),rgba(176,224,255,.15));
  border:2px solid rgba(176,224,255,.35);border-bottom:none;position:relative}
.ball-container{position:absolute;bottom:10px;left:0;right:0;display:flex;flex-direction:column-reverse;align-items:center;gap:3px;padding:0 7px}
.ball{width:56px;height:56px;position:relative;flex-shrink:0;transition:transform .15s}
.ball-inner{width:100%;height:100%;position:relative;overflow:hidden;border-radius:50%;
  box-shadow:0 2px 8px rgba(0,0,0,.3)}
/* Crystal facet lines */
.ball-inner::before{content:'';position:absolute;top:6px;left:10px;width:18px;height:12px;border-radius:50%;background:rgba(255,255,255,.5);transform:rotate(-25deg);pointer-events:none}
.ball-inner::after{content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,transparent 30%,rgba(255,255,255,.3) 32%,transparent 34%),
             linear-gradient(225deg,transparent 45%,rgba(255,255,255,.2) 47%,transparent 49%),
             linear-gradient(315deg,transparent 60%,rgba(255,255,255,.25) 62%,transparent 64%);
  pointer-events:none;border-radius:50%}
.ball{animation:dropletFloat 2s ease-in-out infinite}
.ball:nth-child(1){animation-delay:0s}.ball:nth-child(2){animation-delay:0.5s}.ball:nth-child(3){animation-delay:1.0s}.ball:nth-child(4){animation-delay:1.5s}
@keyframes dropletFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
.tube.selected .ball:last-child{animation:boilBounce .5s ease-in-out infinite!important}
@keyframes boilBounce{0%,100%{transform:translateY(0) scale(1,1)}25%{transform:translateY(-6px) scale(0.95,1.08)}75%{transform:translateY(2px) scale(1.05,0.92)}}
/* Freeze burst on tube complete */
.tube-complete .tube-body{animation:freezeBurst .8s ease-out}
@keyframes freezeBurst{0%{box-shadow:0 0 5px rgba(176,224,255,.5);filter:brightness(1)}30%{box-shadow:0 0 60px 20px rgba(200,230,255,.8);filter:brightness(1.5)}60%{filter:brightness(1.2) saturate(0.5)}100%{box-shadow:0 0 0 0 transparent;filter:brightness(1)}}
.frost-overlay{position:absolute;inset:0;background:rgba(255,255,255,.4);border-radius:0 0 26px 26px;animation:frostShatter .8s ease-out forwards;pointer-events:none}
@keyframes frostShatter{0%{opacity:.6;transform:scale(1)}50%{opacity:.4;transform:scale(1.05)}100%{opacity:0;transform:scale(1.2)}}
#fx-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100}
#hint-arrow{position:fixed;pointer-events:none;z-index:98;display:none}
#overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:50;justify-content:center;align-items:center}
#overlay.show{display:flex}
#overlay-content{background:rgba(10,22,40,.97);border:1px solid rgba(176,224,255,.3);border-radius:20px;padding:30px;text-align:center;max-width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.5)}
#overlay-content h2{color:#b0e0ff;margin-bottom:16px}
#level-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:16px 0}
.level-btn{width:50px;height:50px;border-radius:12px;border:2px solid rgba(176,224,255,.2);background:rgba(10,22,40,.8);font-size:18px;font-weight:700;cursor:pointer;transition:all .2s;color:#7ec8e3}
.level-btn.unlocked{border-color:rgba(80,255,130,.5);background:rgba(80,255,130,.1)}
.level-btn.current{border-color:#b0e0ff;background:rgba(176,224,255,.15);color:#b0e0ff}
.level-btn.locked{opacity:.3;cursor:default;color:#546e7a}
#win-msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:101;background:rgba(10,22,40,.97);border:1px solid rgba(176,224,255,.3);border-radius:24px;padding:40px;text-align:center;display:none;box-shadow:0 10px 40px rgba(0,0,0,.4),0 0 30px rgba(176,224,255,.2);transition:transform .4s cubic-bezier(.175,.885,.32,1.275)}
#win-msg.visible{transform:translate(-50%,-50%) scale(1)}
#win-msg h2{font-size:32px;color:#90ffa0;margin-bottom:12px;text-shadow:0 0 15px rgba(144,255,160,.5)}
#win-msg .btn{margin-top:16px}
#screen-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0;pointer-events:none;z-index:99;transition:opacity .1s}
#aurora-canvas{position:fixed;top:0;left:0;width:100%;height:30%;pointer-events:none;z-index:99;opacity:0;transition:opacity .5s}
.chem-smoke{position:fixed;pointer-events:none;z-index:99;border-radius:50%;animation:smokeExpand 1s ease-out forwards}
@keyframes smokeExpand{0%{opacity:0.4;transform:translate(-50%,-50%) scale(0)}40%{opacity:0.25}100%{opacity:0;transform:translate(-50%,-50%) scale(1)}}
@keyframes screenShake{0%,100%{transform:translateX(0)}10%{transform:translateX(-3px)}30%{transform:translateX(3px)}50%{transform:translateX(-2px)}70%{transform:translateX(2px)}}
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
  <script src="../game-audio.js?v=5"></script>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<canvas id="snow-canvas"></canvas>
<a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:rgba(10,22,40,0.9);color:#7ec8e3;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none;border-bottom:1px solid rgba(176,224,255,.2)">‚¨Ö More Games at GameZipper.com</a>
<div id="header">
<h1>üßä Crystal Sort Puzzle</h1>
<div id="level-info">Level 1</div>
</div>
<div id="controls">
<button class="btn" id="btn-undo" onclick="undo()">‚Ü© Undo</button>
<button class="btn" id="btn-hint" onclick="showHint()">üí° Hint</button>
<button class="btn" id="btn-restart" onclick="restartLevel()">üîÑ Restart</button>
<button class="btn" id="btn-levels" onclick="showLevels()">üìã Levels</button>
</div>
<div id="game-area"></div>
<canvas id="fx-canvas"></canvas>
<canvas id="aurora-canvas"></canvas>
<svg id="hint-arrow" width="100%" height="100%"><defs><marker id="ah" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="rgba(176,224,255,.8)"/></marker></defs><line id="hint-line" stroke="rgba(176,224,255,.8)" stroke-width="3" stroke-dasharray="8,6" marker-end="url(#ah)"/></svg>
<div id="screen-flash"></div>
<div id="overlay" onclick="event.target===this&&hideOverlay()">
<div id="overlay-content"></div>
</div>
<div id="win-msg">
<h2>üßä Perfectly Crystallized!</h2>
<p id="win-sub"></p>
<button class="btn" style="background:rgba(176,224,255,.2);border-color:rgba(176,224,255,.5);color:#d0f0ff" onclick="nextLevel()">Next Level ‚ûú</button>
</div>

<script>
const COLORS=['#39ff14','#00e5ff','#ff1493','#ff6d00','#bf00ff','#ffff00'];
const COLORS_DARK=['#1a8a0a','#007a8a','#8a0a4a','#8a3a00','#5a0080','#8a8a00'];
const TUBE_W=80,TUBE_H=260,BALL_D=56,CAP=4;
const LEVEL_DEFS=[
[3,1],[3,2],[4,1],[4,2],[5,1],[5,2],[5,2],[6,2],[6,2],[6,2],
[7,2],[7,2],[7,2],[7,3],[8,2],[8,2],[8,3],[9,2],[9,3],[10,2],
[10,3],[11,2],[11,3],[12,2],[12,3]
];

let state={level:0,tubes:[],history:[],selected:-1,won:false};
let maxLevel=parseInt(localStorage.getItem('csort_max')||'0');
let isAnimating=false;
let hintFrom=-1,hintTo=-1,hintTimer=0;

let fxC,fxCtx;
const POOL_SIZE=800;
let particles=new Array(POOL_SIZE);
let pCount=0;
for(let i=0;i<POOL_SIZE;i++) particles[i]={active:false};

let bgC,bgCtx,bgBubbles=[];

// Snow particles
let snowC,snowCtx,snowflakes=[];
function initSnow(){
  snowC=document.getElementById('snow-canvas');snowCtx=snowC.getContext('2d');
  function resize(){snowC.width=window.innerWidth;snowC.height=window.innerHeight;}
  resize();window.addEventListener('resize',resize);
  for(let i=0;i<20;i++){
    snowflakes.push({
      x:Math.random()*snowC.width,y:Math.random()*snowC.height,
      r:Math.random()*4+1,speed:Math.random()*.5+.2,
      drift:Math.random()*Math.PI*2,opacity:Math.random()*.5+.3
    });
  }
}
function tickSnow(){
  snowCtx.clearRect(0,0,snowC.width,snowC.height);
  for(const s of snowflakes){
    s.y+=s.speed;s.x+=Math.sin(s.drift)*0.3;s.drift+=0.005;
    if(s.y>snowC.height+10){s.y=-10;s.x=Math.random()*snowC.width;}
    snowCtx.globalAlpha=s.opacity;snowCtx.fillStyle='#fff';
    // Draw 6-petal snowflake
    snowCtx.save();snowCtx.translate(s.x,s.y);
    for(let j=0;j<6;j++){
      snowCtx.beginPath();snowCtx.moveTo(0,0);snowCtx.lineTo(0,-s.r*2);
      snowCtx.strokeStyle='rgba(255,255,255,'+s.opacity+')';snowCtx.lineWidth=.5;snowCtx.stroke();
      snowCtx.rotate(Math.PI/3);
    }
    snowCtx.beginPath();snowCtx.arc(0,0,s.r*.5,0,Math.PI*2);snowCtx.fill();
    snowCtx.restore();
  }
  snowCtx.globalAlpha=1;
}

// Aurora
let auroraC,auroraCtx;
function initAurora(){
  auroraC=document.getElementById('aurora-canvas');auroraCtx=auroraC.getContext('2d');
  function resize(){auroraC.width=window.innerWidth;auroraC.height=window.innerHeight*.3;}
  resize();window.addEventListener('resize',resize);
}
function showAurora(){
  auroraC.style.opacity='1';
  let t0=performance.now();
  function draw(now){
    const elapsed=(now-t0)/1000;
    if(elapsed>3.5){auroraC.style.opacity='0';return;}
    auroraCtx.clearRect(0,0,auroraC.width,auroraC.height);
    for(let i=0;i<3;i++){
      auroraCtx.beginPath();
      auroraCtx.moveTo(0,auroraC.height*(0.3+i*0.2));
      for(let x=0;x<auroraC.width;x+=10){
        const y=auroraC.height*(0.3+i*0.2)+Math.sin(x*0.005+elapsed*0.8+i)*30+Math.sin(x*0.01+elapsed*1.2)*15;
        auroraCtx.lineTo(x,y);
      }
      auroraCtx.lineTo(auroraC.width,0);auroraCtx.lineTo(0,0);auroraCtx.closePath();
      const colors=[['rgba(0,255,100,.12)','rgba(100,0,200,.08)'],['rgba(0,200,100,.1)','rgba(150,0,255,.06)'],['rgba(100,255,150,.08)','rgba(200,100,255,.05)']];
      const g=auroraCtx.createLinearGradient(0,0,auroraC.width,0);
      g.addColorStop(0,colors[i][0]);g.addColorStop(.5,colors[i][1]);g.addColorStop(1,colors[i][0]);
      auroraCtx.fillStyle=g;auroraCtx.fill();
    }
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
}

// Audio
let audioCtx;
function ac(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playSound(type){
  try{
    const a=ac(),t=a.currentTime;
    if(type==='select'){const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='sine';o.frequency.value=1400;g.gain.setValueAtTime(.2,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.12);}
    else if(type==='deselect'){const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='sine';o.frequency.value=400;g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.1);o.start(t);o.stop(t+.1);}
    else if(type==='fly'){const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='sine';o.frequency.setValueAtTime(900,t);o.frequency.exponentialRampToValueAtTime(300,t+.35);g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35);}
    else if(type==='bounce'){[0,.08,.15].forEach((d,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='triangle';o.frequency.value=200-i*30;const v=.2-i*.06;g.gain.setValueAtTime(v,t+d);g.gain.exponentialRampToValueAtTime(.001,t+d+.08);o.start(t+d);o.stop(t+d+.1);});}
    else if(type==='complete'){[523,659,784,1047].forEach((f,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.2,t+i*.08);g.gain.exponentialRampToValueAtTime(.001,t+i*.08+.4);o.start(t+i*.08);o.stop(t+i*.08+.4);});}
    else if(type==='win'){[523,587,659,784,1047,1319].forEach((f,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.2,t+i*.1);g.gain.exponentialRampToValueAtTime(.001,t+i*.1+.5);o.start(t+i*.1);o.stop(t+i*.1+.5);});}
    else if(type==='error'){const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.type='square';o.frequency.value=100;g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.12);o.start(t);o.stop(t+.15);}
  }catch(e){}
}

document.addEventListener('click',e=>{
  const btn=e.target.closest('.btn');if(!btn)return;
  const r=document.createElement('span');r.className='ripple';
  const rect=btn.getBoundingClientRect();const sz=Math.max(rect.width,rect.height);
  r.style.width=r.style.height=sz+'px';r.style.left=(e.clientX-rect.left-sz/2)+'px';r.style.top=(e.clientY-rect.top-sz/2)+'px';
  btn.appendChild(r);setTimeout(()=>r.remove(),500);
});

function genLevel(idx){
  const[nc,ne]=LEVEL_DEFS[Math.min(idx,LEVEL_DEFS.length-1)];
  let seed=idx*2654435761+12345;
  function rng(){seed=(seed*1664525+1013904223)&0xffffffff;return(seed>>>0)/4294967296}
  
  // Fisher-Yates shuffle approach + BFS solvability check
  // Step 1: Create all balls (nc colors √ó CAP each)
  function shuffle(){
    let balls=[];
    for(let c=0;c<nc;c++) for(let i=0;i<CAP;i++) balls.push(c%COLORS.length);
    // Fisher-Yates shuffle
    for(let i=balls.length-1;i>0;i--){
      const j=Math.floor(rng()*(i+1));
      [balls[i],balls[j]]=[balls[j],balls[i]];
    }
    // Fill tubes
    let tubes=[];
    let bi=0;
    for(let t=0;t<nc;t++){
      let tube=[];
      for(let b=0;b<CAP;b++) tube.push(balls[bi++]);
      tubes.push(tube);
    }
    for(let t=0;t<ne;t++) tubes.push([]);
    return tubes;
  }
  
  // Step 2: Quality check ‚Äî reject trivial/unsolvable layouts
  function isGoodLevel(tubes){
    // Reject if any tube is already sorted (trivial)
    let sortedCount=0;
    for(let t=0;t<tubes.length;t++){
      if(tubes[t].length===CAP && tubes[t].every(b=>b===tubes[t][0])) sortedCount++;
    }
    if(sortedCount>0) return false;
    
    // Reject if too many same-color balls are adjacent (boring)
    let adjacentSame=0;
    for(let t=0;t<tubes.length;t++){
      for(let i=1;i<tubes[t].length;i++){
        if(tubes[t][i]===tubes[t][i-1]) adjacentSame++;
      }
    }
    if(adjacentSame>nc*CAP*0.6) return false;
    
    // BFS solvability check (limited depth to prevent timeout)
    return isSolvable(tubes);
  }
  
  // BFS solver with state deduplication
  function isSolvable(tubes){
    function stateKey(ts){return ts.map(t=>t.join(',')).join('|')}
    function isSolved(ts){
      for(let t of ts){
        if(t.length>0 && t.length<CAP) return false;
        if(t.length===CAP && !t.every(b=>b===t[0])) return false;
      }
      return true;
    }
    function getMoves(ts){
      let moves=[];
      for(let from=0;from<ts.length;from++){
        if(!ts[from].length) continue;
        const ball=ts[from][ts[from].length-1];
        for(let to=0;to<ts.length;to++){
          if(to===from) continue;
          if(ts[to].length>=CAP) continue;
          // Don't move to empty tube if source is all same color (pointless)
          if(ts[to].length===0 && ts[from].every(b=>b===ball)) continue;
          // Only pour onto same color or empty tube
          if(ts[to].length>0 && ts[to][ts[to].length-1]!==ball) continue;
          moves.push([from,to]);
        }
      }
      return moves;
    }
    
    const visited=new Set();
    let queue=[tubes.map(t=>[...t])];
    visited.add(stateKey(queue[0]));
    const maxStates=nc<=4?10000:nc<=6?6000:4000; // Limit search
    let checked=0;
    
    while(queue.length>0 && checked<maxStates){
      const state=queue.shift();
      checked++;
      if(isSolved(state)) return true;
      
      for(const[from,to] of getMoves(state)){
        const ns=state.map(t=>[...t]);
        // Pour all matching top balls
        const ball=ns[from][ns[from].length-1];
        while(ns[from].length>0 && ns[from][ns[from].length-1]===ball && ns[to].length<CAP){
          ns[to].push(ns[from].pop());
        }
        const key=stateKey(ns);
        if(!visited.has(key)){
          visited.add(key);
          queue.push(ns);
        }
      }
    }
    // If BFS exhausted: with 2+ empty tubes, very likely solvable (just complex)
    return ne >= 2;
  }
  
  // Step 3: Generate until we get a good level (max 50 attempts)
  for(let attempt=0;attempt<50;attempt++){
    const tubes=shuffle();
    if(isGoodLevel(tubes)) return tubes;
  }
  // Fallback: return last shuffle (very unlikely to reach here)
  return shuffle();
}
function deepCopy(t){return t.map(a=>[...a])}

function loadLevel(idx){
  state.level=idx;state.tubes=genLevel(idx);state.history=[];state.selected=-1;state.won=false;
  hintFrom=-1;hintTo=-1;
  document.getElementById('level-info').textContent='Level '+(idx+1);
  document.getElementById('win-msg').style.display='none';document.getElementById('win-msg').classList.remove('visible');
  hideHintArrow();render();
}

function lighten(hex,amt){let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);r=Math.min(255,Math.round(r+(255-r)*amt));g=Math.min(255,Math.round(g+(255-g)*amt));b=Math.min(255,Math.round(b+(255-b)*amt));return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
function darken(hex,amt){let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);r=Math.max(0,Math.round(r*(1-amt)));g=Math.max(0,Math.round(g*(1-amt)));b=Math.max(0,Math.round(b*(1-amt)));return'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}

function render(){
  const area=document.getElementById('game-area');area.innerHTML='';
  state.tubes.forEach((tube,i)=>{
    const div=document.createElement('div');
    let cls='tube';
    if(state.selected===i) cls+=' selected';
    if(hintFrom===i) cls+=' hint-source';
    if(hintTo===i) cls+=' hint-target';
    div.className=cls;div.dataset.idx=i;
    if(state.selected===i&&tube.length>0) div.style.setProperty('--sel-glow',COLORS[tube[tube.length-1]]+'80');
    const rim=document.createElement('div');rim.className='tube-rim';div.appendChild(rim);
    const body=document.createElement('div');body.className='tube-body';
    const bc=document.createElement('div');bc.className='ball-container';
    for(let bi=0;bi<tube.length;bi++){
      const col=COLORS[tube[bi]];
      const ball=document.createElement('div');ball.className='ball';
      ball.style.setProperty('--ball-color',col);
      const inner=document.createElement('div');inner.className='ball-inner';
      inner.style.background=`radial-gradient(circle at 35% 30%, ${lighten(col,.6)}, ${col} 50%, ${darken(col,.3)})`;
      inner.style.boxShadow=`0 0 12px ${col}60, inset 0 -3px 6px rgba(0,0,0,.2)`;
      ball.appendChild(inner);bc.appendChild(ball);
    }
    body.appendChild(bc);div.appendChild(body);
    div.addEventListener('click',()=>onTap(i));
    div.addEventListener('touchend',e=>{e.preventDefault();onTap(i)});
    area.appendChild(div);
  });
  updateHintArrow();
}

function topBall(tube){return tube.length?tube[tube.length-1]:-1}
function onTap(i){
  if(state.won||isAnimating)return;clearHint();
  if(state.selected===-1){if(state.tubes[i].length>0){state.selected=i;playSound('select');render();}}
  else if(state.selected===i){state.selected=-1;playSound('deselect');render();}
  else{tryMove(state.selected,i);}
}
function clearHint(){hintFrom=-1;hintTo=-1;clearTimeout(hintTimer);hideHintArrow();}

function tryMove(from,to){
  const ft=state.tubes[from],tt=state.tubes[to];
  if(!ft.length){state.selected=-1;render();return}
  const ball=topBall(ft);
  if(tt.length>=CAP||(tt.length>0&&topBall(tt)!==ball)){state.selected=-1;playSound('error');render();return;}
  state.history.push({from,to,tubes:deepCopy(state.tubes)});
  const ballColor=COLORS[ball];
  let count=0;let tmpF=[...ft],tmpT=[...tt];
  while(tmpF.length>0&&topBall(tmpF)===ball&&tmpT.length<CAP){tmpT.push(tmpF.pop());count++;}
  for(let c=0;c<count;c++) tt.push(ft.pop());
  state.selected=-1;render();
  animatePour(from,to,ballColor,count,()=>{
    const t2=state.tubes[to];
    // Small delay to let ball visually settle before celebration
    setTimeout(()=>{
      if(t2.length===CAP&&new Set(t2).size===1) onTubeComplete(to);
      checkWin();
    },80);
  });
}

function getTubeEl(idx){return document.querySelectorAll('#game-area .tube')[idx]||null;}
function getTubeRect(idx){const el=getTubeEl(idx);return el?el.getBoundingClientRect():null;}
// Áõ¥Êé•ËØªÁêÉ DOM ÁöÑÂÆûÈôÖ‰ΩçÁΩÆÔºàÊØîÂÖ¨ÂºèËÆ°ÁÆóÊõ¥ÂáÜÁ°ÆÔºâ
// ballIdx = Âú® state.tubes[tubeIdx] Êï∞ÁªÑ‰∏≠ÁöÑÁ¥¢Âºï (0=Â∫ïÈÉ®)
function getBallRect(tubeIdx,ballIdx){
  const el=getTubeEl(tubeIdx);if(!el)return null;
  const balls=el.querySelectorAll('.ball');
  // flex column-reverse: DOM Á¨¨ 0 ‰∏™ÂÖÉÁ¥†Âú®ËßÜËßâÂ∫ïÈÉ®
  if(balls[ballIdx])return balls[ballIdx].getBoundingClientRect();
  return null;
}
function getBallCenterY(tubeIdx,ballIdx){
  const br=getBallRect(tubeIdx,ballIdx);
  if(br)return br.top+br.height/2;
  // ÂÖ¨ÂºèÂÖúÂ∫ïÔºàtube-bodyÊúâ2pxÂ∫ïËæπÊ°ÜÔºåÈúÄÂáèÂéªÔºâ
  const rect=getTubeRect(tubeIdx);if(!rect)return 0;
  return rect.bottom-12-ballIdx*(BALL_D+3)-BALL_D/2;
}
// ÂÖºÂÆπÊóßË∞ÉÁî®
function getBallY(tubeIdx,ballIdx){return getBallCenterY(tubeIdx,ballIdx);}

let activeTrails=[];

function animatePour(fromIdx,toIdx,color,count,cb){
  isAnimating=true;playSound('fly');
  const fromRect=getTubeRect(fromIdx),toRect=getTubeRect(toIdx);
  if(!fromRect||!toRect){isAnimating=false;cb();return;}
  const destCount=state.tubes[toIdx].length;let done=0;
  const toEl=document.querySelectorAll('#game-area .tube')[toIdx];
  const ballEls=toEl?toEl.querySelectorAll('.ball'):[];
  for(let i=0;i<count;i++){const bi=destCount-count+i;if(ballEls[bi])ballEls[bi].style.visibility='hidden';}

  for(let b=0;b<count;b++){
    setTimeout(()=>{
      const startX=fromRect.left+fromRect.width/2,startY=fromRect.top-10;
      const endX=toRect.left+toRect.width/2;
      const destBi=destCount-count+b;
      const endY=getBallY(toIdx,destBi);
      const peakY=Math.min(startY,endY)-90;
      const t0=performance.now(),flyDur=400;
      const trail=[];

      function animFly(now){
        const t=Math.min(1,(now-t0)/flyDur);
        const et=t<.45?2*t*t:(t<.55?.5:1-2*(1-t)*(1-t));
        const x=startX+(endX-startX)*et;
        const y=(1-et)*(1-et)*startY+2*(1-et)*et*peakY+et*et*endY;
        const stretch=1+2*Math.sin(t*Math.PI);
        trail.push({x,y,r:BALL_D/2,a:1,sx:1/Math.sqrt(stretch),sy:Math.sqrt(stretch),t:now});
        // Ice crystal trail particles
        if(Math.random()<0.5){
          const angle=Math.random()*Math.PI*2;
          spawnP({x:x+Math.random()*10-5,y:y+Math.random()*10-5,
            vx:Math.cos(angle)*2,vy:Math.sin(angle)*2,
            r:3,life:1,decay:.05,type:'ice',color:'#b0e0ff'});
        }
        if(t<1){requestAnimationFrame(animFly);}
        else{
          playSound('bounce');
          // Ice flower splash - 6 petals
          for(let s=0;s<6;s++){
            const angle=Math.PI*2*s/6;
            spawnP({x:endX,y:endY,vx:Math.cos(angle)*5,vy:Math.sin(angle)*3-2,r:8,life:1,decay:.03,type:'iceflower',color:'#d0f0ff',angle:angle});
          }
          spawnRipple(endX,endY,color);
          const t1=performance.now(),bDur=300;
          function animBounce(now2){
            const bt=Math.min(1,(now2-t1)/bDur);
            const bounceH=[18,9,4];let by=0;
            if(bt<.33)by=-bounceH[0]*Math.sin(bt/.33*Math.PI);
            else if(bt<.66)by=-bounceH[1]*Math.sin((bt-.33)/.33*Math.PI);
            else by=-bounceH[2]*Math.sin((bt-.66)/.34*Math.PI);
            const sq=bt<.33?1+.15*Math.sin(bt/.33*Math.PI):1+.08*Math.sin((bt-.33)/.67*Math.PI*2);
            trail.push({x:endX,y:endY+by,r:BALL_D/2,a:1,sx:1/sq,sy:sq,t:now2});
            if(bt<1){requestAnimationFrame(animBounce);}
            else{if(ballEls[destBi])ballEls[destBi].style.visibility='visible';done++;if(done===count){isAnimating=false;cb();}}
          }
          requestAnimationFrame(animBounce);
        }
      }
      requestAnimationFrame(animFly);
      activeTrails.push({trail,color,startTime:performance.now(),endTime:performance.now()+flyDur+600});
    },b*120);
  }
}

function drawFlyingBalls(){
  const now=performance.now();
  activeTrails=activeTrails.filter(t=>now<t.endTime);
  for(const at of activeTrails){
    const trail=at.trail;if(!trail.length)continue;
    const len=trail.length,trailCount=Math.min(15,len);
    for(let i=0;i<trailCount;i++){
      const ti=len-trailCount+i;const p=trail[ti];
      const alpha=(i/trailCount)*0.4;const r=p.r*(i/trailCount)*0.7;
      fxCtx.beginPath();fxCtx.arc(p.x,p.y,r,0,Math.PI*2);
      fxCtx.fillStyle=at.color;fxCtx.globalAlpha=alpha;fxCtx.fill();
    }
    const cur=trail[len-1];
    fxCtx.globalAlpha=1;fxCtx.save();fxCtx.translate(cur.x,cur.y);
    if(cur.sx)fxCtx.scale(cur.sx,cur.sy);
    fxCtx.shadowColor=at.color;fxCtx.shadowBlur=20;
    const g=fxCtx.createRadialGradient(-4,-4,2,0,0,BALL_D/2);
    g.addColorStop(0,lighten(at.color,.6));g.addColorStop(.5,at.color);g.addColorStop(1,darken(at.color,.3));
    fxCtx.beginPath();fxCtx.arc(0,0,BALL_D/2,0,Math.PI*2);
    fxCtx.fillStyle=g;fxCtx.fill();
    fxCtx.shadowBlur=0;
    // Crystal facet lines on flying ball
    fxCtx.strokeStyle='rgba(255,255,255,.4)';fxCtx.lineWidth=1;
    fxCtx.beginPath();fxCtx.arc(-5,-8,12,.3,1.8);fxCtx.stroke();
    fxCtx.beginPath();fxCtx.arc(8,-2,14,1.5,2.8);fxCtx.stroke();
    fxCtx.beginPath();fxCtx.arc(-2,10,10,3.5,5);fxCtx.stroke();
    // highlight
    fxCtx.beginPath();fxCtx.ellipse(-6,-10,8,5,-.4,0,Math.PI*2);
    fxCtx.fillStyle='rgba(255,255,255,.45)';fxCtx.fill();
    fxCtx.restore();
  }
  fxCtx.globalAlpha=1;
}

function spawnRipple(x,y,color){
  for(let i=0;i<3;i++) spawnP({x,y,vx:0,vy:0,r:BALL_D/2+i*5,life:1,decay:.03,type:'ring',color:'#b0e0ff',grow:3-i*.7});
}

function onTubeComplete(idx){
  playSound('complete');
  const rect=getTubeRect(idx);if(!rect)return;
  const cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;
  const col=COLORS[state.tubes[idx][0]];

  const el=document.querySelectorAll('#game-area .tube')[idx];
  if(el){
    el.classList.add('tube-complete');
    // Frost overlay that shatters
    const frost=document.createElement('div');frost.className='frost-overlay';
    el.querySelector('.tube-body').appendChild(frost);
    setTimeout(()=>{frost.remove();el.classList.remove('tube-complete');},800);
  }

  // Ice crystal shatter particles ‚Äî spawn from each ball's actual DOM position
  for(let bi=0;bi<CAP;bi++){
    const ballCY=getBallCenterY(idx,bi);
    const br=getBallRect(idx,bi);
    const ballCX=br?br.left+br.width/2:cx;
    for(let i=0;i<8;i++){
      const angle=Math.random()*Math.PI*2;const speed=Math.random()*5+2;
      spawnP({x:ballCX+(Math.random()-0.5)*20,y:ballCY+(Math.random()-0.5)*10,
        vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-2,
        r:Math.random()*5+2,life:1,decay:.015,type:'ice',color:'#d0f0ff'});
    }
  }

  spawnP({x:cx,y:cy,vx:0,vy:0,r:10,life:1,decay:.008,type:'ring',color:'#b0e0ff',grow:10});

  const smoke=document.createElement('div');
  smoke.className='chem-smoke';
  smoke.style.left=cx+'px';smoke.style.top=cy+'px';
  smoke.style.width='600px';smoke.style.height='600px';
  smoke.style.background=`radial-gradient(circle,rgba(176,224,255,.3),rgba(176,224,255,.1),transparent 70%)`;
  document.body.appendChild(smoke);
  setTimeout(()=>smoke.remove(),1000);

  document.body.style.animation='screenShake .25s linear';setTimeout(()=>document.body.style.animation='',300);
}

function checkWin(){
  for(const t of state.tubes){if(t.length>0&&t.length<CAP)return;if(t.length===CAP&&new Set(t).size>1)return;}
  state.won=true;
  if(state.level>=maxLevel){maxLevel=state.level+1;localStorage.setItem('csort_max',''+maxLevel);}
  playSound('win');
  const flash=document.getElementById('screen-flash');flash.style.opacity='0.4';setTimeout(()=>flash.style.opacity='0',200);

  // Aurora borealis celebration
  showAurora();

  const w=fxC.width,h=fxC.height,cx=w/2,cy=h/2;
  for(let i=0;i<200;i++){
    const angle=Math.random()*Math.PI*2;const speed=Math.random()*8+3;
    spawnP({x:cx,y:cy,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-4,
      r:Math.random()*5+2,life:1,decay:Math.random()*.006+.003,type:'ice',color:['#b0e0ff','#d0f0ff','#ffffff','#90c8ff'][Math.floor(Math.random()*4)]});
  }

  setTimeout(()=>{
    document.getElementById('win-sub').textContent='Level '+(state.level+1)+' completed!';
    const wm=document.getElementById('win-msg');wm.style.display='block';
    requestAnimationFrame(()=>wm.classList.add('visible'));
  },400);
}

function spawnP(opts){for(let i=0;i<POOL_SIZE;i++){if(!particles[i].active){Object.assign(particles[i],opts,{active:true});return;}}}

function tickParticles(){
  fxCtx.clearRect(0,0,fxC.width,fxC.height);
  drawFlyingBalls();
  for(let i=0;i<POOL_SIZE;i++){
    const p=particles[i];if(!p.active)continue;
    p.life-=p.decay;if(p.life<=0){p.active=false;continue;}
    if(p.type==='dot'||p.type==='ice'){
      p.x+=p.vx;p.y+=p.vy;p.vy+=.12;p.vx*=.99;
      fxCtx.globalAlpha=p.life;fxCtx.shadowColor=p.color;fxCtx.shadowBlur=8;
      if(p.type==='ice'){
        // Triangle ice crystal
        fxCtx.save();fxCtx.translate(p.x,p.y);fxCtx.rotate(p.vx);
        fxCtx.beginPath();fxCtx.moveTo(0,-p.r*p.life);
        fxCtx.lineTo(-p.r*p.life*.7,p.r*p.life*.5);
        fxCtx.lineTo(p.r*p.life*.7,p.r*p.life*.5);fxCtx.closePath();
        fxCtx.fillStyle=p.color;fxCtx.fill();fxCtx.restore();
      }else{
        fxCtx.beginPath();fxCtx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);
        fxCtx.fillStyle=p.color;fxCtx.fill();
      }
      fxCtx.shadowBlur=0;
    }else if(p.type==='iceflower'){
      p.x+=p.vx*.9;p.y+=p.vy*.9;p.vx*=.95;p.vy*=.95;
      fxCtx.globalAlpha=p.life;fxCtx.save();fxCtx.translate(p.x,p.y);
      // 6-petal snowflake shape
      fxCtx.strokeStyle=p.color;fxCtx.lineWidth=1.5;
      for(let j=0;j<6;j++){
        fxCtx.beginPath();fxCtx.moveTo(0,0);fxCtx.lineTo(0,-p.r*p.life);
        fxCtx.stroke();fxCtx.rotate(Math.PI/3);
      }
      fxCtx.restore();
    }else if(p.type==='glow'){
      p.x+=p.vx;p.y+=p.vy;p.vy+=.08;p.vx*=.995;
      fxCtx.globalAlpha=p.life;fxCtx.shadowColor=p.color;fxCtx.shadowBlur=15;
      fxCtx.beginPath();fxCtx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);
      fxCtx.fillStyle=p.color;fxCtx.fill();
      fxCtx.globalAlpha=p.life*0.3;fxCtx.beginPath();
      fxCtx.moveTo(p.x,p.y);fxCtx.lineTo(p.x-p.vx*3,p.y-p.vy*3);
      fxCtx.strokeStyle=p.color;fxCtx.lineWidth=p.r*p.life*0.6;fxCtx.lineCap='round';fxCtx.stroke();
      fxCtx.shadowBlur=0;
    }else if(p.type==='ring'){
      p.r+=(p.grow||2);fxCtx.globalAlpha=p.life*.5;
      fxCtx.beginPath();fxCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
      fxCtx.shadowColor=p.color;fxCtx.shadowBlur=10;
      fxCtx.strokeStyle=p.color;fxCtx.lineWidth=2.5;fxCtx.stroke();fxCtx.shadowBlur=0;
    }else if(p.type==='bubble'){
      p.x+=p.vx+Math.sin(p.y*.05)*0.5;p.y+=p.vy;
      fxCtx.globalAlpha=p.life*0.6;fxCtx.shadowColor=p.color;fxCtx.shadowBlur=12;
      fxCtx.beginPath();fxCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
      fxCtx.strokeStyle=p.color;fxCtx.lineWidth=1.5;fxCtx.stroke();fxCtx.shadowBlur=0;
    }
  }
  fxCtx.globalAlpha=1;
}

function initBg(){
  bgC=document.getElementById('bg-canvas');bgCtx=bgC.getContext('2d');
  function resize(){bgC.width=window.innerWidth;bgC.height=window.innerHeight;}
  resize();window.addEventListener('resize',resize);
}

function tickBg(){
  const w=bgC.width,h=bgC.height;
  const grad=bgCtx.createLinearGradient(0,0,w,h);
  grad.addColorStop(0,'#0a1628');grad.addColorStop(.5,'#0e1f3d');grad.addColorStop(1,'#061020');
  bgCtx.fillStyle=grad;bgCtx.fillRect(0,0,w,h);
}

function showHint(){
  if(state.won||isAnimating)return;clearHint();state.selected=-1;
  const tubes=state.tubes;let bestMove=null,bestScore=-Infinity;
  for(let f=0;f<tubes.length;f++){
    if(!tubes[f].length)continue;const ball=topBall(tubes[f]);
    let fCount=0;for(let k=tubes[f].length-1;k>=0&&tubes[f][k]===ball;k--)fCount++;
    for(let t=0;t<tubes.length;t++){
      if(f===t)continue;if(tubes[t].length>=CAP)continue;
      if(tubes[t].length>0&&topBall(tubes[t])!==ball)continue;
      if(tubes[t].length===0&&new Set(tubes[f]).size===1)continue;
      let score=0;
      if(tubes[t].length>0){let tCount=0;for(let k=tubes[t].length-1;k>=0&&tubes[t][k]===ball;k--)tCount++;score+=10+tCount+fCount;if(tCount+fCount===CAP)score+=50;}
      if(tubes[t].length===0)score+=1;if(fCount<tubes[f].length)score+=3;
      if(score>bestScore){bestScore=score;bestMove={from:f,to:t};}
    }
  }
  if(bestMove){hintFrom=bestMove.from;hintTo=bestMove.to;render();showHintArrow();
    hintTimer=setTimeout(()=>{if(hintFrom===bestMove.from){clearHint();render();}},3000);}
}
function showHintArrow(){const svg=document.getElementById('hint-arrow'),line=document.getElementById('hint-line');const fr=getTubeRect(hintFrom),tr=getTubeRect(hintTo);if(!fr||!tr){svg.style.display='none';return;}svg.style.display='block';line.setAttribute('x1',fr.left+fr.width/2);line.setAttribute('y1',fr.top-20);line.setAttribute('x2',tr.left+tr.width/2);line.setAttribute('y2',tr.top-20);}
function hideHintArrow(){document.getElementById('hint-arrow').style.display='none';}
function updateHintArrow(){if(hintFrom>=0&&hintTo>=0)showHintArrow();}

function undo(){if(!state.history.length||state.won||isAnimating)return;const h=state.history.pop();state.tubes=h.tubes;state.selected=-1;clearHint();render();}
function restartLevel(){if(isAnimating)return;loadLevel(state.level);}
function nextLevel(){document.getElementById('win-msg').style.display='none';document.getElementById('win-msg').classList.remove('visible');loadLevel(state.level+1);}
function showLevels(){
  const oc=document.getElementById('overlay-content');
  let h='<h2>Select Level</h2><div id="level-grid">';
  for(let i=0;i<LEVEL_DEFS.length;i++){const unlocked=i<=maxLevel;const cls=i===state.level?'current':unlocked?'unlocked':'locked';
    h+=`<button class="level-btn ${cls}" ${unlocked?`onclick="pickLevel(${i})"`:''}>${i+1}</button>`;}
  h+='</div><button class="btn" style="background:rgba(100,120,140,.3);color:#d0f0ff;border-color:rgba(176,224,255,.3)" onclick="hideOverlay()">Close</button>';
  oc.innerHTML=h;document.getElementById('overlay').classList.add('show');
}
function pickLevel(i){hideOverlay();loadLevel(i);}
function hideOverlay(){document.getElementById('overlay').classList.remove('show');}

function initFx(){
  fxC=document.getElementById('fx-canvas');fxCtx=fxC.getContext('2d');
  function resize(){fxC.width=window.innerWidth;fxC.height=window.innerHeight;}
  resize();window.addEventListener('resize',resize);
}

function mainLoop(){tickBg();tickSnow();tickParticles();requestAnimationFrame(mainLoop);}

initBg();initSnow();initAurora();initFx();mainLoop();
loadLevel(maxLevel<LEVEL_DEFS.length?maxLevel:0);
window._gameState={get level(){return state.level},get tubes(){return state.tubes},get won(){return state.won},get history(){return state.history},loadLevel:loadLevel,nextLevel:nextLevel};
</script>

<div id="tutorial-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);z-index:99999;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;">
  <div style="background:rgba(10,22,40,0.97);border:1px solid rgba(176,224,255,.3);border-radius:20px;padding:32px 28px 24px;max-width:340px;width:90%;color:#d0f0ff;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.5),0 0 20px rgba(176,224,255,.15);">
    <div style="font-size:28px;font-weight:bold;margin-bottom:18px;color:#b0e0ff;text-shadow:0 0 10px rgba(176,224,255,.5)">üßä How to Play</div>
    <div style="font-size:16px;line-height:1.8;text-align:left;margin-bottom:20px;">1Ô∏è‚É£ Tap a crystal tube to pick up the top gem<br>2Ô∏è‚É£ Tap another tube to place it<br>3Ô∏è‚É£ Sort all gems by color ‚Äî one color per tube!<br><br>üí° <b>Tip:</b> Use the Hint button if you're stuck! üí°</div>
    <button onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="var o=document.getElementById('tutorial-overlay');if(o)o.remove();localStorage.setItem('color-sort-tutorial-seen','1');" ontouchend="event.preventDefault();var o=document.getElementById('tutorial-overlay');if(o)o.remove();localStorage.setItem('color-sort-tutorial-seen','1');" style="background:rgba(176,224,255,.2);border:2px solid rgba(176,224,255,.5);color:#d0f0ff;border-radius:12px;padding:14px 36px;font-size:18px;font-weight:bold;cursor:pointer;box-shadow:0 4px 15px rgba(176,224,255,0.2);transition:transform 0.2s;user-select:none;-webkit-user-select:none;touch-action:manipulation">Got it! ‚ùÑÔ∏è</button>
  </div>
</div>
<script>
(function(){
  var ov=document.getElementById('tutorial-overlay');
  if(!localStorage.getItem('color-sort-tutorial-seen')){
    if(ov)ov.style.display='flex';
    function closeTut(e){if(ov)ov.style.display='none';localStorage.setItem('color-sort-tutorial-seen','1');}
    if(ov){ov.addEventListener('touchend',function(e){e.preventDefault();closeTut();});ov.addEventListener('click',closeTut);}
  }else{if(ov)ov.style.display='none';}
})();
</script>

  <script src="../game-audio-auto.js?v=5"></script>
<script src="../sound-toggle.js?v=5"></script>
</body>
</html>
