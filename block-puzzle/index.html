<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Block Puzzle</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
body{background:#1a1a2e;color:#eee;font-family:'Segoe UI',system-ui,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;overflow-x:hidden}
#header{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:420px;padding:12px 8px}
#header h1{font-size:1.4em;background:linear-gradient(135deg,#e94560,#0f3460);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:800}
.score-box{text-align:center}
.score-box .label{font-size:.65em;text-transform:uppercase;color:#888;letter-spacing:1px}
.score-box .val{font-size:1.3em;font-weight:700;color:#e94560}
#game-area{position:relative}
#board{display:grid;grid-template-columns:repeat(10,1fr);gap:2px;padding:2px;background:#16213e;border-radius:8px;border:2px solid #0f3460;touch-action:none}
.cell{aspect-ratio:1;background:#1a1a2e;border-radius:3px;transition:background .15s,opacity .3s,transform .3s}
.cell.filled{border-radius:4px}
.cell.preview{background:rgba(233,69,96,.35)!important;border-radius:4px}
.cell.invalid{background:rgba(255,0,0,.25)!important}
.cell.clearing{animation:clearAnim .5s ease-out forwards}
@keyframes clearAnim{
  0%{background:#fff;transform:scale(1.2);opacity:1;box-shadow:0 0 12px #fff}
  30%{background:#ffe066;transform:scale(1.1);box-shadow:0 0 8px #ffe066}
  60%{background:#e94560;transform:scale(0.9);opacity:0.6}
  100%{transform:scale(0);opacity:0}
}
.cell.placed{animation:placeAnim .2s ease-out}
@keyframes placeAnim{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
#pieces-area{display:flex;justify-content:center;gap:12px;padding:16px 0;min-height:100px;align-items:center}
.piece-container{padding:6px;border-radius:8px;cursor:grab;touch-action:none;transition:transform .15s,opacity .15s}
.piece-container:active{cursor:grabbing}
.piece-container.used{opacity:.15;pointer-events:none}
.piece-container .piece-grid{display:grid;gap:1px}
.piece-grid .mini-cell{width:100%;aspect-ratio:1;border-radius:2px}
#drag-ghost{position:fixed;pointer-events:none;z-index:1000;display:none}
#drag-ghost .piece-grid{display:grid;gap:2px}
#drag-ghost .mini-cell{aspect-ratio:1;border-radius:3px}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;justify-content:center;align-items:center;z-index:999;backdrop-filter:blur(4px)}
#overlay.show{display:flex}
#overlay .modal{background:#16213e;border-radius:16px;padding:32px;text-align:center;border:2px solid #0f3460;max-width:300px}
#overlay .modal h2{font-size:1.6em;margin-bottom:8px;color:#e94560}
#overlay .modal p{margin:8px 0;color:#aaa}
#overlay .modal .final-score{font-size:2.2em;font-weight:800;color:#fff;margin:12px 0}
#overlay .modal button{margin-top:16px;padding:12px 32px;font-size:1.1em;font-weight:700;border:none;border-radius:8px;background:linear-gradient(135deg,#e94560,#c23152);color:#fff;cursor:pointer;transition:transform .1s}
#overlay .modal button:active{transform:scale(.95)}
#combo-display{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:998;font-size:2.5em;font-weight:900;color:#ffe066;text-shadow:0 0 20px rgba(255,224,102,.8),2px 2px 4px rgba(0,0,0,.5);opacity:0;transition:none}
@keyframes comboAnim{
  0%{opacity:0;transform:translate(-50%,-50%) scale(0.3)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1.3)}
  40%{transform:translate(-50%,-50%) scale(1)}
  80%{opacity:1;transform:translate(-50%,-60%) scale(1)}
  100%{opacity:0;transform:translate(-50%,-80%) scale(0.8)}
}
</style>
</head>
<body>
<a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:rgba(0,0,0,0.85);color:#4ecdc4;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none">â¬… More Games at GameZipper.com</a>
<div id="header">
  <h1>Block Puzzle</h1>
  <div class="score-box"><div class="label">Score</div><div class="val" id="score">0</div></div>
  <div class="score-box"><div class="label">Best</div><div class="val" id="best">0</div></div>
</div>
<div id="game-area">
  <div id="board"></div>
</div>
<div id="pieces-area"></div>
<div id="drag-ghost"><div class="piece-grid"></div></div>
<div id="combo-display"></div>
<div id="overlay"><div class="modal">
  <h2>Game Over</h2>
  <p>Your Score</p>
  <div class="final-score" id="final-score">0</div>
  <p id="new-best" style="color:#e94560;font-weight:700;display:none">ðŸŽ‰ New Best!</p>
  <button id="btn-again">Play Again</button>
</div></div>

<script>
(()=>{
const COLS=10,ROWS=10;

// Shape-specific colors: each shape index gets a distinct color
const SHAPE_COLORS=[
  '#e74c3c','#e74c3c',  // 1-cell, 2-h
  '#3498db','#3498db',  // 2-v, 3-h
  '#2ecc71','#2ecc71',  // 3-v, 2x2
  '#f39c12','#f39c12',  // L shapes
  '#9b59b6','#9b59b6',  // reverse L
  '#e67e22','#e67e22',  // small L
  '#1abc9c','#1abc9c',  // reverse small L
  '#e74c3c','#e74c3c',  // T shapes
  '#3498db','#3498db',  // T rotations
  '#f1c40f','#f1c40f',  // 4-line
  '#e94560',            // 5-line h
  '#0f3460',            // 5-line v
  '#9b59b6',            // 3x3 block
];

const SHAPES=[
  [[1]],
  [[1,1]],
  [[1],[1]],
  [[1,1,1]],
  [[1],[1],[1]],
  [[1,1],[1,1]],
  [[1,1,1],[0,0,1]],
  [[1,1,1],[1,0,0]],
  [[0,0,1],[1,1,1]],
  [[1,0,0],[1,1,1]],
  [[1,1],[0,1]],
  [[1,1],[1,0]],
  [[0,1],[1,1]],
  [[1,0],[1,1]],
  [[1,1,1],[0,1,0]],
  [[0,1,0],[1,1,1]],
  [[1,0],[1,1],[1,0]],
  [[0,1],[1,1],[0,1]],
  [[1,1,1,1]],
  [[1],[1],[1],[1]],
  [[1,1,1,1,1]],
  [[1],[1],[1],[1],[1]],
  [[1,1,1],[1,1,1],[1,1,1]],
];

// Web Audio
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playPlaceSound(){
  if(audioCtx.state==='suspended')audioCtx.resume();
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';
  o.frequency.setValueAtTime(600,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(400,audioCtx.currentTime+0.08);
  g.gain.setValueAtTime(0.12,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.1);
  o.connect(g);g.connect(audioCtx.destination);
  o.start();o.stop(audioCtx.currentTime+0.1);
}
function playClearSound(combo){
  if(audioCtx.state==='suspended')audioCtx.resume();
  const baseFreq=800+combo*200;
  for(let i=0;i<3;i++){
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(baseFreq+i*300,audioCtx.currentTime+i*0.08);
    g.gain.setValueAtTime(0.15,audioCtx.currentTime+i*0.08);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+i*0.08+0.25);
    o.connect(g);g.connect(audioCtx.destination);
    o.start(audioCtx.currentTime+i*0.08);
    o.stop(audioCtx.currentTime+i*0.08+0.25);
  }
}

let grid=[], score=0, best=+localStorage.getItem('bp_best')||0;
let pieces=[], dragPiece=null, dragIdx=-1;
let comboCount=0; // track consecutive clears
const boardEl=document.getElementById('board');
const piecesEl=document.getElementById('pieces-area');
const ghostEl=document.getElementById('drag-ghost');
const scoreEl=document.getElementById('score');
const bestEl=document.getElementById('best');
const overlayEl=document.getElementById('overlay');
const finalEl=document.getElementById('final-score');
const newBestEl=document.getElementById('new-best');
const comboEl=document.getElementById('combo-display');

let cellSize=0, boardRect=null;

function init(){
  grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));
  score=0; comboCount=0; scoreEl.textContent='0';
  bestEl.textContent=best;
  overlayEl.classList.remove('show');
  buildBoard();
  spawnPieces();
  resize();
}

function buildBoard(){
  boardEl.innerHTML='';
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const d=document.createElement('div');
    d.className='cell';d.dataset.r=r;d.dataset.c=c;
    boardEl.appendChild(d);
  }
}

function renderBoard(){
  const cells=boardEl.children;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    const cell=cells[r*COLS+c];
    const v=grid[r][c];
    cell.style.background=v?v:'';
    cell.classList.toggle('filled',!!v);
  }
}

function resize(){
  const maxW=Math.min(420,window.innerWidth-16);
  cellSize=Math.floor((maxW-22)/COLS);
  const bw=cellSize*COLS+22;
  boardEl.style.width=bw+'px';
  boardEl.style.height=bw+'px';
  boardRect=boardEl.getBoundingClientRect();
  renderPieces();
}
window.addEventListener('resize',resize);

function spawnPieces(){
  pieces=[];
  for(let i=0;i<3;i++){
    const shapeIdx=Math.random()*SHAPES.length|0;
    const shape=SHAPES[shapeIdx];
    pieces.push({shape,color:SHAPE_COLORS[shapeIdx],used:false});
  }
  renderPieces();
  checkGameOver();
}

function renderPieces(){
  piecesEl.innerHTML='';
  const miniSize=Math.min(22,Math.floor((window.innerWidth-80)/15));
  pieces.forEach((p,i)=>{
    const cont=document.createElement('div');
    cont.className='piece-container'+(p.used?' used':'');
    cont.dataset.idx=i;
    const rows=p.shape.length,cols=p.shape[0].length;
    const g=document.createElement('div');
    g.className='piece-grid';
    g.style.gridTemplateColumns=`repeat(${cols},${miniSize}px)`;
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      const d=document.createElement('div');
      d.className='mini-cell';
      d.style.background=p.shape[r][c]?p.color:'transparent';
      d.style.width=miniSize+'px';
      g.appendChild(d);
    }
    cont.appendChild(g);
    if(!p.used){
      cont.addEventListener('mousedown',e=>startDrag(e,i));
      cont.addEventListener('touchstart',e=>startDrag(e,i),{passive:false});
    }
    piecesEl.appendChild(cont);
  });
}

function startDrag(e,idx){
  if(pieces[idx].used)return;
  e.preventDefault();
  if(audioCtx.state==='suspended')audioCtx.resume();
  dragPiece=pieces[idx]; dragIdx=idx;
  const ghost=ghostEl;
  const s=cellSize;
  const shape=dragPiece.shape;
  const rows=shape.length,cols=shape[0].length;
  const g=ghost.querySelector('.piece-grid');
  g.innerHTML='';
  g.style.gridTemplateColumns=`repeat(${cols},${s}px)`;
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const d=document.createElement('div');
    d.className='mini-cell';
    d.style.width=s+'px';d.style.height=s+'px';
    d.style.background=shape[r][c]?dragPiece.color:'transparent';
    g.appendChild(d);
  }
  ghost.style.display='block';
  moveGhost(e);
}

function moveGhost(e){
  const t=e.touches?e.touches[0]:e;
  const shape=dragPiece.shape;
  const rows=shape.length,cols=shape[0].length;
  const offsetY=cellSize*rows/2+60;
  ghostEl.style.left=(t.clientX-cellSize*cols/2)+'px';
  ghostEl.style.top=(t.clientY-offsetY)+'px';
  showPreview(t.clientX,t.clientY-60);
}

function showPreview(px,py){
  clearPreview();
  boardRect=boardEl.getBoundingClientRect();
  const shape=dragPiece.shape;
  const rows=shape.length,cols=shape[0].length;
  const gc=cellSize+(2);
  const col=Math.round((px-boardRect.left-2-cellSize/2)/gc);
  const row=Math.round((py-boardRect.top-2-cellSize/2)/gc);
  const valid=canPlace(shape,row,col);
  const cells=boardEl.children;
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    if(!shape[r][c])continue;
    const rr=row+r,cc=col+c;
    if(rr>=0&&rr<ROWS&&cc>=0&&cc<COLS){
      cells[rr*COLS+cc].classList.add(valid?'preview':'invalid');
    }
  }
}

function clearPreview(){
  for(const c of boardEl.children){c.classList.remove('preview','invalid');}
}

function canPlace(shape,row,col){
  for(let r=0;r<shape.length;r++)for(let c=0;c<shape[0].length;c++){
    if(!shape[r][c])continue;
    const rr=row+r,cc=col+c;
    if(rr<0||rr>=ROWS||cc<0||cc>=COLS||grid[rr][cc])return false;
  }
  return true;
}

function canPlaceAnywhere(shape){
  for(let r=0;r<=ROWS-shape.length;r++)
    for(let c=0;c<=COLS-shape[0].length;c++)
      if(canPlace(shape,r,c))return true;
  return false;
}

function endDrag(e){
  if(!dragPiece)return;
  const t=e.changedTouches?e.changedTouches[0]:e;
  const py=t.clientY-60;
  boardRect=boardEl.getBoundingClientRect();
  const shape=dragPiece.shape;
  const gc=cellSize+2;
  const col=Math.round((t.clientX-boardRect.left-2-cellSize/2)/gc);
  const row=Math.round((py-boardRect.top-2-cellSize/2)/gc);
  if(canPlace(shape,row,col)){
    placePiece(shape,row,col,dragPiece.color);
    pieces[dragIdx].used=true;
    renderPieces();
    playPlaceSound();
    clearLines();
    if(pieces.every(p=>p.used))spawnPieces();
    else checkGameOver();
  }
  clearPreview();
  ghostEl.style.display='none';
  dragPiece=null;dragIdx=-1;
}

function placePiece(shape,row,col,color){
  const cells=boardEl.children;
  for(let r=0;r<shape.length;r++)for(let c=0;c<shape[0].length;c++){
    if(!shape[r][c])continue;
    grid[row+r][col+c]=color;
    const cell=cells[(row+r)*COLS+(col+c)];
    cell.style.background=color;
    cell.classList.add('filled','placed');
    setTimeout(()=>cell.classList.remove('placed'),200);
  }
}

function showCombo(n){
  comboEl.textContent='COMBO x'+n+'!';
  comboEl.style.animation='none';
  void comboEl.offsetWidth;
  comboEl.style.animation='comboAnim 1.2s ease-out forwards';
}

function clearLines(){
  let cleared=[];
  for(let r=0;r<ROWS;r++)if(grid[r].every(v=>v))cleared.push({type:'r',i:r});
  for(let c=0;c<COLS;c++){let full=true;for(let r=0;r<ROWS;r++)if(!grid[r][c]){full=false;break;}if(full)cleared.push({type:'c',i:c});}
  if(!cleared.length){comboCount=0;return;}
  comboCount++;
  const n=cleared.length;
  const pts=n===1?10:n*10*n;
  const comboBonus=comboCount>1?comboCount*5:0;
  score+=pts+comboBonus;scoreEl.textContent=score;
  if(score>best){best=score;localStorage.setItem('bp_best',best);bestEl.textContent=best;}
  playClearSound(comboCount);
  if(comboCount>=2) showCombo(comboCount);

  const toClear=new Set();
  for(const l of cleared){
    if(l.type==='r')for(let c=0;c<COLS;c++)toClear.add(l.i*COLS+c);
    else for(let r=0;r<ROWS;r++)toClear.add(r*COLS+l.i);
  }
  const cells=boardEl.children;
  let delay=0;
  for(const idx of toClear){
    const r=idx/COLS|0,c=idx%COLS;
    grid[r][c]=0;
    setTimeout(()=>{
      cells[idx].classList.add('clearing');
      cells[idx].classList.remove('filled');
    },delay);
    delay+=20;
    setTimeout(()=>{
      cells[idx].classList.remove('clearing');
      cells[idx].style.background='';
    },delay+500);
  }
}

function checkGameOver(){
  for(const p of pieces){
    if(p.used)continue;
    if(canPlaceAnywhere(p.shape))return;
  }
  if(pieces.some(p=>!p.used))gameOver();
}

function gameOver(){
  finalEl.textContent=score;
  if(score>=best){newBestEl.style.display='block';}else{newBestEl.style.display='none';}
  overlayEl.classList.add('show');

}

document.addEventListener('mousemove',e=>{if(dragPiece)moveGhost(e);});
document.addEventListener('mouseup',e=>{if(dragPiece)endDrag(e);});
document.addEventListener('touchmove',e=>{if(dragPiece){e.preventDefault();moveGhost(e);}},{passive:false});
document.addEventListener('touchend',e=>{if(dragPiece)endDrag(e);});

document.getElementById('btn-again').addEventListener('click',init);

init();
})();
</script>
</body>
</html>
