<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Kitty's Caf√© - Merge & Build Cat Cafe Game | GameZipper</title>
<meta name="description" content="Adopt a stray kitty and build the cutest cat caf√©! Merge coffee beans, milk and treats to fulfill customer orders. Free cat cafe merge game ‚Äî play instantly!">
<meta name="keywords" content="cat cafe game, merge cafe, kitty restaurant, casual game, merge game, cat game, coffee game">
<meta property="og:title" content="Kitty's Caf√© - Merge & Build Cat Cafe Game">
<meta property="og:description" content="Adopt a stray kitty and run the cutest cat caf√©! Merge items, fulfill orders, unlock new areas.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://gamezipper.com/kitty-cafe/">
<link rel="canonical" href="https://gamezipper.com/kitty-cafe/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
<script src="../game-audio.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#FFF8E7;touch-action:none;user-select:none;-webkit-user-select:none}
canvas{display:block;touch-action:none}
#wrap{display:flex;flex-direction:column;align-items:center;height:100%;width:100%}
#topbar{width:100%;background:linear-gradient(90deg,#8B6914,#A0792A,#8B6914);color:#FFF8E7;text-align:center;padding:6px;font-size:14px;z-index:99999;display:flex;justify-content:center;align-items:center;gap:8px}
#topbar a{color:#FFD700;text-decoration:none;font-weight:bold}
#game-area{flex:1;display:flex;align-items:center;justify-content:center;width:100%;position:relative;overflow:hidden}
#footer{width:100%;text-align:center;padding:6px;font-size:12px;color:#8B6914;background:#FFF0D0}
#footer a{color:#8B6914;text-decoration:underline}
#tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100000;display:flex;align-items:center;justify-content:center}
#tutorial-box{background:#FFF8E7;border-radius:20px;padding:28px 22px;max-width:340px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);border:3px solid #FF9AAD}
#tutorial-box h2{color:#8B6914;font-size:22px;margin-bottom:14px}
#tutorial-box p{color:#6B5010;font-size:16px;line-height:1.8;margin-bottom:6px}
#tutorial-box button{background:linear-gradient(135deg,#FF9AAD,#FFB6C1);color:#fff;border:none;padding:16px 44px;border-radius:30px;font-size:20px;font-weight:700;cursor:pointer;margin-top:16px;box-shadow:0 4px 12px rgba(255,154,173,0.4);touch-action:manipulation;-webkit-user-select:none}
#tutorial-box button:active{transform:scale(0.95)}
#cookie-banner{position:fixed;bottom:0;left:0;right:0;background:rgba(139,105,20,0.95);color:#FFF8E7;padding:10px 16px;font-size:13px;z-index:99998;display:flex;align-items:center;justify-content:space-between;gap:10px}
#cookie-banner button{background:#FFD700;color:#8B6914;border:none;padding:8px 18px;border-radius:12px;font-weight:700;cursor:pointer;white-space:nowrap}
</style>
</head>
<body>
<div id="wrap">
<div id="topbar"><a href="https://gamezipper.com/">üêæ ‚Üê GameZipper</a></div>
<div id="game-area"><canvas id="c"></canvas></div>
<div id="footer"><a href="https://gamezipper.com/">GameZipper.com</a> ‚Äî More Free Games! üê±</div>
</div>

<div id="tutorial-overlay" style="display:none">
<div id="tutorial-box">
<div style="font-size:48px;margin-bottom:8px">üê±‚òï</div>
<h2>Welcome to Kitty's Caf√©!</h2>
<p>üëÜ <b>Tap</b> an item, then <b>tap</b> a matching neighbor to merge!</p>
<p>‚ÜîÔ∏è Or <b>drag</b> onto a matching item!</p>
<p>üìã Merge to create what customers order!</p>
<p>üè† Earn coins to unlock new caf√© areas!</p>
<p style="font-size:13px;color:#999;margin-top:8px">üí° Glowing items = can be merged!</p>
<button id="tutorial-btn" ontouchend="closeTutorial()" onclick="closeTutorial()">Got it! üêæ</button>
</div>
</div>

<div id="cookie-banner" style="display:none">
<span>üç™ We use cookies for saving your game progress.</span>
<button onclick="document.getElementById('cookie-banner').style.display='none';localStorage.setItem('kc_cookie','1')">OK</button>
</div>

<script>
// Touch guard: only preventDefault on canvas
document.addEventListener('touchmove',function(e){if(e.target.tagName==='CANVAS')e.preventDefault();},{passive:false});
document.addEventListener('touchstart',function(e){if(e.target.tagName==='CANVAS')e.preventDefault();},{passive:false});

function closeTutorial(){
  document.getElementById('tutorial-overlay').style.display='none';
  localStorage.setItem('kc_tutorial','1');
  if(typeof GameAudio!=='undefined') GameAudio.playBGM('kitty-cafe');
}
if(!localStorage.getItem('kc_tutorial')) document.getElementById('tutorial-overlay').style.display='flex';
if(!localStorage.getItem('kc_cookie')) document.getElementById('cookie-banner').style.display='flex';

// ===== GAME ENGINE =====
(function(){
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const dpr=Math.min(window.devicePixelRatio||1,2);

// --- Items ---
// Coffee: 0‚Üí1‚Üí2‚Üí3, Milk: 4‚Üí5‚Üí6
const ITEMS=[
  {name:'Bean',emoji:'ü´ò',color:'#8B4513',chain:0,tier:0},
  {name:'Espresso',emoji:'‚òï',color:'#5C2D00',chain:0,tier:1},
  {name:'Latte',emoji:'ü•õ',color:'#D4A574',chain:0,tier:2},
  {name:'Mocha',emoji:'üç´',color:'#3E1F00',chain:0,tier:3},
  {name:'Milk',emoji:'üßã',color:'#E8E0D0',chain:1,tier:0},
  {name:'Cream',emoji:'üç¶',color:'#FFFACD',chain:1,tier:1},
  {name:'Cake',emoji:'üç∞',color:'#FFB6C1',chain:1,tier:2},
];

function mergeResult(id){
  const it=ITEMS[id];
  if(it.chain===0&&it.tier<3) return id+1;
  if(it.chain===1&&it.tier<2) return id+1;
  return -1;
}

// --- State ---
const GRID=6;
let cellSize,gridX,gridY,W,H;
let grid=[], coins=0, level=1, totalMerges=0;
let unlockedAreas=['Main Hall'];
let customers=[], particles=[], floatingTexts=[], anims=[];
let selectedCell=null, dragCell=null, dragPos=null;
let gameTime=0, screenShake=0, showStory=null;
let hintCells=[]; // cells that can merge
let hintTimer=0;

const AREAS=[
  {name:'Main Hall',cost:0,story:"A little stray kitten found shelter under a broken caf√© awning.\nShe cleaned the dusty counter with her tiny paws\nand waited for someone who'd believe in second chances. üê±"},
  {name:'Terrace',cost:500,story:"With the terrace open, Kitty discovered a sunny spot\nwhere butterflies danced among potted flowers.\nShe'd sit there each morning, purring with contentment. ü¶ã"},
  {name:'Garden',cost:1500,story:"The garden bloomed with catnip and lavender.\nKitty befriended a shy hedgehog who visited at dusk.\nTwo small souls finding magic in simple evenings. üåø"},
  {name:'VIP Floor',cost:3000,story:"The VIP floor sparkled with fairy lights and velvet cushions.\nFrom stray to caf√© queen ‚Äî but her favorite spot?\nStill the old cardboard box where it all began. üëë"}
];

// --- Save ---
function loadSave(){
  try{const s=JSON.parse(localStorage.getItem('kc_save2'));
  if(s){coins=s.c||0;level=s.l||1;unlockedAreas=s.a||['Main Hall'];totalMerges=s.m||0;}}catch(e){}
}
function save(){localStorage.setItem('kc_save2',JSON.stringify({c:coins,l:level,a:unlockedAreas,m:totalMerges}));}

// --- Grid ---
function initGrid(){
  grid=[];
  for(let r=0;r<GRID;r++){grid[r]=[];for(let c=0;c<GRID;c++) grid[r][c]=randomItem();}
  ensureMerges();
}
function randomItem(){
  // No dead items! Only mergeable base items
  const pool=[0,0,0,4,4]; // beans and milk
  if(level>=3) pool.push(0,4);
  if(level>=5) pool.push(1,5); // some espresso/cream for variety
  return pool[Math.floor(Math.random()*pool.length)];
}
function ensureMerges(){
  // Make sure at least 3 merge pairs exist
  let pairs=countMergePairs();
  let safety=0;
  while(pairs<3&&safety<50){
    const r=Math.floor(Math.random()*GRID);
    const c=Math.floor(Math.random()*(GRID-1));
    const item=randomItem();
    grid[r][c]=item; grid[r][c+1]=item;
    pairs=countMergePairs();
    safety++;
  }
}
function countMergePairs(){
  let count=0;
  for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
    if(c<GRID-1&&grid[r][c]===grid[r][c+1]&&grid[r][c]>=0&&mergeResult(grid[r][c])>=0) count++;
    if(r<GRID-1&&grid[r][c]===grid[r+1][c]&&grid[r][c]>=0&&mergeResult(grid[r][c])>=0) count++;
  }
  return count;
}
function updateHints(){
  hintCells=[];
  for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
    if(grid[r][c]<0) continue;
    if(mergeResult(grid[r][c])<0) continue;
    // Check neighbors
    const dirs=[[0,1],[0,-1],[1,0],[-1,0]];
    for(const[dr,dc] of dirs){
      const nr=r+dr,nc=c+dc;
      if(nr>=0&&nr<GRID&&nc>=0&&nc<GRID&&grid[nr][nc]===grid[r][c]){
        hintCells.push({r,c}); break;
      }
    }
  }
}

// --- Customers ---
function spawnCustomer(){
  if(customers.length>=3) return;
  const orders=[];
  const numItems=Math.min(1+Math.floor(level/4),3);
  // Only order items that can actually be created by merging
  const orderPool=[1,1,2,5]; // espresso, latte, cream
  if(level>=3) orderPool.push(2,6); // latte, cake
  if(level>=6) orderPool.push(3); // mocha
  for(let i=0;i<numItems;i++){
    const max=Math.min(orderPool.length,2+Math.floor(level/2));
    orders.push(orderPool[Math.floor(Math.random()*max)]);
  }
  const time=40+15*orders.length-level*1.5;
  customers.push({orders,timer:Math.max(time,20),maxTimer:Math.max(time,20),slideIn:0});
}

// --- Resize ---
function resize(){
  const area=document.getElementById('game-area');
  const aw=area.clientWidth, ah=area.clientHeight;
  W=Math.min(aw,480); H=ah;
  // Grid uses more screen: 60% height
  const maxGridH=H*0.52;
  const maxGridW=W*0.92;
  cellSize=Math.floor(Math.min(maxGridW/GRID, maxGridH/GRID));
  cellSize=Math.max(cellSize,44); // minimum 44px for touch targets
  cellSize=Math.min(cellSize,90);
  gridX=Math.floor((W-GRID*cellSize)/2);
  gridY=Math.floor(H*0.40);
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
  canvas.width=W*dpr; canvas.height=H*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

// --- Scaling helper ---
function S(base){ return Math.max(base, base * cellSize/60); }

// --- Drawing ---
function drawBg(){
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#FFF8E7'); g.addColorStop(1,'#FFE8B8');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  // Paw prints
  ctx.globalAlpha=0.05; ctx.font=S(18)+'px serif';
  for(let i=0;i<10;i++) ctx.fillText('üêæ',(i*71+13)%W,(i*97+41)%(gridY-20));
  ctx.globalAlpha=1;
}

function drawInfo(){
  const y1=S(22), y2=y1+S(20);
  // Area name
  ctx.fillStyle='#8B6914'; ctx.textAlign='left';
  ctx.font='bold '+S(16)+'px sans-serif';
  ctx.fillText('üè† '+unlockedAreas[unlockedAreas.length-1],10,y1);
  // Level
  ctx.textAlign='right';
  ctx.fillText('Lv.'+level,W-10,y1);
  // Coins
  ctx.textAlign='center'; ctx.fillStyle='#DAA520';
  ctx.font='bold '+S(20)+'px sans-serif';
  ctx.fillText('ü™ô '+coins,W/2,y1);
  // Next unlock
  const next=AREAS.find(a=>!unlockedAreas.includes(a.name)&&a.cost>0);
  if(next){
    ctx.font=S(13)+'px sans-serif'; ctx.fillStyle='#999';
    ctx.fillText('Next: '+next.name+' ('+next.cost+'ü™ô)',W/2,y2);
  }
}

function drawCustomers(){
  const startY=gridY-S(70);
  const cw=Math.min((W-20)/3-6, 150);
  const ch=S(58);
  for(let i=0;i<customers.length;i++){
    const c=customers[i];
    c.slideIn=Math.min(c.slideIn+0.05,1);
    const cx=10+i*(cw+6);
    const slideOff=(1-c.slideIn)*-50;
    ctx.save(); ctx.translate(0,slideOff);
    const pct=c.timer/c.maxTimer;
    // Card
    ctx.fillStyle=pct>0.5?'#FFF5E0':pct>0.2?'#FFE8C0':'#FFD0D0';
    roundRect(ctx,cx,startY,cw,ch,10); ctx.fill();
    ctx.strokeStyle=pct>0.2?'#C9A84C':'#FF6666'; ctx.lineWidth=2;
    roundRect(ctx,cx,startY,cw,ch,10); ctx.stroke();
    // Cat icon
    ctx.font=S(20)+'px serif'; ctx.textAlign='left';
    ctx.fillText('üò∫',cx+6,startY+S(26));
    // Orders - BIG emoji
    ctx.font=S(22)+'px serif';
    let ox=cx+S(30);
    for(const oid of c.orders){
      ctx.fillText(ITEMS[oid].emoji,ox,startY+S(26));
      ox+=S(24);
    }
    // Timer bar
    const barY=startY+ch-S(12);
    ctx.fillStyle='#E8D5A8'; roundRect(ctx,cx+4,barY,(cw-8),S(8),4); ctx.fill();
    ctx.fillStyle=pct>0.5?'#98D8C8':pct>0.2?'#FFB347':'#FF6B6B';
    roundRect(ctx,cx+4,barY,Math.max((cw-8)*pct,0),S(8),4); ctx.fill();
    // Timer text
    ctx.fillStyle='#6B5010'; ctx.textAlign='right';
    ctx.font='bold '+S(12)+'px sans-serif';
    ctx.fillText(Math.ceil(c.timer)+'s',cx+cw-6,barY-2);
    ctx.textAlign='center';
    ctx.restore();
  }
}

function drawGrid(){
  const sx=screenShake>0?(Math.random()-0.5)*screenShake*6:0;
  const sy=screenShake>0?(Math.random()-0.5)*screenShake*6:0;
  ctx.save(); ctx.translate(sx,sy);
  // Grid bg
  ctx.fillStyle='#F5E6C8';
  roundRect(ctx,gridX-6,gridY-6,GRID*cellSize+12,GRID*cellSize+12,14); ctx.fill();
  ctx.strokeStyle='#E0CFA0'; ctx.lineWidth=2;
  roundRect(ctx,gridX-6,gridY-6,GRID*cellSize+12,GRID*cellSize+12,14); ctx.stroke();

  const t=gameTime*0.003;
  for(let r=0;r<GRID;r++) for(let c=0;c<GRID;c++){
    const x=gridX+c*cellSize, y=gridY+r*cellSize;
    // Cell bg
    ctx.fillStyle=(r+c)%2===0?'#FFF5E0':'#FFEED0';
    roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();

    // Hint glow for mergeable items
    const isHint=hintCells.some(h=>h.r===r&&h.c===c);
    if(isHint&&!selectedCell){
      const glow=0.15+0.1*Math.sin(t+r*2+c*3);
      ctx.fillStyle='rgba(255,200,50,'+glow+')';
      roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
    }

    // Selected highlight
    if(selectedCell&&selectedCell.r===r&&selectedCell.c===c){
      ctx.strokeStyle='#FF9AAD'; ctx.lineWidth=3;
      roundRect(ctx,x+1,y+1,cellSize-2,cellSize-2,9); ctx.stroke();
      // Highlight valid merge neighbors
      ctx.fillStyle='rgba(255,154,173,0.15)';
      roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
    }
    // Valid merge target highlight when selected
    if(selectedCell&&!(selectedCell.r===r&&selectedCell.c===c)){
      if(canMerge(selectedCell.r,selectedCell.c,r,c)){
        const pulse=0.2+0.15*Math.sin(t*2);
        ctx.fillStyle='rgba(152,216,200,'+pulse+')';
        roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
        ctx.strokeStyle='#98D8C8'; ctx.lineWidth=2;
        roundRect(ctx,x+3,y+3,cellSize-6,cellSize-6,7); ctx.stroke();
      }
    }

    // Item
    const id=grid[r][c];
    if(id>=0&&!(dragCell&&dragCell.r===r&&dragCell.c===c)){
      // Animation check
      const anim=anims.find(a=>a.r===r&&a.c===c);
      let scale=1, alpha=1;
      if(anim){
        const p=anim.t/anim.dur;
        if(anim.type==='pop') {scale=0.3+0.7*easeOutBack(p); alpha=p;}
        if(anim.type==='squash'){const s=1-0.3*Math.sin(p*Math.PI); scale=s;}
      }
      ctx.save(); ctx.globalAlpha=alpha;
      ctx.translate(x+cellSize/2, y+cellSize/2);
      ctx.scale(scale,scale);
      drawItem(0,0,id,cellSize*0.8);
      ctx.restore();
    }
  }
  // Drag item
  if(dragCell&&dragPos&&grid[dragCell.r]&&grid[dragCell.r][dragCell.c]>=0){
    ctx.globalAlpha=0.9;
    drawItem(dragPos.x,dragPos.y,grid[dragCell.r][dragCell.c],cellSize*0.9);
    ctx.globalAlpha=1;
    // Highlight drop target
    const target=getCellFromPos(dragPos.x,dragPos.y);
    if(target&&canMerge(dragCell.r,dragCell.c,target.r,target.c)){
      const tx=gridX+target.c*cellSize, ty=gridY+target.r*cellSize;
      ctx.fillStyle='rgba(152,216,200,0.3)';
      roundRect(ctx,tx+2,ty+2,cellSize-4,cellSize-4,8); ctx.fill();
    }
  }
  ctx.restore();
}

function drawItem(x,y,id,size){
  const it=ITEMS[id];
  // BIG emoji - this is the main visual
  const emojiSize=Math.floor(size*0.6);
  ctx.font=emojiSize+'px serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(it.emoji,x,y-2);
  // Name below - readable size!
  const nameSize=Math.max(Math.floor(size*0.22),11);
  ctx.font='bold '+nameSize+'px sans-serif';
  ctx.fillStyle='#6B5010';
  ctx.fillText(it.name,x,y+size*0.35);
  ctx.textBaseline='alphabetic';
}

function drawCat(){
  // Small cat in corner - doesn't take game space
  const cx=W-30, cy=gridY-20;
  const t=gameTime*0.001;
  const s=0.6; // small scale
  ctx.save(); ctx.translate(cx,cy); ctx.scale(s,s);
  // Body
  ctx.fillStyle='#FFB366';
  ctx.beginPath(); ctx.ellipse(0,20,18,22,0,0,Math.PI*2); ctx.fill();
  // Head
  ctx.beginPath(); ctx.arc(0,-5,16,0,Math.PI*2); ctx.fill();
  // Ears
  const et=Math.sin(t*2)*2;
  ctx.beginPath(); ctx.moveTo(-12,-15); ctx.lineTo(-8+et,-30); ctx.lineTo(-2,-14); ctx.fill();
  ctx.beginPath(); ctx.moveTo(12,-15); ctx.lineTo(8-et,-30); ctx.lineTo(2,-14); ctx.fill();
  ctx.fillStyle='#FF9AAD';
  ctx.beginPath(); ctx.moveTo(-10,-16); ctx.lineTo(-7+et*0.5,-26); ctx.lineTo(-3,-15); ctx.fill();
  ctx.beginPath(); ctx.moveTo(10,-16); ctx.lineTo(7-et*0.5,-26); ctx.lineTo(3,-15); ctx.fill();
  // Eyes
  ctx.fillStyle='#333';
  ctx.beginPath(); ctx.arc(-6,-6,2.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(6,-6,2.5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.arc(-5,-7,1,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(7,-7,1,0,Math.PI*2); ctx.fill();
  // Nose + mouth
  ctx.fillStyle='#FF9AAD';
  ctx.beginPath(); ctx.moveTo(0,-1); ctx.lineTo(-2,1); ctx.lineTo(2,1); ctx.fill();
  ctx.strokeStyle='#333'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(0,1); ctx.quadraticCurveTo(-4,5,-6,3); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,1); ctx.quadraticCurveTo(4,5,6,3); ctx.stroke();
  // Tail
  ctx.strokeStyle='#FFB366'; ctx.lineWidth=4; ctx.lineCap='round';
  const tw=Math.sin(t*3)*12;
  ctx.beginPath(); ctx.moveTo(14,30); ctx.quadraticCurveTo(28+tw,15,24+tw*0.7,0); ctx.stroke();
  ctx.restore();
}

function drawParticles(){
  for(const p of particles){
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    if(p.type==='confetti'){
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2);
      ctx.restore();
    }else if(p.type==='coin'){
      ctx.font=S(16)+'px serif'; ctx.textAlign='center'; ctx.fillText('ü™ô',p.x,p.y);
    }else{
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
  }
}

function drawFloatingTexts(){
  for(const ft of floatingTexts){
    ctx.globalAlpha=ft.life; ctx.fillStyle=ft.color;
    ctx.font='bold '+ft.size+'px sans-serif'; ctx.textAlign='center';
    ctx.fillText(ft.text,ft.x,ft.y);
    ctx.globalAlpha=1;
  }
}

function drawStory(){
  if(!showStory) return;
  ctx.fillStyle='rgba(0,0,0,0.75)'; ctx.fillRect(0,0,W,H);
  const bx=W*0.06,by=H*0.18,bw=W*0.88,bh=H*0.55;
  ctx.fillStyle='#FFF8E7'; roundRect(ctx,bx,by,bw,bh,16); ctx.fill();
  ctx.strokeStyle='#FF9AAD'; ctx.lineWidth=3;
  roundRect(ctx,bx,by,bw,bh,16); ctx.stroke();
  ctx.fillStyle='#8B6914'; ctx.textAlign='center';
  ctx.font='bold '+S(20)+'px sans-serif';
  ctx.fillText('üéâ '+showStory.name+' Unlocked!',W/2,by+S(36));
  ctx.font=S(14)+'px sans-serif'; ctx.fillStyle='#6B5010';
  const lines=showStory.story.split('\n');
  for(let i=0;i<lines.length;i++) ctx.fillText(lines[i],W/2,by+S(60)+i*S(22));
  // Button
  const btnW=120,btnH=40,btnX=W/2-btnW/2,btnY=by+bh-55;
  ctx.fillStyle='#FF9AAD'; roundRect(ctx,btnX,btnY,btnW,btnH,20); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold '+S(16)+'px sans-serif';
  ctx.fillText('Continue ‚ñ∂',W/2,btnY+btnH/2+S(5));
  showStory._btnX=btnX; showStory._btnY=btnY; showStory._btnW=btnW; showStory._btnH=btnH;
}

// --- FX ---
function spawnMerge(x,y,color){
  for(let i=0;i<20;i++){
    const a=Math.random()*Math.PI*2, sp=1.5+Math.random()*3;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,decay:0.02+Math.random()*0.02,size:3+Math.random()*5,color,type:'circle'});
  }
}
function spawnConfetti(x,y){
  const cols=['#FF9AAD','#98D8C8','#FFD700','#FF6B6B','#45B7D1','#A78BFA'];
  for(let i=0;i<30;i++){
    const a=Math.random()*Math.PI*2, sp=2+Math.random()*4;
    particles.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-3,life:1,decay:0.012,size:4+Math.random()*5,color:cols[i%cols.length],type:'confetti',rot:Math.random()*6,rotV:Math.random()*0.3-0.15});
  }
}
function spawnCoinRain(){
  for(let i=0;i<10;i++) setTimeout(()=>particles.push({x:Math.random()*W,y:-20,vx:0,vy:2+Math.random()*2,life:1,decay:0.006,size:16,color:'#FFD700',type:'coin'}),i*70);
}
function spawnFireworks(){
  for(let b=0;b<5;b++) setTimeout(()=>{
    const fx=W*0.2+Math.random()*W*0.6, fy=H*0.1+Math.random()*H*0.3;
    const col=['#FF9AAD','#98D8C8','#FFD700','#45B7D1','#A78BFA'][b%5];
    for(let i=0;i<30;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*4;
      particles.push({x:fx,y:fy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,decay:0.015+Math.random()*0.01,size:2+Math.random()*3,color:col,type:'circle'});}
    if(typeof GameAudio!=='undefined') GameAudio.play('explosion');
  },b*350);
}
function addFloat(x,y,text,color,size){floatingTexts.push({x,y,text,color,size:size||S(18),life:1,vy:-1.5});}

// --- Merge Logic ---
function canMerge(r1,c1,r2,c2){
  if(r1<0||r1>=GRID||c1<0||c1>=GRID||r2<0||r2>=GRID||c2<0||c2>=GRID) return false;
  if(Math.abs(r1-r2)+Math.abs(c1-c2)!==1) return false;
  const a=grid[r1][c1], b=grid[r2][c2];
  if(a<0||b<0||a!==b) return false;
  return mergeResult(a)>=0;
}

function doMerge(r1,c1,r2,c2){
  const id=grid[r1][c1], result=mergeResult(id);
  if(result<0) return;
  const x=gridX+(c2+0.5)*cellSize, y=gridY+(r2+0.5)*cellSize;
  grid[r1][c1]=-1; grid[r2][c2]=result;
  totalMerges++;
  spawnMerge(x,y,ITEMS[result].color);
  addFloat(x,y-cellSize*0.4,ITEMS[result].emoji+' '+ITEMS[result].name,'#8B6914',S(16));
  anims.push({type:'squash',r:r2,c:c2,t:0,dur:0.3});
  if(typeof GameAudio!=='undefined') GameAudio.play('merge');
  screenShake=0.3;
  setTimeout(()=>{fillEmpty();checkOrders();updateHints();},180);
}

function fillEmpty(){
  for(let r=0;r<GRID;r++) for(let c=0;c<GRID;c++){
    if(grid[r][c]<0){grid[r][c]=randomItem(); anims.push({type:'pop',r,c,t:0,dur:0.25});}
  }
  // Ensure playability
  if(countMergePairs()<2) ensureMerges();
}

function checkOrders(){
  const gridItems={};
  for(let r=0;r<GRID;r++) for(let c=0;c<GRID;c++){const id=grid[r][c]; if(id>=0) gridItems[id]=(gridItems[id]||0)+1;}

  for(let ci=customers.length-1;ci>=0;ci--){
    const cust=customers[ci];
    const needed={};
    for(const oid of cust.orders) needed[oid]=(needed[oid]||0)+1;
    let ok=true;
    for(const[id,cnt] of Object.entries(needed)) if((gridItems[+id]||0)<cnt){ok=false;break;}
    if(!ok) continue;

    // Fulfill! Remove items from grid
    for(const oid of cust.orders){
      outer: for(let r=0;r<GRID;r++) for(let c=0;c<GRID;c++){
        if(grid[r][c]===oid){grid[r][c]=-1; spawnMerge(gridX+(c+0.5)*cellSize,gridY+(r+0.5)*cellSize,ITEMS[oid].color); break outer;}
      }
    }
    const reward=15+cust.orders.length*8+level*3;
    coins+=reward;
    addFloat(W/2,gridY-S(10),'+'+reward+' ü™ô','#DAA520',S(24));
    spawnConfetti(W/2,gridY);
    spawnCoinRain();
    if(typeof GameAudio!=='undefined'){GameAudio.play('coin');setTimeout(()=>GameAudio.play('win'),200);}
    customers.splice(ci,1);

    if(customers.length===0){
      level++;
      addFloat(W/2,H*0.5,'Level '+level+'! üéâ','#FF9AAD',S(28));
      if(typeof GameAudio!=='undefined') GameAudio.play('levelup');
    }
    for(const area of AREAS){
      if(!unlockedAreas.includes(area.name)&&coins>=area.cost){
        unlockedAreas.push(area.name); showStory=area;
        spawnFireworks();
        if(typeof GameAudio!=='undefined') GameAudio.play('supernova');
      }
    }
    save(); fillEmpty();
  }
}

// --- Input ---
function getCellFromPos(px,py){
  const c=Math.floor((px-gridX)/cellSize), r=Math.floor((py-gridY)/cellSize);
  return(r>=0&&r<GRID&&c>=0&&c<GRID)?{r,c}:null;
}
function getPos(e){
  const rect=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]||e.changedTouches[0]:e;
  return{x:(t.clientX-rect.left)*(W/rect.width),y:(t.clientY-rect.top)*(H/rect.height)};
}

let touchStartCell=null, isDragging=false;

canvas.addEventListener('mousedown',onDown);
canvas.addEventListener('mousemove',onMove);
canvas.addEventListener('mouseup',onUp);
canvas.addEventListener('touchstart',onDown);
canvas.addEventListener('touchmove',onMove);
canvas.addEventListener('touchend',onUp);

function onDown(e){
  const pos=getPos(e);
  // Story popup
  if(showStory){
    if(showStory._btnX&&pos.x>=showStory._btnX&&pos.x<=showStory._btnX+showStory._btnW&&
       pos.y>=showStory._btnY&&pos.y<=showStory._btnY+showStory._btnH) showStory=null;
    return;
  }
  const cell=getCellFromPos(pos.x,pos.y);
  if(!cell||grid[cell.r][cell.c]<0) return;
  touchStartCell=cell;
  isDragging=false;
  dragPos=pos;
  if(typeof GameAudio!=='undefined') GameAudio.play('tap');
}

function onMove(e){
  if(!touchStartCell) return;
  const pos=getPos(e);
  const dx=pos.x-dragPos.x, dy=pos.y-dragPos.y;
  if(!isDragging&&Math.sqrt(dx*dx+dy*dy)>cellSize*0.3){
    isDragging=true;
    dragCell=touchStartCell;
  }
  if(isDragging) dragPos=pos;
}

function onUp(e){
  const pos=getPos(e);
  if(isDragging&&dragCell){
    // Drag merge
    const target=getCellFromPos(pos.x,pos.y);
    if(target&&canMerge(dragCell.r,dragCell.c,target.r,target.c)){
      doMerge(dragCell.r,dragCell.c,target.r,target.c);
      selectedCell=null;
    }
    dragCell=null; dragPos=null; touchStartCell=null; isDragging=false;
    return;
  }
  // Tap
  if(touchStartCell){
    const cell=touchStartCell;
    if(selectedCell){
      if(canMerge(selectedCell.r,selectedCell.c,cell.r,cell.c)){
        doMerge(selectedCell.r,selectedCell.c,cell.r,cell.c);
        selectedCell=null;
      }else if(selectedCell.r===cell.r&&selectedCell.c===cell.c){
        selectedCell=null; // deselect
      }else{
        selectedCell=cell; // select new
      }
    }else{
      selectedCell=cell;
    }
  }
  dragCell=null; dragPos=null; touchStartCell=null; isDragging=false;
}

// --- Update ---
function update(dt){
  gameTime+=dt;
  // Customer timers
  for(let i=customers.length-1;i>=0;i--){
    const c=customers[i];
    if(!showStory) c.timer-=dt/1000;
    if(c.timer<=0){
      customers.splice(i,1);
      addFloat(W/2,gridY-S(20),'üòø Left!','#FF6B6B',S(18));
      if(typeof GameAudio!=='undefined') GameAudio.play('error');
      screenShake=0.4;
    }
  }
  // Spawn
  if(!showStory){
    const maxC=Math.min(1+Math.floor(level/3),3);
    if(customers.length<maxC&&Math.random()<0.008) spawnCustomer();
    if(customers.length===0) spawnCustomer();
  }
  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=p.decay;
    if(p.rot!==undefined) p.rot+=p.rotV||0;
    if(p.life<=0) particles.splice(i,1);
  }
  // Texts
  for(let i=floatingTexts.length-1;i>=0;i--){
    const ft=floatingTexts[i]; ft.y+=ft.vy; ft.life-=0.012;
    if(ft.life<=0) floatingTexts.splice(i,1);
  }
  // Anims
  for(let i=anims.length-1;i>=0;i--){anims[i].t+=dt/1000; if(anims[i].t>=anims[i].dur) anims.splice(i,1);}
  // Shake
  if(screenShake>0) screenShake=Math.max(0,screenShake-dt*0.003);
  // Hint update
  hintTimer+=dt;
  if(hintTimer>1000){hintTimer=0; updateHints();}
}

// --- Main ---
let last=0;
function loop(ts){
  const dt=last?Math.min(ts-last,50):16; last=ts;
  update(dt);
  ctx.clearRect(0,0,W,H);
  drawBg(); drawInfo(); drawCustomers(); drawCat(); drawGrid();
  drawParticles(); drawFloatingTexts(); drawStory();
  requestAnimationFrame(loop);
}

function easeOutBack(t){const c1=1.70158,c3=c1+1;return 1+c3*Math.pow(t-1,3)+c1*Math.pow(t-1,2);}

loadSave(); initGrid(); resize(); updateHints();
window.addEventListener('resize',resize);
spawnCustomer();
document.addEventListener('click',function _b(){if(typeof GameAudio!=='undefined') GameAudio.playBGM('kitty-cafe');document.removeEventListener('click',_b);},{once:true});
requestAnimationFrame(loop);
})();

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}
</script>
</body>
</html>
