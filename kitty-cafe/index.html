<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Kitty's Caf√© - Merge & Build Cat Cafe Game | GameZipper</title>
<meta name="description" content="Adopt a stray kitty and build the cutest cat caf√©! Merge coffee beans, milk and treats to fulfill customer orders. Free cat cafe merge game ‚Äî play instantly!">
<meta name="keywords" content="cat cafe game, merge cafe, kitty restaurant, casual game, merge game, cat game, coffee game">
<meta property="og:title" content="Kitty's Caf√© - Merge & Build Cat Cafe Game">
<meta property="og:description" content="Adopt a stray kitty and run the cutest cat caf√©! Merge items, fulfill orders, unlock new areas.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://gamezipper.com/kitty-cafe/">
<link rel="canonical" href="https://gamezipper.com/kitty-cafe/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
<script src="../game-audio.js?v=8"></script>
  <script src="../game-audio-auto.js?v=8"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{padding-top:28px;width:100%;height:100%;overflow:hidden;background:#FFF8E7;touch-action:none;user-select:none;-webkit-user-select:none;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
canvas{display:block;touch-action:none}
#wrap{display:flex;flex-direction:column;align-items:center;height:100%;width:100%}
#topbar{width:100%;background:linear-gradient(90deg,#8B6914,#A0792A,#8B6914);color:#FFF8E7;text-align:center;padding:3px 8px;font-size:12px;z-index:99999;display:flex;justify-content:center;align-items:center;gap:8px;max-height:24px}
#topbar a{color:#FFD700;text-decoration:none;font-weight:bold}
#game-area{flex:1;display:flex;align-items:center;justify-content:center;width:100%;position:relative;overflow:hidden}
#footer{width:100%;text-align:center;padding:3px;font-size:11px;color:#8B6914;background:#FFF0D0;max-height:22px}
#footer a{color:#8B6914;text-decoration:underline}
#tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:100000;display:flex;align-items:center;justify-content:center}
#tutorial-box{background:#FFF8E7;border-radius:20px;padding:28px 22px;max-width:340px;width:90%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);border:3px solid #FF9AAD}
#tutorial-box h2{color:#8B6914;font-size:22px;margin-bottom:14px}
#tutorial-box p{color:#6B5010;font-size:16px;line-height:1.8;margin-bottom:6px}
#tutorial-box button{background:linear-gradient(135deg,#FF9AAD,#FFB6C1);color:#fff;border:none;padding:16px 44px;border-radius:30px;font-size:20px;font-weight:700;cursor:pointer;margin-top:16px;box-shadow:0 4px 12px rgba(255,154,173,0.4);touch-action:manipulation}
#tutorial-box button:active{transform:scale(0.95)}
#cookie-banner{position:fixed;bottom:0;left:0;right:0;background:rgba(139,105,20,0.95);color:#FFF8E7;padding:8px 12px;font-size:12px;z-index:99998;display:flex;align-items:center;justify-content:space-between;gap:8px}
#cookie-banner button{background:#FFD700;color:#8B6914;border:none;padding:6px 14px;border-radius:12px;font-weight:700;cursor:pointer;white-space:nowrap}
#merge-guide{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:100001;display:none;align-items:center;justify-content:center}
#merge-guide-box{background:#FFF8E7;border-radius:20px;padding:24px 20px;max-width:320px;width:88%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);border:3px solid #98D8C8}
#merge-guide-box h3{color:#8B6914;font-size:20px;margin-bottom:16px}
.chain{font-size:28px;margin:12px 0;letter-spacing:2px}
.chain-label{font-size:13px;color:#999;margin-bottom:4px}
#merge-guide-box button{background:linear-gradient(135deg,#98D8C8,#7BC8B8);color:#fff;border:none;padding:12px 36px;border-radius:24px;font-size:18px;font-weight:700;cursor:pointer;margin-top:16px;touch-action:manipulation}
</style>
</head>
<body>
<a href="https://gamezipper.com/" style="position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#1a1a2e,#16213e,#1a1a2e);color:#00d4ff;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none;border-bottom:2px solid #0a0a1a;text-shadow:0 0 8px rgba(0,212,255,.5)">‚ö° More Games at GameZipper.com</a>
<div id="wrap">
<div id="topbar"><a href="https://gamezipper.com/">üêæ GameZipper</a></div>
<div id="game-area"><canvas id="c"></canvas></div>
<div id="footer"><a href="https://gamezipper.com/">GameZipper.com</a> üê±</div>
</div>

<div id="tutorial-overlay" style="display:none">
<div id="tutorial-box">
<div style="font-size:48px;margin-bottom:8px">üê±‚òï</div>
<h2>Welcome to Kitty's Caf√©!</h2>
<p>üëÜ <b>Tap</b> an item, then <b>tap</b> a matching neighbor to merge!</p>
<p>‚ÜîÔ∏è Or <b>drag</b> onto a matching item!</p>
<p>üìã Merge to create what customers order!</p>
<p>üè† Earn coins to unlock new caf√© areas!</p>
<p style="font-size:13px;color:#999;margin-top:8px">üí° Tap ‚ùì for merge chains!</p>
<button id="tutorial-btn" ontouchend="event.preventDefault();closeTutorial()" onmousedown="closeTutorial()">Got it! üêæ</button>
</div>
</div>

<div id="merge-guide">
<div id="merge-guide-box">
<h3>‚òï Merge Chains</h3>
<div class="chain-label">Coffee Path</div>
<div class="chain">ü´ò ‚Üí ‚òï ‚Üí ü•õ ‚Üí üç´</div>
<div class="chain-label">Dessert Path</div>
<div class="chain">üßã ‚Üí üç¶ ‚Üí üç∞</div>
<p style="font-size:14px;color:#6B5010;margin-top:12px">Match 2 identical neighbors to merge up!</p>
<button ontouchend="event.preventDefault();document.getElementById('merge-guide').style.display='none'" onclick="document.getElementById('merge-guide').style.display='none'">Got it! ‚ú®</button>
</div>
</div>

<div id="cookie-banner" style="display:none">
<span>üç™ Cookies for saving progress.</span>
<button onclick="document.getElementById('cookie-banner').style.display='none';localStorage.setItem('kc_cookie','1')">OK</button>
</div>

<script>
document.addEventListener('touchmove',function(e){if(e.target.tagName==='CANVAS')e.preventDefault();},{passive:false});
document.addEventListener('touchstart',function(e){if(e.target.tagName==='CANVAS')e.preventDefault();},{passive:false});

function closeTutorial(){
  document.getElementById('tutorial-overlay').style.display='none';
  localStorage.setItem('kc_tutorial','1');
  if(typeof GameAudio!=='undefined') GameAudio.playBGM('kitty-cafe');
}
if(!localStorage.getItem('kc_tutorial')) document.getElementById('tutorial-overlay').style.display='flex';
if(!localStorage.getItem('kc_cookie')) document.getElementById('cookie-banner').style.display='flex';

(function(){
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const dpr=Math.min(window.devicePixelRatio||1,2);

// Items: Coffee chain 0‚Üí1‚Üí2‚Üí3, Dessert chain 4‚Üí5‚Üí6
const ITEMS=[
  {name:'Bean',emoji:'ü´ò',color:'#A0522D',bg:'#A0522D',chain:0,tier:0},
  {name:'Espresso',emoji:'‚òï',color:'#4A2800',bg:'#4A2800',chain:0,tier:1},
  {name:'Latte',emoji:'ü•õ',color:'#D4A574',bg:'#D4A574',chain:0,tier:2},
  {name:'Mocha',emoji:'üç´',color:'#3E1F00',bg:'#3E1F00',chain:0,tier:3},
  {name:'Milk',emoji:'üßã',color:'#87CEEB',bg:'#E0F0FF',chain:1,tier:0},
  {name:'Cream',emoji:'üç¶',color:'#DAA520',bg:'#FFF8DC',chain:1,tier:1},
  {name:'Cake',emoji:'üç∞',color:'#FF69B4',bg:'#FFB6C1',chain:1,tier:2},
];

function mergeResult(id){
  var it=ITEMS[id];
  if(it.chain===0&&it.tier<3) return id+1;
  if(it.chain===1&&it.tier<2) return id+1;
  return -1;
}

const GRID=6;
var cellSize,gridX,gridY,W,H;
var grid=[], coins=0, level=1, totalMerges=0;
var unlockedAreas=['Main Hall'];
var customers=[], particles=[], floatingTexts=[], anims=[];
var selectedCell=null, dragCell=null, dragPos=null;
var gameTime=0, screenShake=0, showStory=null;
var hintCells=[];
var hintTimer=0;
var mergeSlideAnims=[]; // {fromR,fromC,toR,toC,t,dur,id}
var flashCells=[]; // {r,c,t}

var AREAS=[
  {name:'Main Hall',cost:0,story:"A little stray kitten found shelter under a broken caf√© awning.\nShe cleaned the dusty counter with her tiny paws\nand waited for someone who'd believe in second chances. üê±"},
  {name:'Terrace',cost:500,story:"With the terrace open, Kitty discovered a sunny spot\nwhere butterflies danced among potted flowers.\nShe'd sit there each morning, purring with contentment. ü¶ã"},
  {name:'Garden',cost:1500,story:"The garden bloomed with catnip and lavender.\nKitty befriended a shy hedgehog who visited at dusk.\nTwo small souls finding magic in simple evenings. üåø"},
  {name:'VIP Floor',cost:3000,story:"The VIP floor sparkled with fairy lights and velvet cushions.\nFrom stray to caf√© queen ‚Äî but her favorite spot?\nStill the old cardboard box where it all began. üëë"}
];

// Save (new key kc_save3 for fresh start)
function loadSave(){
  try{var s=JSON.parse(localStorage.getItem('kc_save3'));
  if(s){coins=s.c||0;level=s.l||1;unlockedAreas=s.a||['Main Hall'];totalMerges=s.m||0;}}catch(e){}
}
function save(){localStorage.setItem('kc_save3',JSON.stringify({c:coins,l:level,a:unlockedAreas,m:totalMerges}));}

function initGrid(){
  grid=[];
  for(var r=0;r<GRID;r++){grid[r]=[];for(var c=0;c<GRID;c++){
    // 60% base, 30% tier-1, 10% empty
    var rnd=Math.random();
    if(rnd<0.1) grid[r][c]=-1;
    else if(rnd<0.4) grid[r][c]=[1,5][Math.floor(Math.random()*2)]; // tier-1
    else grid[r][c]=[0,0,0,4,4][Math.floor(Math.random()*5)]; // base
  }}
  ensureMerges();
}
function randomItem(){
  var pool=[0,0,0,4,4];
  if(level>=3) pool.push(0,4);
  if(level>=5) pool.push(1,5);
  if(level>=7) pool.push(2,5);
  if(level>=9) pool.push(2,1);
  return pool[Math.floor(Math.random()*pool.length)];
}
function ensureMerges(){
  var pairs=countMergePairs();
  var safety=0;
  // Ensure at least 3 mergeable pairs for good gameplay
  while(pairs<3&&safety<50){
    var r=Math.floor(Math.random()*GRID);
    var c=Math.floor(Math.random()*(GRID-1));
    var item=randomItem();
    grid[r][c]=item; grid[r][c+1]=item;
    pairs=countMergePairs();
    safety++;
  }
  // Also try to create at least one merge chain (3 of same type nearby)
  if(safety<50){
    var chainFound=false;
    for(var r=0;r<GRID&&!chainFound;r++)for(var c=0;c<GRID-2&&!chainFound;c++){
      if(grid[r][c]>=0&&grid[r][c]===grid[r][c+1]&&grid[r][c]===grid[r][c+2]) chainFound=true;
    }
    if(!chainFound&&safety<45){
      // Place a chain of 3 base items for satisfying combo
      var cr=Math.floor(Math.random()*GRID);
      var cc=Math.floor(Math.random()*(GRID-2));
      var chainItem=randomItem();
      grid[cr][cc]=chainItem;grid[cr][cc+1]=chainItem;grid[cr][cc+2]=chainItem;
    }
  }
}
function countMergePairs(){
  var count=0;
  for(var r=0;r<GRID;r++)for(var c=0;c<GRID;c++){
    if(c<GRID-1&&grid[r][c]===grid[r][c+1]&&grid[r][c]>=0&&mergeResult(grid[r][c])>=0) count++;
    if(r<GRID-1&&grid[r][c]===grid[r+1][c]&&grid[r][c]>=0&&mergeResult(grid[r][c])>=0) count++;
  }
  return count;
}
function updateHints(){
  hintCells=[];
  for(var r=0;r<GRID;r++)for(var c=0;c<GRID;c++){
    if(grid[r][c]<0) continue;
    if(mergeResult(grid[r][c])<0) continue;
    var dirs=[[0,1],[0,-1],[1,0],[-1,0]];
    for(var d=0;d<dirs.length;d++){
      var nr=r+dirs[d][0],nc=c+dirs[d][1];
      if(nr>=0&&nr<GRID&&nc>=0&&nc<GRID&&grid[nr][nc]===grid[r][c]){
        hintCells.push({r:r,c:c}); break;
      }
    }
  }
}

// Customers
function spawnCustomer(){
  if(customers.length>=3) return;
  var orders=[];
  var numItems=Math.min(1+Math.floor(level/4),3);
  var orderPool=[1,1,2,5];
  if(level>=3) orderPool.push(2,6);
  if(level>=6) orderPool.push(3);
  for(var i=0;i<numItems;i++){
    var max=Math.min(orderPool.length,2+Math.floor(level/2));
    orders.push(orderPool[Math.floor(Math.random()*max)]);
  }
  var time=60+15*orders.length-level*1.5;
  customers.push({orders:orders,timer:Math.max(time,40),maxTimer:Math.max(time,40),slideIn:0});
}

// Resize ‚Äî grid takes 65-70% of screen height
function resize(){
  var area=document.getElementById('game-area');
  var aw=area.clientWidth, ah=area.clientHeight;
  W=Math.min(aw,480); H=ah;
  // Info strip: ~28px, customers: ~60px, progress: ~20px, then grid
  var headerH=110; // space for info+customers+progress
  var footerPad=10;
  var availH=H-headerH-footerPad;
  var availW=W-12;
  cellSize=Math.floor(Math.min(availW/GRID, availH/GRID));
  cellSize=Math.max(cellSize,56);
  cellSize=Math.min(cellSize,100);
  var gridTotalH=GRID*cellSize;
  var gridTotalW=GRID*cellSize;
  gridX=Math.floor((W-gridTotalW)/2);
  gridY=headerH+Math.floor((availH-gridTotalH)/2);
  if(gridY<headerH) gridY=headerH;
  canvas.style.width=W+'px'; canvas.style.height=H+'px';
  canvas.width=W*dpr; canvas.height=H*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

// Drawing
function drawBg(){
  var g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#FFF8E7'); g.addColorStop(1,'#FFE8B8');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
}

function drawInfo(){
  // Compact single-line info strip: üê± Area | ü™ô coins | Lv.X | ‚ùì
  var y=18;
  ctx.fillStyle='#8B6914';
  ctx.font='bold 14px sans-serif';
  ctx.textAlign='left';
  ctx.fillText('üê± '+unlockedAreas[unlockedAreas.length-1],8,y);
  ctx.textAlign='center';
  ctx.fillStyle='#DAA520';
  ctx.font='bold 16px sans-serif';
  ctx.fillText('ü™ô '+coins,W/2,y);
  ctx.textAlign='right';
  ctx.fillStyle='#8B6914';
  ctx.font='bold 14px sans-serif';
  ctx.fillText('Lv.'+level,W-40,y);
  // Help button
  ctx.font='20px sans-serif';
  ctx.fillText('‚ùì',W-10,y+2);
}

function drawCustomers(){
  var startY=30;
  var barH=56;
  if(customers.length===0){
    ctx.fillStyle='#CCC'; ctx.textAlign='center'; ctx.font='13px sans-serif';
    ctx.fillText('Waiting for customers...',W/2,startY+28);
    return;
  }
  var cw=Math.min((W-16)/customers.length-4, 160);
  var totalW=customers.length*(cw+4)-4;
  var startX=Math.floor((W-totalW)/2);
  for(var i=0;i<customers.length;i++){
    var c=customers[i];
    c.slideIn=Math.min(c.slideIn+0.08,1);
    var cx=startX+i*(cw+4);
    var slideOff=(1-c.slideIn)*-40;
    ctx.save(); ctx.translate(0,slideOff*c.slideIn<1?1:0);
    var pct=c.timer/c.maxTimer;
    // Card bg
    ctx.fillStyle=pct>0.5?'#FFF5E0':pct>0.2?'#FFE8C0':'#FFD0D0';
    roundRect(ctx,cx,startY,cw,barH,10); ctx.fill();
    ctx.strokeStyle=pct>0.2?'#C9A84C':'#FF6666'; ctx.lineWidth=1.5;
    roundRect(ctx,cx,startY,cw,barH,10); ctx.stroke();
    // Orders ‚Äî BIG emoji 28px+
    ctx.font='28px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    var orderW=c.orders.length*32;
    var ox=cx+cw/2-orderW/2+16;
    for(var j=0;j<c.orders.length;j++){
      ctx.fillText(ITEMS[c.orders[j]].emoji,ox+j*32,startY+24);
    }
    ctx.textBaseline='alphabetic';
    // Timer bar
    var barY=startY+barH-12;
    ctx.fillStyle='#E8D5A8'; roundRect(ctx,cx+4,barY,cw-8,8,4); ctx.fill();
    ctx.fillStyle=pct>0.5?'#98D8C8':pct>0.2?'#FFB347':'#FF6B6B';
    roundRect(ctx,cx+4,barY,Math.max((cw-8)*pct,0),8,4); ctx.fill();
    // Timer text
    ctx.fillStyle='#6B5010'; ctx.textAlign='right';
    ctx.font='bold 11px sans-serif';
    ctx.fillText(Math.ceil(c.timer)+'s',cx+cw-6,barY-1);
    ctx.textAlign='center';
    ctx.restore();
  }
}

function drawProgressBar(){
  var next=null;
  for(var i=0;i<AREAS.length;i++){
    if(!unlockedAreas.includes(AREAS[i].name)&&AREAS[i].cost>0){next=AREAS[i];break;}
  }
  if(!next) return;
  var y=90;
  var barW=W-40;
  var barH=14;
  var bx=20;
  var pct=Math.min(coins/next.cost,1);
  // Track
  ctx.fillStyle='#E8D5A8'; roundRect(ctx,bx,y,barW,barH,7); ctx.fill();
  // Fill
  var grad=ctx.createLinearGradient(bx,0,bx+barW,0);
  grad.addColorStop(0,'#98D8C8'); grad.addColorStop(1,'#45B7D1');
  ctx.fillStyle=grad; roundRect(ctx,bx,y,Math.max(barW*pct,barH),barH,7); ctx.fill();
  // Label
  ctx.fillStyle='#6B5010'; ctx.textAlign='center'; ctx.font='bold 11px sans-serif';
  ctx.fillText(coins+'/'+next.cost+' ‚Üí '+next.name+' üè°',W/2,y+11);
}

function drawGrid(){
  var sx=screenShake>0?(Math.random()-0.5)*screenShake*6:0;
  var sy=screenShake>0?(Math.random()-0.5)*screenShake*6:0;
  ctx.save(); ctx.translate(sx,sy);
  // Grid bg
  ctx.fillStyle='#F5E6C8';
  roundRect(ctx,gridX-6,gridY-6,GRID*cellSize+12,GRID*cellSize+12,14); ctx.fill();
  ctx.strokeStyle='#E0CFA0'; ctx.lineWidth=2;
  roundRect(ctx,gridX-6,gridY-6,GRID*cellSize+12,GRID*cellSize+12,14); ctx.stroke();

  var t=gameTime*0.003;
  for(var r=0;r<GRID;r++) for(var c=0;c<GRID;c++){
    var x=gridX+c*cellSize, y=gridY+r*cellSize;
    // Cell bg
    ctx.fillStyle=(r+c)%2===0?'#FFF5E0':'#FFEED0';
    roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();

    // Flash effect
    var flash=null;
    for(var fi=0;fi<flashCells.length;fi++){
      if(flashCells[fi].r===r&&flashCells[fi].c===c) flash=flashCells[fi];
    }
    if(flash){
      ctx.fillStyle='rgba(255,255,255,'+flash.t+')';
      roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
    }

    // Hint glow
    var isHint=false;
    for(var hi=0;hi<hintCells.length;hi++){
      if(hintCells[hi].r===r&&hintCells[hi].c===c){isHint=true;break;}
    }
    if(isHint&&!selectedCell){
      var glow=0.12+0.08*Math.sin(t+r*2+c*3);
      ctx.fillStyle='rgba(255,200,50,'+glow+')';
      roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
    }

    // Selected highlight
    if(selectedCell&&selectedCell.r===r&&selectedCell.c===c){
      ctx.strokeStyle='#FF69B4'; ctx.lineWidth=3;
      roundRect(ctx,x+1,y+1,cellSize-2,cellSize-2,9); ctx.stroke();
      ctx.fillStyle='rgba(255,105,180,0.15)';
      roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
    }
    // Valid merge target glow (green)
    if(selectedCell&&!(selectedCell.r===r&&selectedCell.c===c)){
      if(canMerge(selectedCell.r,selectedCell.c,r,c)){
        var pulse=0.25+0.15*Math.sin(t*2.5);
        ctx.fillStyle='rgba(80,200,120,'+pulse+')';
        roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,8); ctx.fill();
        ctx.strokeStyle='#50C878'; ctx.lineWidth=2;
        roundRect(ctx,x+3,y+3,cellSize-6,cellSize-6,7); ctx.stroke();
      }
    }

    // Item
    var id=grid[r][c];
    if(id>=0&&!(dragCell&&dragCell.r===r&&dragCell.c===c)){
      // Check if being slide-animated away
      var sliding=false;
      for(var si=0;si<mergeSlideAnims.length;si++){
        if(mergeSlideAnims[si].fromR===r&&mergeSlideAnims[si].fromC===c) sliding=true;
      }
      if(!sliding){
        var anim=null;
        for(var ai=0;ai<anims.length;ai++){
          if(anims[ai].r===r&&anims[ai].c===c){anim=anims[ai];break;}
        }
        var scale=1, alpha=1;
        if(anim){
          var p=anim.t/anim.dur;
          if(anim.type==='pop'){scale=0.3+0.7*easeOutBack(p); alpha=p;}
          if(anim.type==='bounce'){scale=1+0.4*Math.sin(p*Math.PI)*Math.pow(1-p,0.5);}
        }
        // Idle pulse for mergeable items
        if(isHint&&!anim&&!selectedCell){
          scale=0.97+0.03*Math.sin(t*0.8+r*1.5+c*2.3);
        }
        ctx.save(); ctx.globalAlpha=alpha;
        ctx.translate(x+cellSize/2, y+cellSize/2);
        ctx.scale(scale,scale);
        drawItem(0,0,id);
        ctx.restore();
      }
    }
  }

  // Draw sliding items
  for(var si=0;si<mergeSlideAnims.length;si++){
    var sa=mergeSlideAnims[si];
    var p=sa.t/sa.dur;
    var ep=easeOutQuad(p);
    var fx=gridX+(sa.fromC+0.5)*cellSize;
    var fy=gridY+(sa.fromR+0.5)*cellSize;
    var tx=gridX+(sa.toC+0.5)*cellSize;
    var ty=gridY+(sa.toR+0.5)*cellSize;
    var cx2=fx+(tx-fx)*ep;
    var cy2=fy+(ty-fy)*ep;
    ctx.save();
    ctx.globalAlpha=1-p*0.3;
    ctx.translate(cx2,cy2);
    drawItem(0,0,sa.id);
    ctx.restore();
  }

  // Drag item
  if(dragCell&&dragPos&&grid[dragCell.r]&&grid[dragCell.r][dragCell.c]>=0){
    ctx.globalAlpha=0.85;
    ctx.save();
    ctx.translate(dragPos.x,dragPos.y);
    var ds=1.1;
    ctx.scale(ds,ds);
    drawItem(0,0,grid[dragCell.r][dragCell.c]);
    ctx.restore();
    ctx.globalAlpha=1;
    // Highlight drop target
    var target=getCellFromPos(dragPos.x,dragPos.y);
    if(target&&canMerge(dragCell.r,dragCell.c,target.r,target.c)){
      var tx2=gridX+target.c*cellSize, ty2=gridY+target.r*cellSize;
      ctx.fillStyle='rgba(80,200,120,0.3)';
      roundRect(ctx,tx2+2,ty2+2,cellSize-4,cellSize-4,8); ctx.fill();
    }
  }
  ctx.restore();
}

function drawItem(x,y,id){
  var it=ITEMS[id];
  // Large colored circle (80% of cell)
  var radius=cellSize*0.38;
  ctx.beginPath();
  ctx.arc(x,y,radius,0,Math.PI*2);
  ctx.fillStyle=it.bg;
  ctx.fill();
  // Lighter ring
  ctx.strokeStyle='rgba(255,255,255,0.4)';
  ctx.lineWidth=2;
  ctx.stroke();
  // Shadow
  ctx.beginPath();
  ctx.arc(x,y+2,radius,0,Math.PI*2);
  ctx.fillStyle='rgba(0,0,0,0.08)';
  ctx.fill();
  // Redraw circle on top of shadow
  ctx.beginPath();
  ctx.arc(x,y,radius,0,Math.PI*2);
  ctx.fillStyle=it.bg;
  ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.3)';
  ctx.lineWidth=2;
  ctx.stroke();
  // BIG emoji centered (60% of cell)
  var emojiSize=Math.floor(cellSize*0.5);
  ctx.font=emojiSize+'px serif';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(it.emoji,x,y);
  ctx.textBaseline='alphabetic';
}

function drawParticles(){
  for(var i=0;i<particles.length;i++){
    var p=particles[i];
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    if(p.type==='confetti'){
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
      ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2);
      ctx.restore();
    }else if(p.type==='coin'){
      ctx.font='16px serif'; ctx.textAlign='center'; ctx.fillText('ü™ô',p.x,p.y);
    }else if(p.type==='emoji'){
      ctx.font=p.size+'px serif'; ctx.textAlign='center'; ctx.fillText(p.emoji,p.x,p.y);
    }else{
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
  }
}

function drawFloatingTexts(){
  for(var i=0;i<floatingTexts.length;i++){
    var ft=floatingTexts[i];
    ctx.globalAlpha=ft.life; ctx.fillStyle=ft.color;
    ctx.font='bold '+ft.size+'px sans-serif'; ctx.textAlign='center';
    ctx.fillText(ft.text,ft.x,ft.y);
    ctx.globalAlpha=1;
  }
}

function drawStory(){
  if(!showStory) return;
  ctx.fillStyle='rgba(0,0,0,0.75)'; ctx.fillRect(0,0,W,H);
  var bx=W*0.06,by=H*0.18,bw=W*0.88,bh=H*0.55;
  ctx.fillStyle='#FFF8E7'; roundRect(ctx,bx,by,bw,bh,16); ctx.fill();
  ctx.strokeStyle='#FF9AAD'; ctx.lineWidth=3;
  roundRect(ctx,bx,by,bw,bh,16); ctx.stroke();
  ctx.fillStyle='#8B6914'; ctx.textAlign='center';
  ctx.font='bold 20px sans-serif';
  ctx.fillText('üéâ '+showStory.name+' Unlocked!',W/2,by+36);
  ctx.font='14px sans-serif'; ctx.fillStyle='#6B5010';
  var lines=showStory.story.split('\n');
  for(var i=0;i<lines.length;i++) ctx.fillText(lines[i],W/2,by+60+i*22);
  var btnW=120,btnH=40,btnX=W/2-btnW/2,btnY=by+bh-55;
  ctx.fillStyle='#FF9AAD'; roundRect(ctx,btnX,btnY,btnW,btnH,20); ctx.fill();
  ctx.fillStyle='#fff'; ctx.font='bold 16px sans-serif';
  ctx.fillText('Continue ‚ñ∂',W/2,btnY+btnH/2+5);
  showStory._btnX=btnX; showStory._btnY=btnY; showStory._btnW=btnW; showStory._btnH=btnH;
}

// FX
function spawnMergeParticles(x,y,color,emoji){
  // 25+ color-matched particles
  var baseCol=color;
  for(var i=0;i<28;i++){
    var a=Math.random()*Math.PI*2, sp=2+Math.random()*4;
    var shade=lightenColor(baseCol,Math.random()*40-20);
    particles.push({x:x,y:y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-1,life:1,decay:0.018+Math.random()*0.015,size:3+Math.random()*6,color:shade,type:'circle'});
  }
  // Floating emoji rises
  particles.push({x:x,y:y,vx:0,vy:-2.5,life:1,decay:0.015,size:Math.floor(cellSize*0.5),color:color,type:'emoji',emoji:emoji});
}
function spawnConfetti(x,y){
  var cols=['#FF9AAD','#98D8C8','#FFD700','#FF6B6B','#45B7D1','#A78BFA'];
  for(var i=0;i<30;i++){
    var a=Math.random()*Math.PI*2, sp=2+Math.random()*4;
    particles.push({x:x,y:y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-3,life:1,decay:0.012,size:4+Math.random()*5,color:cols[i%cols.length],type:'confetti',rot:Math.random()*6,rotV:Math.random()*0.3-0.15});
  }
}
function spawnCoinRain(){
  for(var i=0;i<10;i++){
    (function(idx){
      setTimeout(function(){particles.push({x:Math.random()*W,y:-20,vx:0,vy:2+Math.random()*2,life:1,decay:0.006,size:16,color:'#FFD700',type:'coin'});},idx*70);
    })(i);
  }
}
function spawnFireworks(){
  for(var b=0;b<5;b++){
    (function(idx){
      setTimeout(function(){
        var fx=W*0.2+Math.random()*W*0.6, fy=H*0.1+Math.random()*H*0.3;
        var col=['#FF9AAD','#98D8C8','#FFD700','#45B7D1','#A78BFA'][idx%5];
        for(var i=0;i<30;i++){var a=Math.random()*Math.PI*2,sp=1+Math.random()*4;
          particles.push({x:fx,y:fy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,decay:0.015+Math.random()*0.01,size:2+Math.random()*3,color:col,type:'circle'});}
        if(typeof GameAudio!=='undefined') GameAudio.play('explosion');
      },idx*350);
    })(b);
  }
}
function addFloat(x,y,text,color,size){floatingTexts.push({x:x,y:y,text:text,color:color,size:size||18,life:1,vy:-1.5});}

function lightenColor(hex,amt){
  var num=parseInt(hex.replace('#',''),16);
  var r=Math.min(255,Math.max(0,((num>>16)&0xFF)+amt));
  var g=Math.min(255,Math.max(0,((num>>8)&0xFF)+amt));
  var b2=Math.min(255,Math.max(0,(num&0xFF)+amt));
  return '#'+((1<<24)+(r<<16)+(g<<8)+b2).toString(16).slice(1);
}

// Merge logic
function canMerge(r1,c1,r2,c2){
  if(r1<0||r1>=GRID||c1<0||c1>=GRID||r2<0||r2>=GRID||c2<0||c2>=GRID) return false;
  if(Math.abs(r1-r2)+Math.abs(c1-c2)!==1) return false;
  var a=grid[r1][c1], b=grid[r2][c2];
  if(a<0||b<0||a!==b) return false;
  return mergeResult(a)>=0;
}

function doMerge(r1,c1,r2,c2){
  var id=grid[r1][c1], result=mergeResult(id);
  if(result<0) return;
  // Start slide animation: source slides to target
  mergeSlideAnims.push({fromR:r1,fromC:c1,toR:r2,toC:c2,t:0,dur:0.2,id:id,result:result});
  grid[r1][c1]=-1; // remove source immediately from grid
  // Don't set result yet ‚Äî wait for slide to finish
  if(typeof GameAudio!=='undefined') GameAudio.play('merge');
}

function completeMerge(sa){
  var r2=sa.toR, c2=sa.toC, result=sa.result;
  grid[r2][c2]=result;
  totalMerges++;
  var x=gridX+(c2+0.5)*cellSize, y=gridY+(r2+0.5)*cellSize;
  // Particles burst
  spawnMergeParticles(x,y,ITEMS[result].color,ITEMS[result].emoji);
  // Bounce animation
  anims.push({type:'bounce',r:r2,c:c2,t:0,dur:0.35});
  // White flash
  flashCells.push({r:r2,c:c2,t:0.8});
  // Screen shake
  screenShake=0.5;
  // Floating emoji text
  addFloat(x,y-cellSize*0.5,ITEMS[result].emoji,'#8B6914',24);
  setTimeout(function(){fillEmpty();checkOrders();updateHints();},100);
}

function fillEmpty(){
  for(var r=0;r<GRID;r++) for(var c=0;c<GRID;c++){
    if(grid[r][c]<0){grid[r][c]=randomItem(); anims.push({type:'pop',r:r,c:c,t:0,dur:0.25});}
  }
  if(countMergePairs()<2) ensureMerges();
  // Game Over check: if board full and no merges possible after ensureMerges
  var empties=0;
  for(var r=0;r<GRID;r++) for(var c=0;c<GRID;c++) if(grid[r][c]<0) empties++;
  if(empties===0 && countMergePairs()===0) triggerGameOver();
}
var _isGameOver=false;
function triggerGameOver(){
  if(_isGameOver) return;
  _isGameOver=true;
  if(typeof GameAudio!=='undefined') GameAudio.play('lose');
  // Show Game Over overlay
  var ov=document.createElement('div');
  ov.id='gameover-overlay';
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:200000;flex-direction:column';
  ov.innerHTML='<div style="background:linear-gradient(135deg,#FFF8E7,#FFE4B5);border-radius:24px;padding:32px 24px;text-align:center;max-width:300px;box-shadow:0 10px 40px rgba(0,0,0,0.3)">'
    +'<div style="font-size:56px;margin-bottom:12px">üòø</div>'
    +'<h2 style="color:#8B6914;font-size:24px;margin-bottom:8px">Caf√© Closed!</h2>'
    +'<p style="color:#A0522D;font-size:16px;margin-bottom:8px">The board is full and no merges left.</p>'
    +'<p style="color:#DAA520;font-size:20px;font-weight:bold;margin-bottom:16px">Score: '+coins+' ü™ô | Level '+level+'</p>'
    +'<button onclick="restartKittyCafe()" style="background:linear-gradient(135deg,#FF9AAD,#FFB6C1);color:#fff;border:none;padding:14px 36px;border-radius:24px;font-size:18px;font-weight:bold;cursor:pointer;box-shadow:0 4px 12px rgba(255,154,173,0.4);touch-action:manipulation">Play Again üê±</button>'
    +'</div>';
  document.body.appendChild(ov);
}
window.restartKittyCafe=restartKittyCafe;
function restartKittyCafe(){
  _isGameOver=false;
  var ov=document.getElementById('gameover-overlay');
  if(ov) ov.remove();
  coins=0;level=1;unlockedAreas=['Main Hall'];totalMerges=0;
  customers=[];particles=[];floatingTexts=[];anims=[];mergeSlideAnims=[];
  selectedCell=null;hintCells=[];
  initGrid();save();
  if(typeof GameAudio!=='undefined') GameAudio.play('start');
}

function checkOrders(){
  var gridItems={};
  for(var r=0;r<GRID;r++) for(var c=0;c<GRID;c++){var id=grid[r][c]; if(id>=0) gridItems[id]=(gridItems[id]||0)+1;}

  for(var ci=customers.length-1;ci>=0;ci--){
    var cust=customers[ci];
    var needed={};
    for(var j=0;j<cust.orders.length;j++) needed[cust.orders[j]]=(needed[cust.orders[j]]||0)+1;
    var ok=true;
    for(var nid in needed) if((gridItems[+nid]||0)<needed[nid]){ok=false;break;}
    if(!ok) continue;

    for(var j2=0;j2<cust.orders.length;j2++){
      var oid=cust.orders[j2];
      var found=false;
      for(var r2=0;r2<GRID&&!found;r2++) for(var c2=0;c2<GRID&&!found;c2++){
        if(grid[r2][c2]===oid){grid[r2][c2]=-1; spawnMergeParticles(gridX+(c2+0.5)*cellSize,gridY+(r2+0.5)*cellSize,ITEMS[oid].color,ITEMS[oid].emoji); found=true;}
      }
    }
    var reward=15+cust.orders.length*8+level*3;
    coins+=reward;
    addFloat(W/2,gridY-20,'+'+reward+' ü™ô','#DAA520',24);
    spawnConfetti(W/2,gridY);
    spawnCoinRain();
    if(typeof GameAudio!=='undefined'){GameAudio.play('coin');setTimeout(function(){if(typeof GameAudio!=='undefined')GameAudio.play('win');},200);}
    customers.splice(ci,1);

    if(customers.length===0){
      level++;
      addFloat(W/2,H*0.5,'Level '+level+'! üéâ','#FF9AAD',28);
      if(typeof GameAudio!=='undefined') GameAudio.play('levelup');
    }
    for(var ai=0;ai<AREAS.length;ai++){
      var area=AREAS[ai];
      if(!unlockedAreas.includes(area.name)&&coins>=area.cost){
        unlockedAreas.push(area.name); showStory=area;
        spawnFireworks();
        if(typeof GameAudio!=='undefined') GameAudio.play('supernova');
      }
    }
    save(); fillEmpty();
  }
}

// Input
function getCellFromPos(px,py){
  var c=Math.floor((px-gridX)/cellSize), r=Math.floor((py-gridY)/cellSize);
  return(r>=0&&r<GRID&&c>=0&&c<GRID)?{r:r,c:c}:null;
}
function getPos(e){
  var rect=canvas.getBoundingClientRect();
  var t=e.touches?e.touches[0]||e.changedTouches[0]:e;
  return{x:(t.clientX-rect.left)*(W/rect.width),y:(t.clientY-rect.top)*(H/rect.height)};
}

var touchStartCell=null, isDragging=false, touchStartPos=null;

canvas.addEventListener('mousedown',onDown);
canvas.addEventListener('mousemove',onMove);
canvas.addEventListener('mouseup',onUp);
canvas.addEventListener('touchstart',onDown);
canvas.addEventListener('touchmove',onMove);
canvas.addEventListener('touchend',onUp);

function onDown(e){
  var pos=getPos(e);
  // Story popup
  if(showStory){
    if(showStory._btnX&&pos.x>=showStory._btnX&&pos.x<=showStory._btnX+showStory._btnW&&
       pos.y>=showStory._btnY&&pos.y<=showStory._btnY+showStory._btnH) showStory=null;
    return;
  }
  // Help button check (top-right area)
  if(pos.x>W-50&&pos.y<30){
    document.getElementById('merge-guide').style.display='flex';
    return;
  }
  var cell=getCellFromPos(pos.x,pos.y);
  if(!cell||grid[cell.r][cell.c]<0) return;
  touchStartCell=cell;
  touchStartPos=pos;
  isDragging=false;
  dragPos=pos;
  if(typeof GameAudio!=='undefined') GameAudio.play('tap');
}

function onMove(e){
  if(!touchStartCell||!touchStartPos) return;
  var pos=getPos(e);
  var dx=pos.x-touchStartPos.x, dy=pos.y-touchStartPos.y;
  if(!isDragging&&Math.sqrt(dx*dx+dy*dy)>25){
    isDragging=true;
    dragCell=touchStartCell;
  }
  if(isDragging) dragPos=pos;
}

function onUp(e){
  var pos=getPos(e);
  if(isDragging&&dragCell){
    var target=getCellFromPos(pos.x,pos.y);
    if(target&&canMerge(dragCell.r,dragCell.c,target.r,target.c)){
      doMerge(dragCell.r,dragCell.c,target.r,target.c);
      selectedCell=null;
    }
    dragCell=null; dragPos=null; touchStartCell=null; touchStartPos=null; isDragging=false;
    return;
  }
  if(touchStartCell){
    var cell=touchStartCell;
    if(selectedCell){
      if(canMerge(selectedCell.r,selectedCell.c,cell.r,cell.c)){
        doMerge(selectedCell.r,selectedCell.c,cell.r,cell.c);
        selectedCell=null;
      }else if(selectedCell.r===cell.r&&selectedCell.c===cell.c){
        selectedCell=null;
      }else{
        selectedCell=(grid[cell.r][cell.c]>=0)?cell:null;
      }
    }else{
      if(grid[cell.r][cell.c]>=0) selectedCell=cell;
    }
  }
  dragCell=null; dragPos=null; touchStartCell=null; touchStartPos=null; isDragging=false;
}

// Update
function update(dt){
  gameTime+=dt;
  // Customer timers
  for(var i=customers.length-1;i>=0;i--){
    var c=customers[i];
    if(!showStory) c.timer-=dt/1000;
    if(c.timer<=0){
      customers.splice(i,1);
      addFloat(W/2,gridY-20,'üòø Left!','#FF6B6B',18);
      if(typeof GameAudio!=='undefined') GameAudio.play('error');
      screenShake=0.4;
    }
  }
  // Spawn
  if(!showStory){
    var maxC=Math.min(1+Math.floor(level/3),3);
    if(customers.length<maxC&&Math.random()<0.008) spawnCustomer();
    if(customers.length===0) spawnCustomer();
  }
  // Slide anims
  for(var si=mergeSlideAnims.length-1;si>=0;si--){
    mergeSlideAnims[si].t+=dt/1000;
    if(mergeSlideAnims[si].t>=mergeSlideAnims[si].dur){
      completeMerge(mergeSlideAnims[si]);
      mergeSlideAnims.splice(si,1);
    }
  }
  // Flash cells
  for(var fi=flashCells.length-1;fi>=0;fi--){
    flashCells[fi].t-=dt*0.004;
    if(flashCells[fi].t<=0) flashCells.splice(fi,1);
  }
  // Particles
  for(var i2=particles.length-1;i2>=0;i2--){
    var p=particles[i2];
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=p.decay;
    if(p.rot!==undefined) p.rot+=p.rotV||0;
    if(p.life<=0) particles.splice(i2,1);
  }
  // Texts
  for(var i3=floatingTexts.length-1;i3>=0;i3--){
    var ft=floatingTexts[i3]; ft.y+=ft.vy; ft.life-=0.012;
    if(ft.life<=0) floatingTexts.splice(i3,1);
  }
  // Anims
  for(var i4=anims.length-1;i4>=0;i4--){anims[i4].t+=dt/1000; if(anims[i4].t>=anims[i4].dur) anims.splice(i4,1);}
  // Shake
  if(screenShake>0) screenShake=Math.max(0,screenShake-dt*0.003);
  // Hints
  hintTimer+=dt;
  if(hintTimer>1000){hintTimer=0; updateHints();}
}

// Main loop
var last=0;
function loop(ts){
  var dt=last?Math.min(ts-last,50):16; last=ts;
  update(dt);
  ctx.clearRect(0,0,W,H);
  drawBg(); drawInfo(); drawCustomers(); drawProgressBar(); drawGrid();
  drawParticles(); drawFloatingTexts(); drawStory();
  requestAnimationFrame(loop);
}

function easeOutBack(t){var c1=1.70158,c3=c1+1;return 1+c3*Math.pow(t-1,3)+c1*Math.pow(t-1,2);}
function easeOutQuad(t){return 1-(1-t)*(1-t);}

loadSave(); initGrid(); resize(); updateHints();
window.addEventListener('resize',resize);
spawnCustomer();
document.addEventListener('click',function _b(){if(typeof GameAudio!=='undefined') GameAudio.playBGM('kitty-cafe');document.removeEventListener('click',_b);},{once:true});
requestAnimationFrame(loop);
window._gameState={get coins(){return coins},get level(){return level},get grid(){return grid},get customers(){return customers},get unlockedAreas(){return unlockedAreas},get isGameOver(){return _isGameOver},get mergePairs(){return countMergePairs()},restart:restartKittyCafe};
})();

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}
</script>
<script src="../sound-toggle.js?v=8"></script>
</body>
</html>
