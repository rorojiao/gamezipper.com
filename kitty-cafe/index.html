<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Kitty's Caf√© - Merge & Build Cat Cafe Game | GameZipper</title>
<meta name="description" content="Adopt a stray kitty and build the cutest cat caf√©! Merge coffee beans, milk and treats to fulfill customer orders. Free cat cafe merge game ‚Äî play instantly!">
<meta name="keywords" content="cat cafe game, merge cafe, kitty restaurant, casual game, merge game, cat game, coffee game">
<meta property="og:title" content="Kitty's Caf√© - Merge & Build Cat Cafe Game">
<meta property="og:description" content="Adopt a stray kitty and run the cutest cat caf√©! Merge items, fulfill orders, unlock new areas.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://gamezipper.com/kitty-cafe/">
<link rel="canonical" href="https://gamezipper.com/kitty-cafe/">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8346383990981353" crossorigin="anonymous"></script>
<script src="/../game-audio.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI','Helvetica Neue',Arial,sans-serif;background:#FFF8E7;touch-action:none;user-select:none;-webkit-user-select:none}
canvas{display:block;touch-action:none}
#wrap{display:flex;flex-direction:column;align-items:center;height:100%;width:100%}
#topbar{width:100%;background:linear-gradient(90deg,#8B6914,#A0792A,#8B6914);color:#FFF8E7;text-align:center;padding:4px;font-size:12px;z-index:99999;text-decoration:none;display:flex;justify-content:center;align-items:center;gap:8px}
#topbar a{color:#FFD700;text-decoration:none}
#game-area{flex:1;display:flex;align-items:center;justify-content:center;width:100%;position:relative;overflow:hidden}
canvas#c{border-radius:12px;box-shadow:0 4px 20px rgba(139,105,20,0.2)}
#footer{width:100%;text-align:center;padding:6px;font-size:11px;color:#8B6914;background:#FFF0D0}
#footer a{color:#8B6914;text-decoration:underline}
#tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100000;display:flex;align-items:center;justify-content:center}
#tutorial-box{background:#FFF8E7;border-radius:20px;padding:30px 24px;max-width:340px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);border:3px solid #FF9AAD}
#tutorial-box h2{color:#8B6914;font-size:22px;margin-bottom:16px}
#tutorial-box p{color:#6B5010;font-size:15px;line-height:1.7;margin-bottom:8px}
#tutorial-box button{background:linear-gradient(135deg,#FF9AAD,#FFB6C1);color:#fff;border:none;padding:14px 36px;border-radius:30px;font-size:18px;font-weight:700;cursor:pointer;margin-top:16px;box-shadow:0 4px 12px rgba(255,154,173,0.4);touch-action:manipulation;-webkit-user-select:none}
#tutorial-box button:active{transform:scale(0.95)}
#cookie-banner{position:fixed;bottom:0;left:0;right:0;background:rgba(139,105,20,0.95);color:#FFF8E7;padding:10px 16px;font-size:12px;z-index:99998;display:flex;align-items:center;justify-content:space-between;gap:10px}
#cookie-banner button{background:#FFD700;color:#8B6914;border:none;padding:6px 16px;border-radius:12px;font-weight:700;cursor:pointer;white-space:nowrap}
</style>
</head>
<body>
<div id="wrap">
<div id="topbar"><a href="https://gamezipper.com/">üêæ ‚Üê More Games at GameZipper.com</a></div>
<div id="game-area"><canvas id="c"></canvas></div>
<div id="footer"><a href="https://gamezipper.com/">GameZipper.com</a> ‚Äî More Free Games! üê±</div>
</div>

<div id="tutorial-overlay" style="display:none">
<div id="tutorial-box">
<div style="font-size:48px;margin-bottom:8px">üê±‚òï</div>
<h2>Welcome to Kitty's Caf√©!</h2>
<p>üîÄ Drag matching items together to merge them!</p>
<p>üìã Fulfill customer orders to earn coins!</p>
<p>üè† Unlock new areas to expand your caf√©!</p>
<button id="tutorial-btn" ontouchend="closeTutorial()" onclick="closeTutorial()">Got it! üêæ</button>
</div>
</div>

<div id="cookie-banner" style="display:none">
<span>üç™ We use cookies for saving your game progress.</span>
<button onclick="document.getElementById('cookie-banner').style.display='none';localStorage.setItem('kc_cookie','1')">OK</button>
</div>

<script>
// Touch guard: only preventDefault on canvas
document.addEventListener('touchmove',function(e){if(e.target.tagName==='CANVAS')e.preventDefault()},{passive:false});
document.addEventListener('touchstart',function(e){if(e.target.tagName==='CANVAS')e.preventDefault()},{passive:false});

// Tutorial
function closeTutorial(){
  document.getElementById('tutorial-overlay').style.display='none';
  localStorage.setItem('kc_tutorial','1');
  if(typeof GameAudio!=='undefined'){GameAudio.playBGM('kitty-cafe');}
}
if(!localStorage.getItem('kc_tutorial')){
  document.getElementById('tutorial-overlay').style.display='flex';
}
if(!localStorage.getItem('kc_cookie')){
  document.getElementById('cookie-banner').style.display='flex';
}

// ===== GAME ENGINE =====
(function(){
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
const dpr=Math.min(window.devicePixelRatio||1,2);

// --- Colors ---
const COL={
  bg:'#FFF8E7',cream:'#FFF8E7',brown:'#8B6914',pink:'#FF9AAD',mint:'#98D8C8',
  darkBrown:'#6B5010',gold:'#FFD700',lightPink:'#FFE4E8',warmWhite:'#FFFDF5',
  grid:'#F5E6C8',gridLine:'#E8D5A8',orderBg:'#FFF0D0'
};

// --- Item definitions ---
// Coffee chain: 0=CoffeeBean 1=Espresso 2=Latte 3=Mocha
// Milk chain: 4=Milk 5=Cream 6=Cheesecake
// Special: 7=Cookie (non-merge, filler)
const ITEMS=[
  {name:'Coffee Bean',emoji:'‚òï',color:'#8B4513',chain:0,tier:0},
  {name:'Espresso',emoji:'‚ö°',color:'#5C2D00',chain:0,tier:1},
  {name:'Latte',emoji:'ü•õ',color:'#D4A574',chain:0,tier:2},
  {name:'Mocha',emoji:'üç´',color:'#3E1F00',chain:0,tier:3},
  {name:'Milk',emoji:'ü•õ',color:'#F0F0F0',chain:1,tier:0},
  {name:'Cream',emoji:'üç¶',color:'#FFFACD',chain:1,tier:1},
  {name:'Cheesecake',emoji:'üç∞',color:'#FFB6C1',chain:1,tier:2},
  {name:'Cookie',emoji:'üç™',color:'#D2691E',chain:2,tier:0}
];

// Merge results: merging two of same item => next tier
function mergeResult(itemId){
  const it=ITEMS[itemId];
  if(it.chain===0 && it.tier<3) return itemId+1;
  if(it.chain===1 && it.tier<2) return itemId+1;
  return -1; // can't merge further
}

// --- Game State ---
const GRID=6;
let cellSize=60;
let gridX=0,gridY=0;
let W,H;
let grid=[];// grid[r][c] = itemId or -1
let coins=0;
let level=1;
let unlockedAreas=['Main Hall'];
let customers=[];
let particles=[];
let floatingTexts=[];
let animations=[];
let catState={x:0,y:0,tailPhase:0,earPhase:0,blinkTimer:0,isBlinking:false};
let selectedCell=null;
let dragCell=null;
let dragPos=null;
let gameTime=0;
let showStory=null;
let screenShake=0;

// Area unlock thresholds
const AREAS=[
  {name:'Main Hall',cost:0,story:"Once upon a time, a little stray kitten found shelter under a broken caf√© awning.\nThe old owner had left, but the kitten stayed.\nShe cleaned the dusty counter with her tiny paws\nand waited... for someone who'd believe in second chances. üê±"},
  {name:'Terrace',cost:500,story:"With the terrace open, Kitty discovered a sunny spot\nwhere butterflies danced among potted flowers.\nShe'd sit there every morning, tail swaying gently,\nwatching the world wake up with a purr of contentment. ü¶ã"},
  {name:'Garden',cost:1500,story:"The garden bloomed with catnip and lavender.\nKitty made friends with a shy hedgehog who visited at dusk.\nTogether they'd watch fireflies, two small souls\nfinding magic in the simplest of evenings. üåø"},
  {name:'VIP Floor',cost:3000,story:"The VIP floor sparkled with fairy lights and velvet cushions.\nKitty had done it ‚Äî from stray to caf√© queen.\nBut her favorite spot? Still the old cardboard box\nby the door where her journey began. Home is where the heart purrs. üëë"}
];

// Load save
function loadSave(){
  try{
    const s=JSON.parse(localStorage.getItem('kc_save'));
    if(s){coins=s.coins||0;level=s.level||1;unlockedAreas=s.areas||['Main Hall'];}
  }catch(e){}
}
function save(){
  localStorage.setItem('kc_save',JSON.stringify({coins,level,areas:unlockedAreas}));
}

// Init grid with random items
function initGrid(){
  grid=[];
  for(let r=0;r<GRID;r++){
    grid[r]=[];
    for(let c=0;c<GRID;c++){
      grid[r][c]=randomItem();
    }
  }
}

function randomItem(){
  // Weight based on level - higher levels spawn more base items
  const pool=[0,0,0,4,4,4,7]; // coffee beans, milk, cookies
  if(level>2) pool.push(0,4);
  if(level>5) pool.push(0,4,7);
  return pool[Math.floor(Math.random()*pool.length)];
}

// Customer generation
function spawnCustomer(){
  if(customers.length>=3) return;
  const orders=[];
  const numItems=Math.min(1+Math.floor(level/3),3);
  const possibleOrders=[1,2,3,5,6]; // espresso,latte,mocha,cream,cheesecake
  for(let i=0;i<numItems;i++){
    const maxTier=Math.min(Math.floor(level/2)+1,possibleOrders.length);
    const id=possibleOrders[Math.floor(Math.random()*maxTier)];
    orders.push(id);
  }
  const timeLimit=30+20*orders.length-level*2;
  customers.push({orders,timer:Math.max(timeLimit,15),maxTimer:Math.max(timeLimit,15),x:0,slideIn:1});
}

// --- Resize ---
function resize(){
  const area=document.getElementById('game-area');
  const aw=area.clientWidth;
  const ah=area.clientHeight;
  // Layout: top section for customers+info, grid below, cat beside
  const maxGridH=ah*0.55;
  const maxGridW=aw*0.9;
  cellSize=Math.floor(Math.min(maxGridW/GRID,maxGridH/GRID));
  cellSize=Math.min(cellSize,80);
  W=Math.min(aw,500);
  H=ah;
  canvas.style.width=W+'px';
  canvas.style.height=H+'px';
  canvas.width=W*dpr;
  canvas.height=H*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  gridX=Math.floor((W-GRID*cellSize)/2);
  gridY=Math.floor(H*0.35);
  catState.x=W*0.85;
  catState.y=gridY-40;
}

// --- Drawing ---
function drawBg(){
  // Warm gradient background
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#FFF8E7');
  g.addColorStop(0.5,'#FFF0D0');
  g.addColorStop(1,'#FFE8B8');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,W,H);

  // Decorative paw prints
  ctx.globalAlpha=0.06;
  ctx.font='20px serif';
  for(let i=0;i<8;i++){
    const px=(i*73+17)%W;
    const py=(i*97+31)%H;
    ctx.fillText('üêæ',px,py);
  }
  ctx.globalAlpha=1;

  // Steam wisps
  const t=gameTime*0.001;
  ctx.strokeStyle='rgba(139,105,20,0.08)';
  ctx.lineWidth=2;
  for(let i=0;i<3;i++){
    const sx=W*0.1+i*W*0.35;
    const sy=H*0.25;
    ctx.beginPath();
    ctx.moveTo(sx,sy);
    for(let j=0;j<20;j++){
      const jy=sy-j*3;
      const jx=sx+Math.sin(t+j*0.3+i)*8;
      ctx.lineTo(jx,jy);
    }
    ctx.stroke();
  }
}

function drawInfo(){
  // Area name + level
  ctx.fillStyle=COL.brown;
  ctx.font='bold 16px sans-serif';
  ctx.textAlign='left';
  ctx.fillText('üè† '+unlockedAreas[unlockedAreas.length-1],8,28);
  ctx.textAlign='right';
  ctx.fillText('Lv.'+level,W-8,28);
  // Coins
  ctx.textAlign='center';
  ctx.fillStyle=COL.gold;
  ctx.font='bold 18px sans-serif';
  ctx.fillText('ü™ô '+coins,W/2,28);

  // Next unlock hint
  const nextArea=AREAS.find(a=>!unlockedAreas.includes(a.name)&&a.cost>0);
  if(nextArea){
    ctx.font='11px sans-serif';
    ctx.fillStyle=COL.darkBrown;
    ctx.globalAlpha=0.6;
    ctx.fillText('Next: '+nextArea.name+' ('+nextArea.cost+' coins)',W/2,44);
    ctx.globalAlpha=1;
  }
}

function drawCustomers(){
  const cy=56;
  const cw=Math.min(W/3.2,150);
  const ch=50;
  ctx.font='12px sans-serif';
  for(let i=0;i<customers.length;i++){
    const c=customers[i];
    const cx=8+i*(cw+6);
    const slideOff=(1-Math.min(c.slideIn,1))*-60;

    ctx.save();
    ctx.translate(0,slideOff);

    // Customer card
    const timerPct=c.timer/c.maxTimer;
    const cardColor=timerPct>0.5?COL.orderBg:timerPct>0.2?'#FFE0A0':'#FFD0D0';
    ctx.fillStyle=cardColor;
    roundRect(ctx,cx,cy,cw,ch,8);
    ctx.fill();
    ctx.strokeStyle=timerPct>0.2?COL.brown:'#FF6666';
    ctx.lineWidth=1.5;
    roundRect(ctx,cx,cy,cw,ch,8);
    ctx.stroke();

    // Cat face
    ctx.font='16px serif';
    ctx.fillText('üò∫',cx+12,cy+22);

    // Order items
    ctx.font='14px serif';
    let ox=cx+28;
    for(const oid of c.orders){
      const it=ITEMS[oid];
      ctx.fillText(it.emoji,ox,cy+22);
      ox+=18;
    }

    // Timer bar
    ctx.fillStyle=timerPct>0.5?COL.mint:timerPct>0.2?'#FFB347':'#FF6B6B';
    roundRect(ctx,cx+2,cy+ch-10,Math.max((cw-4)*timerPct,0),6,3);
    ctx.fill();

    // Timer text
    ctx.fillStyle=COL.darkBrown;
    ctx.font='9px sans-serif';
    ctx.textAlign='right';
    ctx.fillText(Math.ceil(c.timer)+'s',cx+cw-4,cy+ch-3);
    ctx.textAlign='center';

    ctx.restore();
  }
}

function drawGrid(){
  const shakeX=screenShake>0?(Math.random()-0.5)*screenShake*4:0;
  const shakeY=screenShake>0?(Math.random()-0.5)*screenShake*4:0;
  ctx.save();
  ctx.translate(shakeX,shakeY);

  // Grid background
  ctx.fillStyle=COL.grid;
  roundRect(ctx,gridX-4,gridY-4,GRID*cellSize+8,GRID*cellSize+8,12);
  ctx.fill();
  ctx.strokeStyle=COL.gridLine;
  ctx.lineWidth=1;
  roundRect(ctx,gridX-4,gridY-4,GRID*cellSize+8,GRID*cellSize+8,12);
  ctx.stroke();

  // Cells
  for(let r=0;r<GRID;r++){
    for(let c=0;c<GRID;c++){
      const x=gridX+c*cellSize;
      const y=gridY+r*cellSize;

      // Cell bg
      ctx.fillStyle=(r+c)%2===0?'#FFF5E0':'#FFEED0';
      roundRect(ctx,x+2,y+2,cellSize-4,cellSize-4,6);
      ctx.fill();

      // Selected highlight
      if(selectedCell&&selectedCell.r===r&&selectedCell.c===c){
        ctx.strokeStyle=COL.pink;
        ctx.lineWidth=3;
        roundRect(ctx,x+1,y+1,cellSize-2,cellSize-2,7);
        ctx.stroke();
      }

      // Item
      const itemId=grid[r][c];
      if(itemId>=0&&!(dragCell&&dragCell.r===r&&dragCell.c===c)){
        drawItem(x+cellSize/2,y+cellSize/2,itemId,cellSize*0.7);
      }
    }
  }

  // Dragging item
  if(dragCell&&dragPos){
    const itemId=grid[dragCell.r][dragCell.c];
    if(itemId>=0){
      ctx.globalAlpha=0.85;
      drawItem(dragPos.x,dragPos.y,itemId,cellSize*0.8);
      ctx.globalAlpha=1;
    }
  }

  ctx.restore();
}

function drawItem(x,y,itemId,size){
  const it=ITEMS[itemId];
  // Circle bg
  ctx.fillStyle=it.color;
  ctx.globalAlpha=0.2;
  ctx.beginPath();
  ctx.arc(x,y,size/2,0,Math.PI*2);
  ctx.fill();
  ctx.globalAlpha=1;
  // Emoji
  ctx.font=Math.floor(size*0.6)+'px serif';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(it.emoji,x,y);
  // Name below (small)
  ctx.font='bold '+(Math.floor(size*0.18))+'px sans-serif';
  ctx.fillStyle=COL.darkBrown;
  ctx.fillText(it.name,x,y+size/2-2);
  ctx.textBaseline='alphabetic';
}

function drawCat(){
  const t=gameTime*0.001;
  const cx=catState.x;
  const cy=catState.y;

  // Body
  ctx.fillStyle='#FFB366';
  ctx.beginPath();
  ctx.ellipse(cx,cy+20,18,22,0,0,Math.PI*2);
  ctx.fill();

  // Head
  ctx.fillStyle='#FFB366';
  ctx.beginPath();
  ctx.arc(cx,cy-5,16,0,Math.PI*2);
  ctx.fill();

  // Ears with twitch
  const earTwitch=Math.sin(t*2+catState.earPhase)*2;
  ctx.fillStyle='#FFB366';
  ctx.beginPath();
  ctx.moveTo(cx-12,cy-15);
  ctx.lineTo(cx-8+earTwitch,cy-30);
  ctx.lineTo(cx-2,cy-14);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(cx+12,cy-15);
  ctx.lineTo(cx+8-earTwitch,cy-30);
  ctx.lineTo(cx+2,cy-14);
  ctx.fill();

  // Inner ears
  ctx.fillStyle=COL.pink;
  ctx.beginPath();
  ctx.moveTo(cx-10,cy-16);
  ctx.lineTo(cx-7+earTwitch*0.5,cy-26);
  ctx.lineTo(cx-3,cy-15);
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(cx+10,cy-16);
  ctx.lineTo(cx+7-earTwitch*0.5,cy-26);
  ctx.lineTo(cx+3,cy-15);
  ctx.fill();

  // Eyes
  if(catState.isBlinking){
    ctx.strokeStyle='#333';
    ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(cx-7,cy-6);ctx.lineTo(cx-3,cy-4);ctx.stroke();
    ctx.beginPath();ctx.moveTo(cx+7,cy-6);ctx.lineTo(cx+3,cy-4);ctx.stroke();
  }else{
    ctx.fillStyle='#333';
    ctx.beginPath();ctx.arc(cx-6,cy-6,2.5,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cx+6,cy-6,2.5,0,Math.PI*2);ctx.fill();
    // Eye shine
    ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(cx-5,cy-7,1,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cx+7,cy-7,1,0,Math.PI*2);ctx.fill();
  }

  // Nose
  ctx.fillStyle=COL.pink;
  ctx.beginPath();
  ctx.moveTo(cx,cy-1);ctx.lineTo(cx-2,cy+1);ctx.lineTo(cx+2,cy+1);
  ctx.fill();

  // Mouth
  ctx.strokeStyle='#333';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(cx,cy+1);ctx.quadraticCurveTo(cx-4,cy+5,cx-6,cy+3);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx,cy+1);ctx.quadraticCurveTo(cx+4,cy+5,cx+6,cy+3);
  ctx.stroke();

  // Whiskers
  ctx.strokeStyle='#999';
  ctx.lineWidth=0.8;
  for(let s=-1;s<=1;s+=2){
    for(let w=0;w<3;w++){
      ctx.beginPath();
      ctx.moveTo(cx+s*8,cy-1+w*3);
      ctx.lineTo(cx+s*22,cy-4+w*4+Math.sin(t*1.5+w)*1.5);
      ctx.stroke();
    }
  }

  // Tail with wag
  const tailWag=Math.sin(t*3)*15;
  ctx.strokeStyle='#FFB366';
  ctx.lineWidth=5;
  ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(cx+14,cy+30);
  ctx.quadraticCurveTo(cx+30+tailWag,cy+15,cx+25+tailWag*0.7,cy);
  ctx.stroke();
  ctx.lineWidth=1;
  ctx.lineCap='butt';

  // Paws
  ctx.fillStyle='#FFF5E0';
  ctx.beginPath();ctx.ellipse(cx-10,cy+40,5,4,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(cx+10,cy+40,5,4,0,0,Math.PI*2);ctx.fill();
}

function drawParticles(){
  for(const p of particles){
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    if(p.type==='confetti'){
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2);
      ctx.restore();
    }else if(p.type==='coin'){
      ctx.font='16px serif';
      ctx.textAlign='center';
      ctx.fillText('ü™ô',p.x,p.y);
    }else if(p.type==='firework'){
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);
      ctx.fill();
    }else{
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;
  }
}

function drawFloatingTexts(){
  for(const ft of floatingTexts){
    ctx.globalAlpha=ft.life;
    ctx.fillStyle=ft.color;
    ctx.font='bold '+ft.size+'px sans-serif';
    ctx.textAlign='center';
    ctx.fillText(ft.text,ft.x,ft.y);
    ctx.globalAlpha=1;
  }
}

function drawStory(){
  if(!showStory) return;
  ctx.fillStyle='rgba(0,0,0,0.75)';
  ctx.fillRect(0,0,W,H);

  const bx=W*0.08,by=H*0.15,bw=W*0.84,bh=H*0.65;
  ctx.fillStyle=COL.cream;
  roundRect(ctx,bx,by,bw,bh,16);
  ctx.fill();
  ctx.strokeStyle=COL.pink;
  ctx.lineWidth=3;
  roundRect(ctx,bx,by,bw,bh,16);
  ctx.stroke();

  ctx.fillStyle=COL.brown;
  ctx.font='bold 20px sans-serif';
  ctx.textAlign='center';
  ctx.fillText('üéâ '+showStory.name+' Unlocked!',W/2,by+40);

  ctx.font='14px sans-serif';
  ctx.fillStyle=COL.darkBrown;
  const lines=showStory.story.split('\n');
  for(let i=0;i<lines.length;i++){
    ctx.fillText(lines[i],W/2,by+75+i*22);
  }

  ctx.fillStyle=COL.pink;
  roundRect(ctx,W/2-50,by+bh-50,100,36,18);
  ctx.fill();
  ctx.fillStyle='#fff';
  ctx.font='bold 14px sans-serif';
  ctx.fillText('Continue',W/2,by+bh-28);

  // Store button bounds for click
  showStory._btnX=W/2-50;showStory._btnY=by+bh-50;showStory._btnW=100;showStory._btnH=36;
}

// --- Particles & Effects ---
function spawnMergeParticles(x,y,color){
  for(let i=0;i<18;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=1+Math.random()*3;
    particles.push({
      x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,
      life:1,decay:0.02+Math.random()*0.02,size:3+Math.random()*4,
      color:color,type:'circle'
    });
  }
}

function spawnConfetti(x,y){
  const colors=[COL.pink,COL.mint,COL.gold,'#FF6B6B','#45B7D1','#98D8C8'];
  for(let i=0;i<25;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=2+Math.random()*4;
    particles.push({
      x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-3,
      life:1,decay:0.015,size:4+Math.random()*4,
      color:colors[Math.floor(Math.random()*colors.length)],
      type:'confetti',rot:Math.random()*Math.PI*2,rotV:Math.random()*0.3-0.15
    });
  }
}

function spawnCoinRain(){
  for(let i=0;i<8;i++){
    setTimeout(()=>{
      particles.push({
        x:Math.random()*W,y:-20,vx:0,vy:2+Math.random()*2,
        life:1,decay:0.008,size:16,color:COL.gold,type:'coin'
      });
    },i*80);
  }
}

function spawnFireworks(){
  for(let burst=0;burst<5;burst++){
    setTimeout(()=>{
      const fx=W*0.2+Math.random()*W*0.6;
      const fy=H*0.1+Math.random()*H*0.3;
      const colors=[COL.pink,COL.mint,COL.gold,'#FF6B6B','#45B7D1'];
      const col=colors[Math.floor(Math.random()*colors.length)];
      for(let i=0;i<30;i++){
        const angle=Math.random()*Math.PI*2;
        const speed=1+Math.random()*4;
        particles.push({
          x:fx,y:fy,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,
          life:1,decay:0.015+Math.random()*0.01,size:2+Math.random()*3,
          color:col,type:'firework'
        });
      }
      if(typeof GameAudio!=='undefined') GameAudio.play('explosion');
    },burst*400);
  }
}

function addFloatingText(x,y,text,color,size){
  floatingTexts.push({x,y,text,color,size:size||18,life:1,vy:-1.5});
}

// --- Merge Logic ---
function canMerge(r1,c1,r2,c2){
  if(r1<0||r1>=GRID||c1<0||c1>=GRID||r2<0||r2>=GRID||c2<0||c2>=GRID) return false;
  if(Math.abs(r1-r2)+Math.abs(c1-c2)!==1) return false;
  const a=grid[r1][c1],b=grid[r2][c2];
  if(a<0||b<0) return false;
  if(a!==b) return false;
  return mergeResult(a)>=0;
}

function doMerge(r1,c1,r2,c2){
  const itemId=grid[r1][c1];
  const result=mergeResult(itemId);
  if(result<0) return;

  const x=gridX+(c2+0.5)*cellSize;
  const y=gridY+(r2+0.5)*cellSize;

  grid[r1][c1]=-1;
  grid[r2][c2]=result;

  // VFX
  spawnMergeParticles(x,y,ITEMS[result].color);
  addFloatingText(x,y-20,ITEMS[result].name,COL.brown,14);

  // Squash & stretch animation
  animations.push({type:'squash',r:r2,c:c2,t:0,dur:0.3});

  // SFX
  if(typeof GameAudio!=='undefined') GameAudio.play('merge');

  // Fill empty
  setTimeout(()=>fillEmpty(),200);

  // Check customer orders
  checkOrders();

  screenShake=0.3;
}

function fillEmpty(){
  for(let r=0;r<GRID;r++){
    for(let c=0;c<GRID;c++){
      if(grid[r][c]<0){
        grid[r][c]=randomItem();
        animations.push({type:'pop',r,c,t:0,dur:0.2});
      }
    }
  }
}

function checkOrders(){
  // Count items on grid
  const gridItems={};
  for(let r=0;r<GRID;r++){
    for(let c=0;c<GRID;c++){
      const id=grid[r][c];
      if(id>=0) gridItems[id]=(gridItems[id]||0)+1;
    }
  }

  for(let ci=customers.length-1;ci>=0;ci--){
    const cust=customers[ci];
    let fulfilled=true;
    const needed={};
    for(const oid of cust.orders){
      needed[oid]=(needed[oid]||0)+1;
    }
    for(const [id,count] of Object.entries(needed)){
      if((gridItems[id]||0)<count){fulfilled=false;break;}
    }
    if(fulfilled){
      // Remove items from grid
      for(const oid of cust.orders){
        for(let r=0;r<GRID;r++){
          for(let c=0;c<GRID;c++){
            if(grid[r][c]===oid){
              grid[r][c]=-1;
              spawnMergeParticles(gridX+(c+0.5)*cellSize,gridY+(r+0.5)*cellSize,ITEMS[oid].color);
              break;
            }
          }
          if(!cust.orders.includes(grid[0]?.[0])) break; // quick exit
        }
      }

      // Reward
      const reward=10+cust.orders.length*5+level*2;
      coins+=reward;
      addFloatingText(W/2,120,'+'+reward+' ü™ô',COL.gold,22);
      spawnConfetti(W/2,130);
      spawnCoinRain();

      if(typeof GameAudio!=='undefined'){GameAudio.play('coin');setTimeout(()=>GameAudio.play('win'),200);}

      customers.splice(ci,1);

      // Level up check
      if(customers.length===0){
        level++;
        addFloatingText(W/2,H/2,'Level '+level+'! üéâ',COL.pink,28);
        if(typeof GameAudio!=='undefined') GameAudio.play('levelup');
      }

      // Unlock area check
      for(const area of AREAS){
        if(!unlockedAreas.includes(area.name)&&coins>=area.cost){
          unlockedAreas.push(area.name);
          showStory=area;
          spawnFireworks();
          if(typeof GameAudio!=='undefined') GameAudio.play('supernova');
        }
      }

      save();
      fillEmpty();
    }
  }
}

// --- Input ---
function getCellFromPos(px,py){
  const c=Math.floor((px-gridX)/cellSize);
  const r=Math.floor((py-gridY)/cellSize);
  if(r>=0&&r<GRID&&c>=0&&c<GRID) return {r,c};
  return null;
}

function getEventPos(e){
  const rect=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]||e.changedTouches[0]:e;
  return {x:(t.clientX-rect.left)*(W/rect.width),y:(t.clientY-rect.top)*(H/rect.height)};
}

canvas.addEventListener('mousedown',onDown);
canvas.addEventListener('mousemove',onMove);
canvas.addEventListener('mouseup',onUp);
canvas.addEventListener('touchstart',onDown);
canvas.addEventListener('touchmove',onMove);
canvas.addEventListener('touchend',onUp);

function onDown(e){
  const pos=getEventPos(e);

  // Story popup click
  if(showStory){
    if(pos.x>=showStory._btnX&&pos.x<=showStory._btnX+showStory._btnW&&
       pos.y>=showStory._btnY&&pos.y<=showStory._btnY+showStory._btnH){
      showStory=null;
    }
    return;
  }

  const cell=getCellFromPos(pos.x,pos.y);
  if(!cell) return;
  if(grid[cell.r][cell.c]<0) return;

  // Tap-tap merge mode
  if(selectedCell){
    if(canMerge(selectedCell.r,selectedCell.c,cell.r,cell.c)){
      doMerge(selectedCell.r,selectedCell.c,cell.r,cell.c);
      selectedCell=null;
      if(typeof GameAudio!=='undefined') GameAudio.play('tap');
      return;
    }
    selectedCell=null;
  }

  dragCell=cell;
  dragPos=pos;
  if(typeof GameAudio!=='undefined') GameAudio.play('tap');
}

function onMove(e){
  if(!dragCell) return;
  dragPos=getEventPos(e);
}

function onUp(e){
  if(!dragCell){
    // Tap select
    const pos=getEventPos(e);
    const cell=getCellFromPos(pos.x,pos.y);
    if(cell&&grid[cell.r][cell.c]>=0){
      selectedCell=cell;
    }
    return;
  }
  const pos=getEventPos(e);
  const target=getCellFromPos(pos.x,pos.y);
  if(target&&(target.r!==dragCell.r||target.c!==dragCell.c)){
    if(canMerge(dragCell.r,dragCell.c,target.r,target.c)){
      doMerge(dragCell.r,dragCell.c,target.r,target.c);
    }
  }
  dragCell=null;
  dragPos=null;
}

// --- Update ---
function update(dt){
  gameTime+=dt;

  // Cat animation
  catState.tailPhase+=dt*0.003;
  catState.earPhase+=dt*0.001;
  catState.blinkTimer-=dt;
  if(catState.blinkTimer<=0){
    catState.isBlinking=!catState.isBlinking;
    catState.blinkTimer=catState.isBlinking?150:2000+Math.random()*3000;
  }

  // Customer timers
  for(let i=customers.length-1;i>=0;i--){
    const c=customers[i];
    c.slideIn=Math.min(c.slideIn+dt*0.004,1);
    if(!showStory) c.timer-=dt/1000;
    if(c.timer<=0){
      customers.splice(i,1);
      addFloatingText(W/2,100,'Customer left! üòø',COL.pink,16);
      if(typeof GameAudio!=='undefined') GameAudio.play('error');
      screenShake=0.5;
    }
  }

  // Spawn customers
  if(customers.length<Math.min(1+Math.floor(level/2),3)&&!showStory){
    if(Math.random()<0.01) spawnCustomer();
  }
  if(customers.length===0&&!showStory) spawnCustomer();

  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;
    p.y+=p.vy;
    p.vy+=0.1; // gravity
    p.life-=p.decay;
    if(p.rot!==undefined) p.rot+=p.rotV||0;
    if(p.life<=0) particles.splice(i,1);
  }

  // Floating texts
  for(let i=floatingTexts.length-1;i>=0;i--){
    const ft=floatingTexts[i];
    ft.y+=ft.vy;
    ft.life-=0.015;
    if(ft.life<=0) floatingTexts.splice(i,1);
  }

  // Animations
  for(let i=animations.length-1;i>=0;i--){
    animations[i].t+=dt/1000;
    if(animations[i].t>=animations[i].dur) animations.splice(i,1);
  }

  // Screen shake decay
  if(screenShake>0) screenShake=Math.max(0,screenShake-dt*0.003);
}

// --- Main Loop ---
let lastTime=0;
function loop(ts){
  const dt=lastTime?Math.min(ts-lastTime,50):16;
  lastTime=ts;

  update(dt);

  ctx.clearRect(0,0,W,H);
  drawBg();
  drawInfo();
  drawCustomers();
  drawCat();
  drawGrid();
  drawParticles();
  drawFloatingTexts();
  drawStory();

  requestAnimationFrame(loop);
}

// --- Init ---
loadSave();
initGrid();
resize();
window.addEventListener('resize',resize);
spawnCustomer();

// Start BGM on first interaction
document.addEventListener('click',function _bgm(){
  if(typeof GameAudio!=='undefined') GameAudio.playBGM('kitty-cafe');
  document.removeEventListener('click',_bgm);
},{once:true});

requestAnimationFrame(loop);

})();

// Utility
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}
</script>
</body>
</html>
